sap.ui.define(["./BaseController","../model/formatter","sap/m/Dialog","sap/m/Button","sap/m/Text"],function(e,t,a,i,r){"use strict";return e.extend("y5jsintegv3.controller.Worklist",{formatter:t,onInit:function(){this.getRouter().getRoute("worklist").attachPatternMatched(this.PrimeiraValidacao,this);var e=window.location.href.toLowerCase();var t=e.indexOf("fiori.votorantim",0);if(t!==-1){this.ApiKey="UbEPL29xKT1p81JrAOyrEMhrVu7abJ4Z";this.LinkCpi="https://votorantim.apimanagement.br10.hana.ondemand.com:443/jsm-cpi-prd/http/js/acessorh/"}else{this.ApiKey="1fm687FHCXBGsFBU7y79NBz0EUVorpTL";this.LinkCpi="https://api-dev.apimanagement.br10.hana.ondemand.com/jsm-cpi-dev/http/js/acessorh/"}},PrimeiraValidacao:function(){var e=this.getLogonUser();if(e===undefined||e==="DEFAULT_USER"){e="fernando.cervantes@votorantim.com"}this.byId("tipoContrato").setSelectedKey("");this.byId("dataAdmissao").setValue("");this.byId("dataLimite").setValue("");this.byId("idNomeCandidato").setValue("");this.byId("idEmailCandidato").setValue("");this.byId("idCPFcandidato").setValue("");this.byId("idCelularCandidato").setValue("");this.ValidaPosicao="";this.getModel().metadataLoaded().then(function(){var t=this.getModel().createKey("ZET_COL_ESTR_ORGSet",{EmailOrg:e});this._bindView("/"+t)}.bind(this))},getLogonUser:function(){var e;var t=new sap.ushell.services.UserInfo;if(t){e=t.getUser().getEmail()}return e},defineIcon:function(){var e=jQuery.sap.getModulePath("y5js_integ_v3");var t=e+"/imagens/JS.jpg";return t},defineLoading:function(){var e=jQuery.sap.getModulePath("y5js_integ_v3");var t=e+"/imagens/voto_load.gif";return t},onchangePosicao:function(e){this.ObjectStatus0=this.byId("ObjectStatus0").getText();this.ObjectAttribute=this.byId("ObjectAttribute").getText();this.ObjectAttribute1=this.byId("ObjectAttribute1").getText();this.ObjectAttribute2=this.byId("ObjectAttribute2").getText();this.ObjectAttribute3=this.byId("ObjectAttribute3").getText();this.EmailOrg=this.byId("EmailOrg").getText();this.Bukrs=this.byId("Empresa").getText();this.Werks=this.byId("AreaRH").getText();this.Btrtl=this.byId("subAreaRH").getText();this.ValidaPosicao="X";var t=e.getParameters().value;if(!t){this.PrimeiraValidacao();sap.m.MessageBox.error("Posição obrigatoria");this.byId("idPosicao").setValueState("Error");this.byId("button").setVisible(false);return}else{this.byId("idPosicao").setValueState("None");this.byId("button").setVisible(true)}this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("ZET_BUSCA_POSICAOSet",{Plans:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this;if(this.erro!=="X"){t.byId("idimg").setVisible(true)}this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.byId("idimg").setVisible(true)},dataReceived:function(){t.byId("idimg").setVisible(false)},error:function(){t.byId("idimg").setVisible(false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){}if(this.ValidaPosicao==="X"){this.byId("ObjectStatus0").setText(this.ObjectStatus0);this.byId("ObjectAttribute").setText(this.ObjectAttribute);this.byId("ObjectAttribute1").setText(this.ObjectAttribute1);this.byId("ObjectAttribute2").setText(this.ObjectAttribute2);this.byId("ObjectAttribute3").setText(this.ObjectAttribute3);this.byId("EmailOrg").setText(this.EmailOrg);this.byId("Empresa").setText(this.Bukrs);this.byId("AreaRH").setText(this.Werks);this.byId("subAreaRH").setText(this.Btrtl)}},onChangedtAdmissao:function(e){var t=this.byId("dataAdmissao").getValue();if(t===""){this.byId("dataAdmissao").setValueState("Error");sap.m.MessageBox.error("Data de admissão obrigatório.");this.Erro="X";return}else{this.byId("dataAdmissao").setValueState("Success");this.Erro=""}var a=new Date,i=this.transformaData(t);a=a.toLocaleDateString();a=this.transformaData(a);if(a>i){this.byId("dataAdmissao").setValueState("Error");sap.m.MessageBox.error("Admissão deve possuir uma data futura.");this.Erro="X";return}else{this.byId("dataAdmissao").setValueState("Success");this.Erro="";this.dataAdmissao=i}},onChangedtLimite:function(e){var t=this.byId("dataLimite").getValue();if(t===""){this.byId("dataLimite").setValueState("Error");sap.m.MessageBox.error("Data de limite obrigatório.");this.Erro="X";return}else{this.byId("dataLimite").setValueState("Success");this.Erro=""}var a=new Date,i=this.transformaData(t);a=a.toLocaleDateString();a=this.transformaData(a);if(a>i){this.byId("dataLimite").setValueState("Error");sap.m.MessageBox.error("Data limite deve possuir uma data futura.");this.Erro="X";return}else{this.byId("dataLimite").setValueState("Success");this.Erro=""}if(i>this.dataAdmissao){this.byId("dataLimite").setValueState("Error");this.byId("dataAdmissao").setValueState("Error");sap.m.MessageBox.error("Data limite para o cadastro deve ser inferior a Data de Admissão.");this.Erro="X";return}else{this.byId("dataLimite").setValueState("Success");this.byId("dataAdmissao").setValueState("Success");this.Erro=""}},transformaData:function(e){var t;if(e.indexOf(".")!==-1){t=e.split(".")}else if(e.indexOf("/")!==-1){t=e.split("/")}var a=t[0];var i=t[1];var r=t[2];var s=r+i+a;return s},transformaDataZZ:function(e){var t;if(e.indexOf(".")!==-1){t=e.split(".")}else if(e.indexOf("/")!==-1){t=e.split("/")}var a=t[0];var i=t[1];var r=t[2];var s=r+"-"+i+"-"+a+"T00:00:00Z";return s},onChangeNomeCandidato:function(e){var t=this.byId("idNomeCandidato").getValue();var a;if(t.indexOf(" ")!==-1){a=t.split(" ");if(a[0].length<2){this.byId("idNomeCandidato").setValueState("Error");sap.m.MessageBox.error("Preencher nome completo.");this.Erro="X";return}if(a[1].length<2){this.byId("idNomeCandidato").setValueState("Error");sap.m.MessageBox.error("Preencher nome completo.");this.Erro="X";return}}else{this.byId("idNomeCandidato").setValueState("Error");sap.m.MessageBox.error("Preencher nome completo.");this.Erro="X";return}if(t.length<2){this.byId("idNomeCandidato").setValueState("Error");sap.m.MessageBox.error("Preencher nome completo.");this.Erro="X";return}if(!t){this.byId("idNomeCandidato").setValueState("Error");sap.m.MessageBox.error("Nome do candidato obrigatorio.");this.Erro="X";return}this.byId("idNomeCandidato").setValueState("Success");this.Erro=""},onChangeTelefone:function(e){var t=this.byId("idCelularCandidato").getValue();while(t.indexOf("(")!==-1){t=t.replace("(","")}while(t.indexOf(")")!==-1){t=t.replace(")","")}while(t.indexOf("_")!==-1){t=t.replace("_","")}if(t.length<11){this.byId("idCelularCandidato").setValueState("Error");sap.m.MessageBox.error("Nr. celular invalido - Informe DDD (99)9 + 8 dígitos.");this.Erro="X";return}else if(t[2]!=="9"){this.byId("idCelularCandidato").setValueState("Error");sap.m.MessageBox.error("Nr. celular invalido - Informe DDD (99)9 + 8 dígitos.");this.Erro="X";return}else{this.byId("idCelularCandidato").setValueState("Success");this.Erro=""}},onChangeEmail:function(e){var t=this.byId("idEmailCandidato").getValue();if(t.match(/@/)){this.byId("idEmailCandidato").setValueState("Success");this.Erro=""}else{this.byId("idEmailCandidato").setValueState("Error");sap.m.MessageBox.error("Email invalido.");this.Erro="X";return}},onChangeCPF:function(e){var t=this.byId("idCPFCandidato").getValue();while(t.indexOf(".")!==-1){t=t.replace(".","")}while(t.indexOf("-")!==-1){t=t.replace(".","")}while(t.indexOf("_")!==-1){t=t.replace("_","")}if(t.length<11){this.byId("idCPFCandidato").setValueState("Error");sap.m.MessageBox.error("CPF invalido.");this.Erro="X";return}else{this.byId("idCPFCandidato").setValueState("Success");this.Erro=""}},onEnviar:function(){var e=this.getModel();var t=e.oData;var s=this.byId("idPosicao").getValue();var o="ZET_BUSCA_POSICAOSet('"+s+"')";var n=this;var d="/ZET_GRAVA_POSICAOSet";var l="31/12/9999";var h=this.byId("dataAdmissao").getValue();var u=this.byId("dataLimite").getValue();var c=this.byId("EmailOrg").getText();var m=this.byId("tipoContrato").getSelectedKey();var g=this.byId("idNomeCandidato").getValue();var b=this.byId("idCPFcandidato").getValue();var f=this.byId("idEmailCandidato").getValue();var v=this.byId("idCelularCandidato").getValue();this.onChangedtAdmissao();if(this.Erro==="X"){return}this.onChangedtLimite();if(this.Erro==="X"){return}this.onChangeNomeCandidato();if(this.Erro==="X"){return}this.onChangeEmail();if(this.Erro==="X"){return}this.onChangeTelefone();if(this.Erro==="X"){return}var C={SolBukrs:t[o].Bukrs,SolPersa:t[o].Persa,SolBtrtl:t[o].Btrtl,SolName:t[o].Cname,SolEmail:c,SolUser:"",ReqPlans:s,ReqStell:t[o].Stell,ReqBukrs:t[o].Bukrs,ReqPersa:t[o].Persa,ReqBtrtl:t[o].Btrtl,ReqCttyp:m,ReqCtedt:l,ReqPersg:t[o].Persg,ReqPersk:t[o].Persk,ReqDtadmPrev:h,ReqDtlimPreench:u,ReqCandCpf:b,ReqCandName:g,ReqCandEmail:f,ReqCandPhone:v};var y=new a({title:"Confirmação",type:"Message",content:new r({text:"Confirma o envio da posição?"}),beginButton:new i({text:"Sim",press:function(){e.create(d,C,{success:function(e,t){sap.m.MessageBox.success("Posição enviada com sucesso!",{actions:["OK"],onClose:function(t){n.ExecutaEnviaCargos();n.ExecutaContrataCandidato(e.IntId);n.PrimeiraValidacao()}})},error:function(e){var t=e;t=t.responseText;var a=JSON.parse(t);var i=a.error.message.value;sap.m.MessageBox.error(i,{actions:["OK"],onClose:function(e){}});return}});y.close()}}),endButton:new i({text:"Não",press:function(){y.close()}}),afterClose:function(){y.destroy()}});y.open()},ExecutaEnviaCargos:function(){var e=this.getModel();var t=e.oData;var a=this.byId("idPosicao").getValue();var i="ZET_BUSCA_POSICAOSet('"+a+"')";var r=this.LinkCpi+"envioCargos";var s={APIKey:"1fm687FHCXBGsFBU7y79NBz0EUVorpTL"};var o=this.byId("dataAdmissao").getValue();o=this.transformaDataZZ(o);var n={ROOT:{Positions:{Empresa:t[i].Bukrs,Codigo:t[i].Plans,inicioVigencia:o,nomeCargo:t[i].Descc,CBO:t[i].Cbo,centroCusto:t[i].Kostl,centroCustoDesc:t[i].Ltext,valorMaxFaixa:0,valorMinFaixa:0,grupoSalarial:t[i].Persg,posicaoGestor:t[i].Pernr,inicioVigenciaGestor:"",unidadeOrg:t[i].Orgeh,unidadeOrgDesc:t[i].Orgtx,grupoEmpregado:t[i].Persg,grupoEmpregadoDesc:t[i].Descgre}}};var d=this.OBJtoXML(n);var l;var h=new XMLHttpRequest;h.open("POST",r,true);h.setRequestHeader("Content-Type","application/json");h.send(d);h.onreadystatechange=function(){l=h.status;if(l===200){}else{sap.m.MessageBox.error("Erro de comunicação API - > envioCargos")}}},ExecutaContrataCandidato:function(e){var t=this.getModel();var a=t.oData;var i=this.byId("idPosicao").getValue();var r="ZET_BUSCA_POSICAOSet('"+i+"')";var s=new Date;var o=this.LinkCpi+"envioPosicoes";var n={APIKey:"1fm687FHCXBGsFBU7y79NBz0EUVorpTL"};var d=this.byId("dataAdmissao").getValue();d=this.transformaDataZZ(d);var l=s.getDate();var h=s.getMonth();var u=s.getFullYear();var c=this.byId("idCelularCandidato").getValue();var m=this.byId("idCPFcandidato").getValue();if(l<10){l="0"+l}h=h+1;if(h<10){h="0"+h}s=u+"-"+h+"-"+l+"T00:00:00Z";while(c.indexOf("(")!==-1){c=c.replace("(","")}while(c.indexOf(")")!==-1){c=c.replace(")","")}while(c.indexOf("_")!==-1){c=c.replace("_","")}while(m.indexOf(".")!==-1){m=m.replace(".","")}while(m.indexOf("-")!==-1){m=m.replace("-","")}var g=a[r].Persa+"-"+a[r].Btrtl;var b={ROOT:{Empregados:{Empresa:a[r].Bukrs,DataRequisicao:s,Departamento:a[r].Orgeh,DepartamentoDesc:a[r].Orgtx,Cargo:a[r].Plans,DataContratacao:d,Nome:this.byId("idNomeCandidato").getValue(),CPF:m,Email:this.byId("idEmailCandidato").getValue().trim(),Telefone:c,externalCode:e,arearh:g,DadosUnico:{tipoContrato:this.byId("tipoContrato").getSelectedKey()}}}};var f=this.OBJtoXML(b);var v;var C=new XMLHttpRequest;C.open("POST",o,true);C.send(f);C.onreadystatechange=function(){v=C.status;if(v===200){}else{sap.m.MessageBox.error("Erro de comunicação API - > envioPosicoes")}}},ConvertDateTime:function(e){var t;if(e.indexOf(".")!==-1){t=e.split(".")}else if(e.indexOf("/")!==-1){t=e.split("/")}var a=t[0];var i=t[1];var r=t[2];var s=r+"-"+i+"-"+a;var o=new Date(s);return o},OBJtoXML:function(e){var t="";for(var a in e){t+=e[a]instanceof Array?"":"<"+a+">";if(e[a]instanceof Array){for(var i in e[a]){t+="<"+a+">";t+=this.OBJtoXML(new Object(e[a][i]));t+="</"+a+">"}}else if(typeof e[a]==="object"){t+=this.OBJtoXML(new Object(e[a]))}else{t+=e[a]}t+=e[a]instanceof Array?"":"</"+a+">"}var t=t.replace(/<\/?[0-9]{1,}>/g,"");return t}})});