sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","../model/formatter","sap/ui/comp/valuehelpdialog/ValueHelpDialog","sap/m/MessageBox","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,i,a,s,o,n,r,l,d,u){"use strict";var c=null;var g={Profile:"",Instance:"",NoAtual:""};this._noAtual=null;this._iconStatus=null;this._iconAnexo=null;var h="ToPlanos,ToPlanoSelecionado,ToPeriodos,ToHierarquiaPastas,ToTop5TarefasAtrasadas,ToFluxosGerais";var f="ToPeriodos,ToPlanoSelecionado,ToHierarquiaPastas,ToTop5TarefasAtrasadas";var p="ToPeriodos,ToPlanoSelecionado,ToHierarquiaPastas,ToTop5TarefasAtrasadas,ToFluxosGerais";var m="ToPlanos,ToPlanoSelecionado,ToPeriodos,ToHierarquiaPastas,ToTarefas";var I="ToPlanoSelecionado,ToPeriodos,ToHierarquiaPastas,ToTarefas";var v="ToPlanos,ToPlanoSelecionado,ToPeriodos,ToHierarquiaPastas,ToHierarquiaGantt";var w="ToPlanoSelecionado,ToPeriodos,ToHierarquiaPastas,ToHierarquiaGantt";this.firstValidNodeId={};return e.extend("FechamentoContabil.controller.BaseController",{formatter:i,massBatchSize:30,getRouter:function(){return this.getOwnerComponent().getRouter()},getModel:function(e){return this.getView().getModel(e)},setModel:function(e,t){return this.getView().setModel(e,t)},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},onNavBack:function(){},attachPatternMatched:function(e){var t=sap.ui.core.UIComponent.getRouterFor(this);t.getRoute(e).attachPatternMatched(this._onObjectMatched,this)},getPreselectedTasks:function(e){const t=e.getParameter("arguments");const i=window.location.href;if(t.profile){const e={profile:t.profile,instance:t.instance,tasks:t.tasks};window.history.pushState("","",i.substring(0,i.indexOf("/tasks"))+"/atv");return e}},openFilterAtividades:function(){if(!this._ofilterAtividades){l.load({id:this.getView().getId(),name:"FechamentoContabil.view.fragments.filterAtividades",controller:this}).then(function(e){this._ofilterAtividades=e;this.getView().addDependent(e);if(this._userInfo)l.byId(this.getView().getId(),"fRespExec").setValue(this._userInfo.SapUserId);else this.getUserInfo(e=>l.byId(this.getView().getId(),"fRespExec").setValue(e.SapUserId));e.open()}.bind(this))}else{this._ofilterAtividades.open()}},closeFilterAtividades:function(){if(this._ofilterAtividades){this._ofilterAtividades.close()}},getUserInfo:function(e){const t=this.getOwnerComponent();const i=t.getModel();i.read("/v2_userInfo('')",{success:e})},showUserSearchHelp:function(e){const t=e.getSource();this.createModel({cols:[{label:"Nome",template:"name",width:"40%"},{label:"E-mail",template:"email",width:"40%"},{label:"Usuário SAP",template:"user",width:"20%"}]},"columnsSearchUsers");let i;if(t.getId().indexOf("fRespExec")!==-1)i=this.onSHPressUserRespExec.bind(this);else i=this.onSHPressUserResp.bind(this);const a="/v2_help_user";const s=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectUser");const o=["email","user","name"];this.onValueHelpRequested(a,"columnsSearchUsers",s,o,i,false)},onSHPressUserRespExec:function(e){const t=this._oValueHelpDialog.getTable();const i=t.getSelectedIndex();const a=t.getContextByIndex(i).getObject();l.byId(this.getView().getId(),"fRespExec").setValue(a.user);this._oValueHelpDialog.close()},onSHPressUserResp:function(e){const t=this._oValueHelpDialog.getTable();const i=t.getSelectedIndex();const a=t.getContextByIndex(i).getObject();l.byId(this.getView().getId(),"fResp").setValue(a.user);this._oValueHelpDialog.close()},onValueHelpRequested:function(e,t,i,a,s,o){this._oBasicSearchField=new sap.m.SearchField;this._fieldsSearch=a;l.load({name:"FechamentoContabil.view.fragments.SearchHelp",controller:this}).then(function(a){this._oValueHelpDialog=a;this.getView().addDependent(this._oValueHelpDialog);var n=this._oValueHelpDialog.getFilterBar();n.setFilterBarExpanded(false);n.setBasicSearch(this._oBasicSearchField);this._oBasicSearchField.onsapenter=function(e){var t=this._oValueHelpDialog.getFilterBar();t.search()}.bind(this);this._oValueHelpDialog.setTitle(i);this._oValueHelpDialog.setSupportMultiselect(o);this._oValueHelpDialog.attachOk(s);this._oValueHelpDialog.getTableAsync().then(function(i){i.setModel(this.getModel());i.setModel(this.getModel(t),"columns");if(i.bindRows){i.bindAggregation("rows",e)}if(i.bindItems){i.bindAggregation("items",e,function(){return new ColumnListItem({cells:this.getModel("columnsSearchUsers").getProperty("/").cols.map(function(e){return new Label({text:"{"+e.template+"}"})})})}.bind(this))}this._oValueHelpDialog.update()}.bind(this));this._oValueHelpDialog.open()}.bind(this))},onFilterBarSearch:function(e){var t=this._oBasicSearchField.getValue(),i=e.getParameter("selectionSet");var a=i.reduce(function(e,t){if(t.getValue()){e.push(new d({path:t.getName(),operator:u.Contains,value1:t.getValue()}))}return e},[]);for(const e of this._fieldsSearch){a.push(new d({filters:[new d({path:e,operator:u.Contains,value1:t})],and:false}))}this._filterTable(new d({filters:a,and:true}))},_filterTable:function(e){var t=this._oValueHelpDialog;t.getTableAsync().then(function(i){if(i.bindRows){i.getBinding("rows").filter(e)}if(i.bindItems){i.getBinding("items").filter(e)}t.update()})},onValueHelpCancelPress:function(){this._oValueHelpDialog.close()},onValueHelpAfterClose:function(){this._oValueHelpDialog.destroy()},showDepartamentSearchHelp:function(e){const t=this.getView();this._departamentId=e;const i=l.byId(this.getView().getId(),"fProfile").getSelectedKey();this._departamentDialog=l.load({id:this.getView().getId(),name:"FechamentoContabil.view.fragments.DepartamentHelp",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);this.getView().byId("departamentTable").bindAggregation("rows",`/v2_departamentos(Profile='${i}',Departamento='')/toDepartamentos`);return e}.bind(this));this._departamentDialog.then(function(e){e.open()}.bind(this))},onPressApplyDepartament:function(e){const t=this.getView().byId("departamentTable");const i=t.getContextByIndex(t.getSelectedIndex()).getObject();l.byId(this.getView().getId(),"fDepartamento").setValue(i.Departamento);this.onCloseDepartamentDialog()},filterDepartament:function(e){const t=e.getParameter("query");this._oFilterDepartament=null;if(t){this._oFilterDepartament=new d([new d("Departamento",u.Contains,t)],false)}this.byId("departamentTable").getBinding().filter(this._oFilterDepartament,"Application")},onCloseDepartamentDialog:function(){if(this._departamentDialog){this._departamentDialog.then(function(e){e.close();e.destroy()}.bind(this))}this._departamentDialog=undefined},getSettings:function(e){const t=l.byId(this.getView().getId(),"fProfile").getSelectedKey();const i=l.byId(this.getView().getId(),"fInstance").getSelectedKey();this.getModel().read(`/v2_configurations(Profile='${t}',Instance=${i})`,{success:e=>{this.createModel(e,"settings");if(e.LateTasksPopup){this.getMotivosAtraso()}}})},getMotivosAtraso:function(){const e=l.byId(this.getView().getId(),"fProfile").getSelectedKey();const t=l.byId(this.getView().getId(),"fInstance").getSelectedKey();this.getModel().read(`/v2_motivo_atrasos(Profile='${e}',Instance=${t},Seq=0)/toMotivosAtrasoTarefa`,{success:e=>{this.getView().getModel("motivosAtraso").setProperty("/motivos",e.results)}})},_onObjectMatched:function(e){var t=e.getParameters();if(t.name==="monitor"){this.getDadosECC("dadosIniciais",h)}if(t.name==="Atividades"||t.name==="AtividadesMobile"){this.openFilterAtividades()}if(t.name==="AtividadesSelecionadas"){const t=new d([]);const i=this.getPreselectedTasks(e);t.aFilters.push(this.createFilter("Profile",u.EQ,i.profile));t.aFilters.push(this.createFilter("Instance",u.EQ,i.instance));if(i.tasks.indexOf(",")===-1){t.aFilters.push(this.createFilter("Item",u.EQ,i.tasks))}else{const e=i.tasks.split(",");for(const i of e){t.aFilters.push(this.createFilter("Item",u.EQ,i))}}this.byId("btnShowOtherTasks").setVisible(true);this.getDadosECC("atualizaDados",I,null,null,t.aFilters)}if(t.name==="AtividadesAtrasadas"){this.getView().byId("idAtivdAtrasadas").setPressed(true);const t=e.getParameter("arguments");g.Profile=t.profile;g.Instance=t.instance;this._atvdAtrasadas=true;this.getDadosECC("atualizaDados",m)}if(t.name==="ganttView"){this.getDadosECC("dadosIniciais",v)}},getDadosECC:function(e,t,i,a,s){var o=this.getOwnerComponent().getModel();var n;var r=t;var l=this;if(this._sync===undefined){this._sync=true}if(!i){this.getView().setBusy(true)}if(e==="dadosIniciais"){n="/DadosIniciais"}if(e==="atualizaDados"){n="/DadosIniciais(Profile='"+g.Profile.trim()+"',Instance='"+g.Instance.trim()+"',NoAtual='"+g.NoAtual.trim()+"')"}if(e==="atividadeAnexos"){n="/ETS_MONITOR_GERAL(Modelo='"+g.Profile.trim()+"',Instance='"+g.Instance.trim()+"',Hierarquia='"+g.NoAtual.trim()+"')";r="MonitorToFilenames"}if(e==="ExecutaTransacao"){n="/Dependentes(Profile='"+g.Profile.trim()+"',Instance='"+g.Instance.trim()+"',NoAtual='"+g.NoAtual.trim()+"')";r="ToDependentes"}if(r!==null)o.read(n,{filters:[s],urlParameters:{$expand:r},method:"GET",success:function(t){l.respostaECC(l,e,t,a)},error:function(){sap.m.MessageToast.show("Erro na conexão com o ECC");l.getView().setBusy(false)}});else o.read(n,{method:"GET",success:function(t){l.respostaECC(l,e,t,a)},error:function(){sap.m.MessageToast.show("Erro na conexão com o ECC")}})},respostaECC:function(e,t,i,a){switch(t){case"dadosIniciais":e.inicializaMonitor(e,i);if(this.getView().getViewName()==="FechamentoContabil.view.Atividades")this.checkFilters();break;case"atualizaDados":e.atualizaDados(e,i);if(this.getView().getViewName()==="FechamentoContabil.view.Atividades"){if(this._atvdAtrasadas){const e=new sap.ui.core.Item({key:i.ToPlanoSelecionado.Profile,text:i.ToPlanoSelecionado.Profile});this.getView().byId("idInputModelo").addItem(e);this.getView().byId("idInputModelo").setSelectedKey(i.ToPlanoSelecionado.Profile);const t=new sap.ui.core.Item({key:i.ToPlanoSelecionado.Instance,text:i.ToPlanoSelecionado.Data});this.getView().byId("idInputPeriodo").addItem(t);this.getView().byId("idInputPeriodo").setSelectedKey(i.ToPlanoSelecionado.Instance)}}break;case"atividadeAnexos":e.setFilenames(e,i.MonitorToFilenames);break;case"ExecutaTransacao":e.executaTransacao(e,i.ToDependentes.results);break}e.getView().setBusy(false);if(a){if(typeof a.success==="function"){a.success()}}},setDadosECC:function(e,t,i,a,o,n){var r=this.getOwnerComponent().getModel();var l={};var d;var u=this;if(!i){if(this._noAtual){g.NoAtual=this._noAtual}if(this._iconStatus){g.IconStatus=this._iconStatus}if(this._iconAnexo){g.iconAnexo=this._iconAnexo}}l.Profile=g.Profile;l.Instance=g.Instance;if(e==="setNovidades"){l.Novidade="X"}if(e==="setNovidades"||e==="setPersistenciaSelecao"){d="/ETS_DADOS_USUARIO(Profile='"+g.Profile.trim()+"',Instance='"+g.Instance.trim()+"',Node='"+g.NoAtual.trim()+"')";l.Node=g[2];l.Parametro=e}if(e==="setStatus"){l.Status=t.Status;l.Justificativa=t.Justificativa;l.JustificativaLonga=t.JustificativaLonga;l.Reprocessamento=t.Reprocessamento;l.TarefaAtrasada=t.TarefaAtrasada;l.CausadoPorPrecedente=t.CausadoPorPrecedente;d="/ETS_DADOS_ITEM(Profile='"+g.Profile.trim()+"',Instance='"+g.Instance.trim()+"',Item='"+g.NoAtual.trim()+"')";l.Item=g.NoAtual;l.Parametro=e;this.getView().setBusy(true)}const c=(new Date).getTime();const h={};h.groupId=c;h.changeSetId=Math.floor(Math.random()*501)+Math.floor(Math.random()*501)+Math.floor(Math.random()*501);r.setDeferredGroups([c]);r.update(d,l,{changeSetId:h.changeSetId,async:false,success:function(r,l){if(e==="setStatus"){if(l.headers.erro)if(!i){u.showPopup(decodeURIComponent(l.headers.erro))}else{if(u._msgErro){u._msgErro=u._msgErro+"\n\n"}u._msgErro=u._msgErro+"Atividade nº "+n+": "+decodeURIComponent(l.headers.erro)}else{u.updateStatus(t);if(!i){sap.m.MessageToast.show("Status atualizado com sucesso");u.closeItemsDialog(u)}else{sap.ui.core.BusyIndicator.show(0)}}}if(i){if(a>=o){sap.ui.core.BusyIndicator.show(0);u.onPressSync({success:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Atualiação em massa concluída")}});if(u._msgErro){sap.ui.core.BusyIndicator.hide();s.error(u._msgErro)}u.closeItemsDialog(u);u._aSelectedItems=[];u._aSelectedItemsProperties=[]}u.getView().setBusy(false)}else{u.getView().setBusy(false)}},error:function(e){u.getView().setBusy(false);sap.m.MessageToast.show("ERRO")}})},inicializaMonitor:function(e,t){var e=this;g.NoAtual=t.results[0].NoAtual;if(t.results[0].ToPlanos.results.length>0){e.updateModel(e,"Planos",t.results[0].ToPlanos.results);if(t.results[0].ToPlanoSelecionado.Profile){const e=new sap.ui.core.Item({key:t.results[0].ToPlanoSelecionado.Profile,text:t.results[0].ToPlanoSelecionado.Profile});this.getView().byId("idInputModelo").addItem(e);this.getView().byId("idInputModelo").setSelectedKey(t.results[0].ToPlanoSelecionado.Profile)}else this.getView().byId("idInputModelo").setSelectedIndex(0)}if(t.results[0].ToPeriodos.results.length>0){e.updateModel(e,"Periodos",t.results[0].ToPeriodos.results);if(t.results[0].ToPlanoSelecionado.Profile){this.getView().byId("idInputPeriodo").setSelectedKey(t.results[0].ToPlanoSelecionado.Instance)}else this.getView().byId("idInputPeriodo").setSelectedIndex(0)}if(t.results[0].ToPlanoSelecionado!==undefined){e.updateModel(e,"PlanoSelecionado",t.results[0].ToPlanoSelecionado);if(t.results[0].ToPlanoSelecionado.GraficoAvancoPlan){e.atualizaGraficosAvanco(t.results[0]);e.atualizaGraficoConcluidoPlanejado(t.results[0])}e.setPath(e,t.results[0].ToPlanoSelecionado)}if(t.results[0].ToHierarquiaPastas.results.length>0){var i=e.montaTree(t.results[0].ToHierarquiaPastas.results);e.setFirstValidNode(e,e.firstValidNodeId);e.updateModel(e,"HierarquiaPastas",i)}if(t.results[0].ToTop5TarefasAtrasadas.results){e.setTOP5(t.results[0].ToTop5TarefasAtrasadas)}if(t.results[0].ToFluxosGerais.results)if(t.results[0].ToFluxosGerais.results.length>0){e.setFluxoProcesso(e,t.results[0].ToFluxosGerais.results);e.setPath(e,t.results[0].ToFluxosGerais.results[0],true)}if(t.results[0].ToTarefas.results)if(t.results[0].ToTarefas.results.length>0){e.updateModel(e,"Tarefas",t.results[0].ToTarefas.results)}else e.updateModel(e,"Tarefas",[]);if(t.results[0].ToHierarquiaGantt.results)if(t.results[0].ToHierarquiaGantt.results.length>0){e.updateGantt(e,t.results[0])}},setLogo:function(e,t){if(this.getView().getViewName()==="FechamentoContabil.view.Monitor"){var i="CBA.png";if(!sap.ui.Device.system.phone){var a=$.sap.getModulePath("FechamentoContabil","/LogoEmpresas/");if(t.ToPlanoSelecionado.Empresa.charAt(0)==="B")i="votorantim-energia-logo.png";this.getView().byId("idLogo").setSrc(a+i)}}},atualizaDados:function(e,t){g.NoAtual=t.NoAtual;if(t.ToPeriodos.results)if(t.ToPeriodos.results.length>0){e.updateModel(e,"Periodos",t.ToPeriodos.results);this.getView().byId("idInputPeriodo").setSelectedIndex(0)}if(t.ToPlanoSelecionado.Caminho){e.updateModel(e,"PlanoSelecionado",t.ToPlanoSelecionado);if(t.ToPlanoSelecionado.GraficoAvancoPlan!==""){e.atualizaGraficosAvanco(t);e.atualizaGraficoConcluidoPlanejado(t)}e.setPath(e,t.ToPlanoSelecionado)}if(t.ToHierarquiaPastas.results)if(t.ToHierarquiaPastas.results.length>0){var i=e.montaTree(t.ToHierarquiaPastas.results);e.setFirstValidNode(e,e.firstValidNodeId);e.updateModel(e,"HierarquiaPastas",i)}if(t.ToTop5TarefasAtrasadas.results){e.setTOP5(t.ToTop5TarefasAtrasadas)}if(t.ToFluxosGerais.results)if(t.ToFluxosGerais.results.length>0){try{e.setFluxoProcesso(e,t.ToFluxosGerais.results);e.setPath(e,t.ToFluxosGerais.results[0],true)}catch(t){if(e._sync){e._sync=false;e.onPressSync()}}}if(t.ToTarefas.results)if(t.ToTarefas.results.length>0){if(this.getView().getViewName()==="FechamentoContabil.view.AtividadesMobile")var a=this.getView().byId("listMobile").getModel("Tarefas");else var a=this.getView().byId("idTableAtividades").getModel("Tarefas");if(a!==undefined){a.oData=t.ToTarefas.results;a.refresh(true)}else e.updateModel(e,"Tarefas",t.ToTarefas.results)}if(t.ToHierarquiaGantt.results)if(t.ToHierarquiaGantt.results.length>0){e.updateGantt(e,t)}if(this.getView().byId("idInputModelo").getItems().length===0){const e=new sap.ui.core.Item({key:t.ToPlanoSelecionado.Profile,text:t.ToPlanoSelecionado.Profile});this.getView().byId("idInputModelo").addItem(e);this.getView().byId("idInputModelo").setSelectedKey(t.ToPlanoSelecionado.Profile);const i=new sap.ui.core.Item({key:t.ToPlanoSelecionado.Instance,text:t.ToPlanoSelecionado.Data});this.getView().byId("idInputPeriodo").addItem(i);this.getView().byId("idInputPeriodo").setSelectedKey(t.ToPlanoSelecionado.Instance)}},updateModel:function(e,t,i){var a=new sap.ui.model.json.JSONModel(i);e.getView().setModel(a,t)},onNovoModelo:function(e){if(e.getSource().getSelectedItem().getText()===this.getView().getModel("PlanoSelecionado").oData.Profile)return;g.Profile=e.getSource().getSelectedItem().getText();g.Instance="";g.NoAtual="";if(this.getView().getViewName()==="FechamentoContabil.view.Monitor"||this.getView().getViewName()==="FechamentoContabil.view.MonitorMobile")this.getDadosECC("atualizaDados",p);if(this.getView().getViewName()==="FechamentoContabil.view.Atividades"||this.getView().getViewName()==="FechamentoContabil.view.AtividadesMobile")this.getDadosECC("atualizaDados",I);if(this.getView().getViewName()==="FechamentoContabil.view.Gantt")this.getDadosECC("atualizaDados",w)},onNovoPeriodo:function(e){if(e.getSource().getSelectedItem().getText()===this.getView().getModel("Periodos").oData[0].Profile)return;g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();g.NoAtual="";if(this.getView().getViewName()==="FechamentoContabil.view.Monitor"||this.getView().getViewName()==="FechamentoContabil.view.MonitorMobile")this.getDadosECC("atualizaDados",p);if(this.getView().getViewName()==="FechamentoContabil.view.Atividades"||this.getView().getViewName()==="FechamentoContabil.view.AtividadesMobile")this.getDadosECC("atualizaDados",I);if(this.getView().getViewName()==="FechamentoContabil.view.Gantt")this.getDadosECC("atualizaDados",w)},atualizaGraficosAvanco:function(e){if(e.ToPlanoSelecionado.GraficoAvanco!==""&&(this.getView().getViewName()==="FechamentoContabil.view.Monitor"||this.getView().getViewName()==="FechamentoContabil.view.MonitorMobile")){var t=parseFloat(e.ToPlanoSelecionado.GraficoAvanco);var i=parseFloat(e.ToPlanoSelecionado.GraficoAvancoPlan);this.carregaGrafico(t,"avanco");this.carregaGrafico(i,"plan")}},atualizaGraficoConcluidoPlanejado:function(e){if(this.getView().getViewName()==="FechamentoContabil.view.Monitor"||this.getView().getViewName()==="FechamentoContabil.view.MonitorMobile"){var t=this.getView().byId("idAtividadePrevPlan");t.setValue1(e.ToPlanoSelecionado.GraficoAtvdConcluida);t.setValue2(e.ToPlanoSelecionado.GraficoAtvdPrevista);t.rerender()}},montaTree:function(e){var t=[];var i={};if(e){var a;var s;for(var o=0;o<e.length;o++){var n=e[o];a={NodeID:n.NodeID,Description:n.Description,children:[]};s=n.ParentNodeID;if(s!=="null"){var r=i[n.ParentNodeID];if(r){r.children.push(a)}}else{t.push(a)}i[a.NodeID]=a}}if(this.getView().getViewName()!=="FechamentoContabil.view.Atividades"&&this.getView().getViewName()!=="FechamentoContabil.view.AtividadesMobile"){this.firstValidNodeId=this.getFirstValidNode(this,t[0],0)}return t},getFirstValidNode:function(e,t,i){if(t.children.length>1){var a={Level:i,ID:t.NodeID};return a}else if(t.children.length){return e.getFirstValidNode(e,t.children[0],i+1)}return undefined},setFirstValidNode:function(e,t){if(this.getView().getViewName()!=="FechamentoContabil.view.Atividades"&&this.getView().getViewName()!=="FechamentoContabil.view.AtividadesMobile"){if(t){g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();g.NoAtual=t.ID;e.getDadosECC("atualizaDados","ToFluxosGerais")}}},onTreeClick:function(e){var t=e.getParameters().cellControl.getItems();g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();g.NoAtual=t[1].getText();if(this.getView().getViewName()==="FechamentoContabil.view.Monitor"||this.getView().getViewName()==="FechamentoContabil.view.MonitorMobile")this.getDadosECC("atualizaDados",f);if(this.getView().getViewName()==="FechamentoContabil.view.Atividades")this.getDadosECC("atualizaDados",I);if(this.getView().getViewName()==="FechamentoContabil.view.Gantt")this.getDadosECC("atualizaDados",w)},onTreeClickFluxoGeral:function(e){var t=e.getParameters().cellControl.getItems();g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();g.NoAtual=t[1].getText();this.getDadosECC("atualizaDados","ToFluxosGerais")},setPath:function(e,t,i){var a;if(i)a=this.getView().byId("idHboxPathFluxoGeral");else a=this.getView().byId("idHboxPath");var s=a.getItems().length-1;if(s>0){do{a.removeItem(s);s--}while(s>0)}var o=t.Caminho.split("##");s=o.length-1;o.forEach(function(o){var n=new sap.m.Label;n.setText(o);let r=false;if(s>0){n.setTooltip(s.toString());if(!sap.ui.Device.system.phone)n.addStyleClass("label__path");else n.addStyleClass("label__path__mobile");r=true}else{if(!sap.ui.Device.system.phone)n.addStyleClass("label__path__sel");else n.addStyleClass("label__path__sel__mobile");if(i)n.setTooltip(t.NoPai);else n.setTooltip(g.NoAtual)}n.attachBrowserEvent("click",function(){e.onPressPath(n,i)});a.addItem(n);if(r)a.addItem(new sap.m.Label({text:"/"}));s--})},showPopup:function(e){var t=this;var i;i=new sap.m.Dialog({showHeader:false,content:new sap.m.Text({text:e}).addStyleClass("dialog__text"),beginButton:new sap.m.Button({text:"Fechar",press:function(){i.close()}.bind(t)})});t.getView().addDependent(i);i.open()},onPressPath:function(e,t){var i=e.getTooltip();var a=e.getParent();var s=a.getItems();var o=s[a.getItems().length-1];g.NoAtual=o.getTooltip()+"-"+i;g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();if(this.getView().getViewName()==="FechamentoContabil.view.Monitor")if(t)this.getDadosECC("atualizaDados","ToFluxosGerais");else this.getDadosECC("atualizaDados",f);if(this.getView().getViewName()==="FechamentoContabil.view.Atividades")this.getDadosECC("atualizaDados",I);if(this.getView().getViewName()==="FechamentoContabil.view.Gantt")this.getDadosECC("atualizaDados",w)},onPressSync:function(e){var t=this.getView().byId("idHboxPath");var i=t.getItems();g.NoAtual=i[i.length-1].getTooltip();g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();if(this.getView().getViewName()==="FechamentoContabil.view.Atividades"){const t=this.getAtividadesFilters();this.getDadosECC("atualizaDados",I,false,e,t.aFilters)}if(this.getView().getViewName()==="FechamentoContabil.view.Gantt")this.getDadosECC("atualizaDados",w,false,e);if(this.getView().getViewName()==="FechamentoContabil.view.Monitor")this.getDadosECC("atualizaDados",f,false,e)},getSelectedRowTask:function(){const e=this.getModel("Tarefas").getProperty("/");for(const t of e){if(t.NO_ATIVIDADE===this._noAtual){return t}}},getCurrentTask:function(e){let t=e.getParent();while(t.getMetadata()._sClassName!=="sap.ui.table.Row"){t=t.getParent()}return t.getBindingContext("Tarefas").getObject()},onPressOptions:function(e){const t=this.getCurrentTask(e.getSource());this._noAtual=t.NO;this._iconStatus=this.getIconStatus(e);this._iconAnexo=this.getIconAnexo(e.getSource());this._statusAtual=this.getAtividadeStatus(t.STATUS);this._respExecAtual=t.RESP_EXEC;this._empresaAtual=t.EMPRESA;g.NoAtual=t.NO;g.IconStatus=this.getIconStatus(e);g.iconAnexo=this.getIconAnexo(e.getSource());this._descAtividadeAtual=t.DESC_TAREFA;this._selectedTaskRow=t;var i=this.getView().byId("popupOptions").getDomRef();var a=e.getSource().getDomRef();var s=a.getBoundingClientRect();var o=document.querySelector("#viewPortContainer");var n=document.querySelector(".sapUShellApplicationContainerLimitedWidth");var r=(o.clientWidth-n.offsetWidth)/2;a.classList.toggle("button_selected");g.buttonOptionsSelected=a;if(s.left>0){r=s.left-r;i.style.left=r+53+"px";i.style.top=s.top-150+"px"}else{i.style.left=r+53+"px";i.style.top=s.top-150+"px"}if(t.TPTAREFA==="Lembrete"){this.getView().byId("btnExecAtvt").setEnabled(false);this.getView().byId("btnAlterarStatus").setEnabled(true)}else{this.getView().byId("btnAlterarStatus").setEnabled(false);if(g.IconStatus.getTooltip()!=="Processamento concluído sem erros"&&g.IconStatus.getTooltip()!=="Em processamento"&&g.IconStatus.getTooltip()!=="Processamento ativo")this.getView().byId("btnExecAtvt").setEnabled(true);else this.getView().byId("btnExecAtvt").setEnabled(false);if(g.IconStatus.getSrc()==="sap-icon://question-mark"||g.IconStatus.getSrc()==="sap-icon://complete")this.getView().byId("btnAlterarStatus").setEnabled(true);else this.getView().byId("btnAlterarStatus").setEnabled(false)}if(t.TPTAREFA==="Transação"&&this._selectedTaskRow.STATUS==="R"){this.getView().byId("btnAlterarStatus").setEnabled(true)}if(g.IconStatus.getTooltip()=="Processamento ativo"||g.IconStatus.getTooltip()=="Em processamento"){this.getView().byId("btnAlterarStatus").setEnabled(true)}if(this._selectedTaskRow.HasApproval)this.getView().byId("btnAprovacoes").setEnabled(true);else this.getView().byId("btnAprovacoes").setEnabled(false);if(this._selectedTaskRow.STATUS==="1")this.getView().byId("btnAlterarStatus").setEnabled(false);i.classList.toggle("popup_disable");this.getView().byId("idHboxModal").getDomRef().classList.toggle("popup_disable")},getIconStatus:function(e){let t=e.getSource().getParent();let i;t=t.getParent();const a=t.getCells();for(const e of a){if(e.getMetadata()._sClassName==="sap.ui.core.Icon"){return i=e}if(e.getMetadata()._sClassName==="sap.m.HBox"){for(const t of e.getItems()){if(t.getMetadata()._sClassName==="sap.ui.core.Icon"){return i=t}}}}},closePopups:function(){var e=document.querySelectorAll(".zpopup");e.forEach(function(e){if(!e.classList.contains("popup_disable"))e.classList.add("popup_disable")})},isConfigurationLateTasksActive:function(){return this.getView().getModel("settings").getProperty("/LateTasksPopup")},isTaskLate:function(e,t){const i=(e,t)=>new Date(Date.parse(e.substring(0,4)+"-"+e.substring(4,6)+"-"+e.substring(6,8)+"T"+t.substring(0,2)+":"+t.substring(2,4)+":"+t.substring(4,6)+".000-03:00"));const a=(e,t)=>new Date(Date.parse(e.substring(6,10)+"-"+e.substring(3,5)+"-"+e.substring(0,2)+"T"+t+".000-03:00"));let s;if(e.indexOf("/")===-1)s=i(e,t);else s=a(e,t);const o=new Date;if(o>s)return true;else return false},getLateTasks:function(){const e=[];for(const t of this._aSelectedItemsProperties){if(this.isTaskLate(t.DATA_FIM_PLAN,t.HORA_FIM_PLAN))e.push(t)}this.getModel("viewAtividades").setProperty("/popupTarefasAtrasadas",e);if(e.length===0)return false;else return true},onPressOptionsStatus:function(e,t){g.NoAtual=this._noAtual;g.IconStatus=this._iconStatus;g.iconAnexo=this._iconAnexo;this.getModel("viewAtividades").setProperty("/atividadeAtrasada",false);if(t){g.IconStatus=t[0].IconStatus;if(this._aSelectedItemsProperties[0].STATUS==="R"&&!this._aSelectedItemsProperties[0].Reproc)if(this.isConfigurationLateTasksActive())if(this.getLateTasks())this.getModel("viewAtividades").setProperty("/atividadeAtrasada",true)}else{this._aSelectedItems=undefined;this._aSelectedItemsProperties=undefined;if(this._selectedTaskRow.STATUS==="R"&&!this._selectedTaskRow.Reproc)if(this.isConfigurationLateTasksActive())if(this.isTaskLate(this._selectedTaskRow.DATA_FIM_PLAN,this._selectedTaskRow.HORA_FIM_PLAN))this.getModel("viewAtividades").setProperty("/atividadeAtrasada",true)}this.onPressFechaPopupOptions();if(this._oDialogChangeStatus)this.onChangeStatusDialogClose();l.load({id:this.getView().getId(),name:"FechamentoContabil.view.fragments.changeStatus",controller:this}).then(function(e){this.getModel("motivosAtraso").setProperty("/motivoSelecionado","");this._oDialogChangeStatus=e;this.getView().addDependent(e);if(this._aSelectedItems){l.byId(this.getView().getId(),"idTarefaStatusTitle").setVisible(false);l.byId(this.getView().getId(),"idTarefaStatus").setVisible(false)}l.byId(this.getView().getId(),"inputStatusMotivo").setValue("");l.byId(this.getView().getId(),"inputStatusMotivo").setRequired(false);l.byId(this.getView().getId(),"changeStatusTaskDesc").setText(this._descAtividadeAtual);l.byId(this.getView().getId(),"changeStatusCurrentStatus").setText(this._statusAtual);l.byId(this.getView().getId(),"changeStatusTextArea").setVisible(false);if(this._selectedTaskRow)this._changeStatusMassIcon=undefined;if(this._selectedTaskRow?.STATUS==="0"||this._changeStatusMassIcon==="sap-icon://complete"){l.byId(this.getView().getId(),"inputStatusMotivo").setRequired(true);l.byId(this.getView().getId(),"inputStatusMotivo").setPlaceholder("Motivo (texto breve)");l.byId(this.getView().getId(),"changeStatusTextArea").setVisible(true);this.byId("idTarefaStatusReproc").setVisible(true)}else{l.byId(this.getView().getId(),"inputStatusMotivo").setPlaceholder("Justificativa (opcional)")}if(this.getModel("viewAtividades").getProperty("/atividadeAtrasada")){if(this._aSelectedItems){l.byId(this.getView().getId(),"idLateTasksSectionMass").setVisible(true);this.byId("btnDisplayLateTasks").setVisible(true)}l.byId(this.getView().getId(),"inputStatusMotivo").setVisible(false);l.byId(this.getView().getId(),"changeStatusTextArea").setVisible(true)}if(g.IconStatus.getSrc()==="sap-icon://stop")this.habilitaBtnStatus(false);else if(g.IconStatus.getTooltip()==="Em processamento"||g.IconStatus.getSrc()==="sap-icon://question-mark"||g.IconStatus.getSrc()==="sap-icon://process"||g.IconStatus.getTooltip()==="Nenhuma informação de status disponível")this.habilitaBtnStatus(true);else this.habilitaBtnStatus(false);e.open()}.bind(this))},onChangeStatusDialogClose:function(){if(this._oDialogChangeStatus){this._oDialogChangeStatus.close();this._oDialogChangeStatus.destroy();this._oDialogChangeStatus=undefined}},getAtvtType:function(e){var t=e.getMetadata();var i;var a;if(t.getName()==="sap.ui.base.Event")i=e.getSource().getParent();else i=e.getParent();for(var s=0;s<6;s++){if(i.getMetadata()._sClassName==="sap.ui.table.Row")break;i=i.getParent()}if(this.getView().getViewName()==="FechamentoContabil.view.Atividades")a=6;else a=3;var o=i.getCells();var n=o[a];var r=n.getItems();return r[0].getText()},habilitaBtnStatus:function(e){var t=["idOk","idAprov","idProc"];var i;var a=this;if(e){t.forEach(function(e){i=l.byId(a.getView().getId(),e);i.setVisible(true);if(e==="idProc")i.setVisible(false);let t;if(a._selectedTaskRow)t=a._selectedTaskRow.HasApproval;if(t){if(e==="idOk")i.setVisible(false);if(e==="idAprov")i.setVisible(true)}else{if(e==="idOk")i.setVisible(true);if(e==="idAprov")i.setVisible(false)}})}else{t.forEach(function(e){i=l.byId(a.getView().getId(),e);if(e==="idOk"||e==="idAviso"||e==="idErro"||e==="idAprov")i.setVisible(false);if(e==="idProc")i.setVisible(true)})}},pressChangeStatus:function(e){var t=this;var i;var a;var o=e.getSource().getId();if(o.indexOf("idProc")!==-1)i="R";if(o.indexOf("idOk")!==-1)i="0";if(o.indexOf("idAviso")!==-1)i="2";if(o.indexOf("idErro")!==-1)i="4";if(o.indexOf("idAprov")!==-1)i="1";g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();g.value={Atividade:g.NoAtual,Status:i,Justificativa:l.byId(this.getView().getId(),"inputStatusMotivo").getValue(),JustificativaLonga:l.byId(this.getView().getId(),"changeStatusTextArea").getValue(),Reprocessamento:false,CausadoPorPrecedente:false,TarefaAtrasada:this.getModel("viewAtividades").getProperty("/atividadeAtrasada")};if(this.getModel("viewAtividades").getProperty("/atividadeAtrasada")){g.value.Justificativa=this.getModel("motivosAtraso").getProperty("/motivoSelecionado");if(!g.value.Justificativa.trim()){sap.m.MessageBox.error('Campo "Motivo" é obrigatório');return}if(!g.value.JustificativaLonga.trim()){sap.m.MessageBox.error('Campo "Detalhes do Motivo" é obrigatório');return}}if(this._selectedTaskRow)this._changeStatusMassIcon=undefined;if(o.indexOf("idProc")!==-1&&(this._selectedTaskRow?.STATUS==="0"||this._changeStatusMassIcon==="sap-icon://complete")){if(!g.value.Justificativa.trim()){sap.m.MessageBox.error('Campo "Motivo" é obrigatório');return}if(!g.value.JustificativaLonga.trim()){sap.m.MessageBox.error('Campo "Detalhes do Motivo" é obrigatório');return}s.confirm("Esta alteração de status é devido ao reprocessamento de tarefa precedente?",{actions:[s.Action.YES,s.Action.NO],onClose:function(e){if(e!=="NO")g.value.CausadoPorPrecedente=true;else g.value.CausadoPorPrecedente=false;g.value.Reprocessamento=true;if(!this._aSelectedItems){this.setDadosECC("setStatus",g.value);this._selectedTaskRow.Reproc=true}else if(!this._aSelectedItems.length){this.setDadosECC("setStatus",g.value);this._selectedTaskRow.Reproc=true}else{const e={Status:g.value.Status,Justificativa:g.value.Justificativa,JustificativaLonga:g.value.JustificativaLonga,Reprocessamento:g.value.Reprocessamento,CausadoPorPrecedente:g.value.CausadoPorPrecedente,Parametro:"setStatus",TarefaAtrasada:this.getModel("viewAtividades").getProperty("/atividadeAtrasada")};this.updateStatusECCMass(this._aSelectedItems,e)}this.onChangeStatusDialogClose()}.bind(this)})}else{if(!this._aSelectedItems){this.setDadosECC("setStatus",g.value)}else if(!this._aSelectedItems.length){this.setDadosECC("setStatus",g.value)}else{const e={Status:g.value.Status,Justificativa:g.value.Justificativa,JustificativaLonga:g.value.JustificativaLonga,Reprocessamento:g.value.Reprocessamento,CausadoPorPrecedente:g.value.CausadoPorPrecedente,Parametro:"setStatus",TarefaAtrasada:this.getModel("viewAtividades").getProperty("/atividadeAtrasada")};this.updateStatusECCMass(this._aSelectedItems,e)}this.onChangeStatusDialogClose()}},updateStatusECCMass:function(e,t){sap.ui.core.BusyIndicator.show(0);let i;let a=0;const s={groupId:"updateStatusMass",useBatch:true};const o=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",s);o.setDeferredGroups([s.groupId]);i=e.length;this.setProgress(0);this.displayDialogProgress();const n=r=>{let l=0;for(let d=r;d<e.length;d++){t.Item=e[d].NoAtual;let r={};Object.assign(r,t);if(this.getModel("viewAtividades").getProperty("/atividadeAtrasada")){if(!this.isTaskLate(this._aSelectedItemsProperties[d].DATA_FIM_PLAN,this._aSelectedItemsProperties[d].HORA_FIM_PLAN)){r.TarefaAtrasada=false;r.JustificativaLonga="";r.Justificativa=this.byId("inputStatusMotivoMass").getValue()}}const u="/ETS_DADOS_ITEM(Profile='"+g.Profile.trim()+"',Instance='"+g.Instance.trim()+"',Item='"+r.Item.trim()+"')";s.changeSetId=Math.floor(Math.random()*501)+Math.floor(Math.random()*501)+Math.floor(Math.random()*501);o.update(u,r,s);l++;a++;if(l===this.massBatchSize||a===i){this.submitChangesSync(o,"updateStatusMass").then(()=>{this.setProgress(a/i*100);if(a!==i)n(a);else{this.closeDialogProgress();this._aSelectedItems=undefined;this._aSelectedItemsProperties=undefined;this.onPressSync({success:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Atualiação em massa concluída")}})}});return}}};n(a)},submitChangesSync:async function(e,t){const i={groupId:t};e.setDeferredGroups([t]);await new Promise((a,o)=>{e.submitChanges({groupId:i.groupId,success:function(e){if(e.__batchResponses[0].response){const t=JSON.parse(e.__batchResponses[0].response.body);sap.m.MessageToast.show(t.error.message.value)}a(e)}.bind(this),error:function(e){switch(t){case"updateStatusMass":s.error("Erro ao mudar o status em massa");break;case"updateLinkMass":s.error("Erro ao atribuir Link em massa");break;case"updateAnexoMass":s.error("Erro ao atribuir Anexo em massa");break;default:break}this.closeDialogProgress();sap.ui.core.BusyIndicator.hide();this.getView().setBusy(false)}.bind(this)})})},setProgress:function(e){this.getView().getModel("viewAtividades").setProperty("/progress",e)},displayDialogProgress:function(){if(!this.oDialogProgress){this.oDialogProgress=new sap.m.Dialog({title:"Atualização em andamento",content:new sap.m.ProgressIndicator({percentValue:"{viewAtividades>/progress}",displayValue:{path:"viewAtividades>/progress",formatter:i.formatProgress}})}).addStyleClass("sapUiContentPadding")}this;this.getView().addDependent(this.oDialogProgress);this.oDialogProgress.open()},closeDialogProgress:function(){this.oDialogProgress.close()},getAtividadeGantt:function(e){var t=e.getMetadata();var i;if(t.getName()==="sap.ui.base.Event")i=e.getSource().getParent();else i=e.getParent();for(var a=0;a<6;a++){if(i.getMetadata()._sClassName==="sap.ui.table.Row")break;i=i.getParent()}var s=i.getCells();var o=s[0];if(this.getView().getViewName()==="FechamentoContabil.view.Atividades"){var n=o.getItems();return n[1].getText()}var n=o.getItems();n=n[1].getItems();return n[3].getText()},getAtividadeDesc:function(e){var t=e.getMetadata();var i;if(t.getName()==="sap.ui.base.Event")i=e.getSource().getParent();else i=e.getParent();for(var a=0;a<6;a++){if(i.getMetadata()._sClassName==="sap.ui.table.Row")break;i=i.getParent()}var s=i.getCells();var o=s[0];if(this.getView().getViewName()==="FechamentoContabil.view.Atividades"){return s[2].getText()}var n=o.getItems();n=n[1].getItems();return n[3].getText()},updateStatus:function(e){if(e.Status==="R"){g.IconStatus.setSrc("sap-icon://process");g.IconStatus.setColor("#bfbfbf");g.IconStatus.setTooltip("Em processamento");if(this._selectedTaskRow)this._selectedTaskRow.STATUS="R";if(this._aSelectedItems){for(const e of this._aSelectedItems){e.IconStatus.setSrc("sap-icon://process");e.IconStatus.setColor("#bfbfbf");e.IconStatus.setTooltip("Em processamento")}}}if(e.Status==="0"){g.IconStatus.setSrc("sap-icon://complete");g.IconStatus.setColor("#46af4f");g.IconStatus.setTooltip("Concluído sem erros");if(this._selectedTaskRow)this._selectedTaskRow.STATUS="0"}if(e.Status==="2"){g.IconStatus.setSrc("sap-icon://complete");g.IconStatus.setColor("#d2e23f");g.IconStatus.setTooltip("Concluído com avisos")}if(e.Status==="4"){g.IconStatus.setSrc("sap-icon://complete");g.IconStatus.setColor("#e2753f");g.IconStatus.setTooltip("Concluído com erros")}if(e.Status==="1"){g.IconStatus.setSrc("sap-icon://hr-approval");g.IconStatus.setColor("navy");g.IconStatus.setTooltip("Em Aprovação");if(this._selectedTaskRow)this._selectedTaskRow.STATUS="1"}},onPressTransacao:function(e){g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();this.getView().byId("popupOptions").getDomRef().classList.toggle("popup_disable");this.getDadosECC("ExecutaTransacao")},executaTransacao:function(e,t){var i=true;t.forEach(function(e){if(e.Status!=="0"&&e.Status!=="2")i=false});if(i){g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();if(window.location.href.indexOf("fioridev")!==-1||window.location.href.indexOf("brsaolsvfid01")!==-1||window.location.href.indexOf("localhost")!==-1)sap.m.URLHelper.redirect("https://wdqas.votorantim.com.br/sap/bc/gui/sap/its/webgui/its/webgui?~transaction=*ZGLFI686 p_profil="+g.Profile+";p_instan="+g.Instance+";p_item="+g.NoAtual,true);else sap.m.URLHelper.redirect("https://wdprd.votorantim.com.br/sap/bc/gui/sap/its/webgui/its/webgui?~transaction=*ZGLFI686 p_profil="+g.Profile+";p_instan="+g.Instance+";p_item="+g.NoAtual,true);this.closePopups();g.buttonOptionsSelected.classList.toggle("button_selected")}else{e.updateModel(e,"Dependentes",t);this.getView().byId("popupDependentes").getDomRef().classList.toggle("popup_disable")}},onPressTarefa:function(e){g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();if(window.location.href.indexOf("fioridev")!==-1||window.location.href.indexOf("brsaolsvfid01")!==-1||window.location.href.indexOf("localhost")!==-1)sap.m.URLHelper.redirect("https://wdqas.votorantim.com.br/sap/bc/gui/sap/its/webgui/its/webgui?~transaction=*ZGLFI677 p_chave="+g.Profile+"-"+g.Instance+"-"+g.NoAtual,true);else sap.m.URLHelper.redirect("https://wdprd.votorantim.com.br/sap/bc/gui/sap/its/webgui/its/webgui?~transaction=*ZGLFI677 p_chave="+g.Profile+"-"+g.Instance+"-"+g.NoAtual,true);this.closePopups();g.buttonOptionsSelected.classList.toggle("button_selected")},onPressFechaPopupOptions:function(){this.closePopups();if(g.buttonOptionsSelected)g.buttonOptionsSelected.classList.toggle("button_selected")},onConfigAnexo:function(e){this.openAnexoList(e)},getIconAnexo:function(e){var t=e.getMetadata();var i;var a;if(t.getName()==="sap.ui.base.Event")i=e.getSource().getParent();else i=e.getParent();for(var s=0;s<6;s++){if(i.getMetadata()._sClassName==="sap.ui.table.Row")break;i=i.getParent()}if(this.getView().getViewName()==="FechamentoContabil.view.Atividades")a=19;else a=12;var o=i.getCells();var n=o[a];var r=n.getItems();return r[0]},setFilenames:function(e,t){var i=sap.ui.getCore().byId("selectAnexoList");var a=sap.ui.getCore().byId("idVBoxAnexosFr");var s;var o;if(t.results.length>0){a.setVisible(true);t.results.forEach(function(e){var t=new sap.ui.core.ListItem;t.setKey(e.Profile.trim()+"-"+e.Instance.trim()+"-"+e.Hierarquia.trim()+"-"+e.Fileid.trim());if(e.Instance.trim()==="0"){s="⭐ ";o='Clique para baixar o arquivo "&" (Procedimento)'}else{s="🏳️ ";o='Clique para baixar o arquivo "&" (Evidência da tarefa)'}t.setTooltip(o.replace("&",e.Filename));t.setAdditionalText(`Adicionado em: ${e.CreatedOn}`);t.setText(s+e.Filename);i.addItem(t)})}else{a.setVisible(false)}},onDownloadItem:function(e){var t;var i=e.getSource().getSelectedKey().split("-");t="/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/ETS_FILE(Profile='"+i[0].trim()+"',Instance='"+i[1].trim()+"',Item='"+i[2].trim()+"',FileId='"+i[3].trim()+"')/$value";window.open(t)},onAnexarArquivo:function(){var e=sap.ui.getCore().byId("fileUploaderFr");if(e.getValue()===""){s.Error("Nenhum arquivo selecionado");return}var t=this.getView().getModel();var i=g.NoAtual;var a="/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/ETS_MONITOR_GERAL(Modelo='"+g.Profile.trim()+"',Instance='"+g.Instance.trim()+"',Hierarquia='"+i+"')/MonitorToFile";e.removeAllHeaderParameters();var o=t.oHeaders;var n=o["x-csrf-token"];var r=e.getValue();r=r.replace(/[^A-Za-z 0-9 \.,\?""!@#\$%\^&\*\(\)-_=\+;:<>\/\\\|\}\{\[\]`~]*/g,"");var l=new sap.ui.unified.FileUploaderParameter({name:"slug",value:r});e.addHeaderParameter(l);l=new sap.ui.unified.FileUploaderParameter({name:"X-CSRF-Token",value:n});e.addHeaderParameter(l);e.setSendXHR(true);e.setUploadUrl(a);this.getView().setBusy(true);e.upload()},handleUploadComplete:function(e){var t=e.getParameter("response");if(t.indexOf("ERRO")===-1){sap.m.MessageToast.show("Arquivo anexado com sucesso");var i=sap.ui.getCore().byId("selectAnexoList");i.removeAllItems();this.getDadosECC("atividadeAnexos");g.iconAnexo.setColor("blue");if(this.getView().getViewName()==="FechamentoContabil.view.Atividades")this.setValueModel_atividades(g.iconAnexo,"NO",g.NoAtual,"CONTEM_ANEXO","X");else this.setValueModel_gantt(g.iconAnexo,"NO",g.NoAtual,"CONTEM_ANEXO","X")}else{const t=e.getParameter("responseRaw");const i=new DOMParser;const a=i.parseFromString(t,"text/xml");s.error(a.getElementsByTagName("message")[0].textContent)}this.getView().setBusy(false);var a=sap.ui.getCore().byId("fileUploaderFr");a.setValue("")},setValueModel_gantt:function(e,t,i,a,s){var o=g.iconAnexo.getModel("gantt");this.setResultsModel_gantt(o.oData.root.results,t,i,a,s)},setResultsModel_gantt:function(e,t,i,a,s){var o=null;var n=this;e.forEach(function(e){if(o!==null)return o;if(e[t]===i){e[a]=s;o="ok";return o}else if(e.results!==undefined){o=n.setResultsModel_gantt(e.results,t,i,a,s)}});return o},setValueModel_atividades:function(e,t,i,a,s){var o=g.iconAnexo.getModel("Tarefas");o.oData.forEach(function(e){if(e[t]===i)e[a]=s})},checaNovidades:function(e,t){},displayNews:function(){},pressNovidades:function(e){},novidadesLoaded:function(){this.getView().setBusy(false)},pressNovidadesProximo:function(){this.getView().byId("carouselProximo").next()},onPressFeedback:function(){sap.m.URLHelper.redirect("https://docs.google.com/forms/d/e/1FAIpQLSfFpPzWBz9WLN65Fp-D0P-Y8FbPT_zwNkK3uzZe0nnmjLpbKA/viewform",true)},onAtualizaStatusMassaPress:function(e){var t=e.getSource().getIcon();var i=this.getTableItems(t);this._selectedTaskRow=undefined;this._changeStatusMassIcon=t;if(i.itens.length){for(const e of i.itens){if(e.HasApproval){s.error("Para esta operação não é permitido selecionar tarefas com workflow de aprovação");return}}this.loadItemsDialog(this,i)}},getTableItems:function(e){var t=this;var i=this.getView().byId("idTableAtividades");var a=i.getBinding("rows").aIndices;var o=i.getBinding("rows").oList;var n=[];var r=[];a.forEach(function(i,a){var s=o[i];var l=new sap.ui.core.Icon;l.setSrc(s.ICON_STATUS);l.setTooltip(s.STATUS);var d={NoAtual:s.NO_ATIVIDADE,IconStatus:l};if(s.ICON_STATUS===e){s.DATA_INICIO_PLAN=t.getCellDate(s.DATA_INICIO_PLAN);s.HORA_INICIO_PLAN=t.getCellTime(s.HORA_INICIO_PLAN);s.DATA_FIM_PLAN=t.getCellDate(s.DATA_FIM_PLAN);s.HORA_FIM_PLAN=t.getCellTime(s.HORA_FIM_PLAN);s.DATA_INICIO=t.getCellDate(s.DATA_INICIO);s.HORA_INICIO=t.getCellTime(s.HORA_INICIO);s.DATA_FIM=t.getCellDate(s.DATA_FIM);s.HORA_FIM=t.getCellTime(s.HORA_FIM);n.push(s);r.push(d)}});if(!n.length){s.error("Nenhuma atividade encontrada para o filtro escolhido")}return{itens:n,keys:r}},loadItemsDialog:function(e,t,i,o){e._aSelectedItemsProperties=[];if(!e._oDialogItems){e._oDialogItems=new a({supportMultiselect:true,Title:"Selecione as atividades e clique em OK",key:"NO_ATIVIDADE",ok:function(a){var n=[];e._aSelectedItems=[];var r=a.getParameter("tokens");r.forEach(function(i){t.keys.forEach(function(e){if(i.getKey()===e.NoAtual){n.push(e)}});t.itens.forEach(function(t){if(i.getKey()===t.NO){e._aSelectedItemsProperties.push(t)}})});if(n.length){e._aSelectedItems=n;if(i)e.onAnexoEmMassa(n);else if(o)e.onLinkEmMassa(n);else e.onPressOptionsStatus(null,n);e.closeItemsDialog(e)}else{s.error("Nenhuma atividade foi selecionada")}},cancel:function(){e.closeItemsDialog(e)}})}var n=e._oDialogItems.getTable();var r=new sap.ui.model.json.JSONModel;var l=this.getColumnList();r.setData({cols:l});var d=new sap.ui.model.json.JSONModel;d.setData({Items:t.itens});n.setModel(r,"columns");n.setModel(d);n.bindRows("/Items");e._oDialogItems.open()},closeItemsDialog:function(e){if(e._oDialogItems){e._oDialogItems.close();e._oDialogItems.destroy();e._oDialogItems=undefined}},getColumnList:function(){var e=[{label:"Núm. Atividade",template:"NO_ATIVIDADE",width:"7rem"},{label:"Status",width:"2.2rem"},{label:"Atividade",template:"DESC_TAREFA",width:"25rem"},{label:"Empresa",template:"EMPRESA",width:"5rem"},{label:"Crítico",width:"2.2rem"},{label:"Caminho",template:"PATH",width:"30rem"},{label:"Tipo Tarefa",template:"TPTAREFA",width:"7rem"},{label:"Responsável Exec",template:"RESP_EXEC",width:"8rem"},{label:"Início Plan(D)",template:"DATA_INICIO_PLAN",width:"6rem"},{label:"Inicio Plan(H)",template:"HORA_INICIO_PLAN",width:"6rem"},{label:"Fim Plan(D)",template:"DATA_FIM_PLAN",width:"6rem"},{label:"Fim Plan(H)",template:"HORA_FIM_PLAN",width:"6rem"},{label:"Duração Plan",template:"DURACAO_PLAN",width:"6rem"},{label:"Data Inicio",template:"DATA_INICIO",width:"6rem"},{label:"Hora Início",template:"HORA_INICIO",width:"6rem"},{label:"Data Fim",template:"DATA_FIM",width:"6rem"},{label:"Hora Fim",template:"HORA_FIM",width:"6rem"},{label:"Duração",template:"DURACAO",width:"6rem"},{label:"Responsável",template:"RESP",width:"8rem"}];return e},getCellDate:function(e){var t=e;if(t){if(t.indexOf("/")===-1)t=t.substr(6,2)+"/"+t.substr(4,2)+"/"+t.substr(0,4)}return t},getCellTime:function(e){var t=e;if(t){if(t.indexOf(":")===-1)t=t.substr(0,2)+":"+t.substr(2,2)+":"+t.substr(4,2)}return t},ajustaColunas:function(e){var t=e.getColumns();t[1].setTemplate(new sap.ui.core.Icon({src:"{ICON_STATUS}",tooltip:"{ICON_STATUS}",color:"{COLOR_STATUS}",hAlign:"Center"}));t[4].setTemplate(new sap.ui.core.Icon({src:"sap-icon://error",color:"orange",visible:"{= ${CRITICO} === '' ? false : true }",tooltip:"Tarefa crítica",hAlign:"Center"}))},onQuestionarViaEmailPress:function(){$("*").css("cursor","wait");sap.ui.core.BusyIndicator.show(0);this.createScreenshot()},loadEmailDialog:function(e){if(!this.oDialogEmail){this.oDialogEmail=sap.ui.xmlfragment("FechamentoContabil.view.fragments.email",this);this.oDialogEmail.setModel(this.getView().getModel());this.getView().addDependent(this.oDialogEmail);this.oDialogEmail.setContentWidth("500px");this.oDialogEmail.setContentHeight("430px");var t=sap.ui.getCore().byId("inputEmail");t.addValidator(function(e){var t=e.text;return new sap.m.Token({key:t,text:t})})}var i=sap.ui.getCore().byId("imgAnexo");var a=sap.ui.getCore().byId("imgAnexoBusy");sap.ui.core.BusyIndicator.hide();this.oDialogEmail.open();$("*").css("cursor","auto");i.setSrc(e);a.destroy(true)},onCloseDialogEmail:function(){if(this.oDialogEmail){this.oDialogEmail.close();this.oDialogEmail.destroy(true);this.oDialogEmail=undefined}},createScreenshot:function(){var e=this;var t=document.getElementById(this.createId("IdCorpoPagina"));domtoimage.toPng(t).then(function(t){e.loadEmailDialog(t)}).catch(function(t){e.loadEmailDialog("X");sap.m.MessageToast.show("O dispositivo bloqueou a captura de tela.")})},onConfirmQuestion:function(){var e;var t=sap.ui.getCore().byId("inputEmail").getTokens();var i=sap.ui.getCore().byId("txtEmailMensagem").getValue();t.forEach(function(t){e=e?e+";"+t.getKey():t.getKey()});if(!e){s.error("O campo e-mail deve ser preenchido");return}if(!i){s.error("O campo mensagem deve ser preenchido");return}this.sendEmailQuestionar(e,i)},sendEmailQuestionar:function(e,t){var i=this;this.oDialogEmail.setBusy(true);var a=this.getView().getModel();a.setUseBatch(false);var o="Fechamento Contábil - Status";var n="/Questions";var r=sap.ui.getCore().byId("imgAnexo").getSrc().trim().split(",");if(r.length===2){var l=r[1].trim()}t=t.replace(new RegExp("\r?\n","g"),"<br />");var d={Email:e,Assunto:o,Mensagem:t,Anexo:l};a.create(n,d,{async:false,success:function(e){sap.m.MessageToast.show(e.Mensagem);i.onCloseDialogEmail()},error:function(e){var t=JSON.parse(e.responseText).error.message.value;s.error(t);i.oDialogEmail.setBusy(false)}})},carregaGrafico:function(e,t){var i=t.charAt(0).toUpperCase()+t.slice(1);var a="IdGrafico"+i;var s="IdValue"+i;a=document.getElementById(this.createId(a));a.className="radio_chart "+t+" p"+e;s=document.getElementById(this.createId(s));s.innerHTML=e+"%"},getLinkRelatorio:function(){var e=this;var t=this.getView().byId("idInputModelo").getSelectedItem().getText();var i="/Hyperlinks('"+t+"')";var a=this.getView().getModel();sap.ui.core.BusyIndicator.show(0);a.read(i,{async:false,method:"GET",success:function(t){sap.ui.core.BusyIndicator.hide();var i=t.Link;if(sap.ui.Device.system.phone){window.location.href=i}else{e.popUpExterno(i)}},error:function(e){sap.ui.core.BusyIndicator.hide();var t=JSON.parse(e.responseText);s.error(t.error.message.value)}})},popUpExterno:function(e){window.open(e,"Relatório de Resultados","toolbar=no,menubar=no,resizable=no")},openAnexoList:function(e){if(!this._oDialogAnexoList){this._oDialogAnexoList=sap.ui.xmlfragment("FechamentoContabil.view.fragments.anexos",this);this.getView().addDependent(this._oDialogAnexoList);if(sap.ui.Device.system.phone){this._oDialogAnexoList.setContentWidth("100%")}else{this._oDialogAnexoList.setContentWidth("700px");this._oDialogAnexoList.setContentHeight("500px")}}if(e.getSource().getMetadata()._sClassName==="sap.ui.core.Icon"){sap.ui.getCore().byId("idUploaderAnexoFr").setVisible(false);g.iconAnexo=e.getSource()}else{sap.ui.getCore().byId("idUploaderAnexoFr").setVisible(true);if(!sap.ui.Device.system.phone){var t=sap.ui.getCore().byId("fileUploaderFr");t.setWidth("600px")}this.onPressFechaPopupOptions()}if(!sap.ui.Device.system.phone){var i=sap.ui.getCore().byId("idLegendaAnexo");var a=sap.ui.getCore().byId("notificationList");i.setWidth("600px");a.setWidth("650px")}g.Profile=this.getView().byId("idInputModelo").getSelectedItem().getText();g.Instance=this.getView().byId("idInputPeriodo").getSelectedItem().getKey();g.NoAtual=this.getAtividadeGantt(g.iconAnexo);var s=sap.ui.getCore().byId("idVBoxAnexosFr");s.setVisible(false);var o=sap.ui.getCore().byId("selectAnexoList");o.removeAllItems();this.getDadosECC("atividadeAnexos");this._oDialogAnexoList.open()},onAnexoDialogClose:function(){if(this._oDialogAnexoList){this._oDialogAnexoList.close();this._oDialogAnexoList.destroy();this._oDialogAnexoList=undefined}},openVideoList:function(){},onVideoListClose:function(e){if(this._oDialogVideoList){this._oDialogVideoList.close();this._oDialogVideoList.destroy();this._oDialogVideoList=undefined}},onVideoSearch:function(e){},onVideoListClick:function(e){},onVideoPlayerClose:function(){if(this._oDialogVideoPlayer){this._oDialogVideoPlayer.close();this._oDialogVideoPlayer.destroy();this._oDialogVideoPlayer=undefined}},onBtnLinkClick:function(e){if(!this._oDialogLinkList){this._oDialogLinkList=sap.ui.xmlfragment("FechamentoContabil.view.fragments.hyperlinks",this);this._oDialogLinkList.setModel(this.getView().getModel());this.getView().addDependent(this._oDialogLinkList);this._oDialogLinkList.setContentWidth("600px");this._oDialogLinkList.setContentHeight("300px")}this._oDialogLinkList.setBusy(true);this.onPressFechaPopupOptions();this.getLinkTarefa(e);this._oDialogLinkList.open()},onLinkListClick:function(e){var t=e.getParameter("listItem").getDescription();if(sap.ui.Device.system.phone){window.location.href=t}else{sap.m.URLHelper.redirect(t,true)}},onLinkListClose:function(e){if(this._oDialogLinkList){this._oDialogLinkList.close();this._oDialogLinkList.destroy();this._oDialogLinkList=undefined}},onAddNewLink:function(){if(!this._oDialogNewLink){this._oDialogNewLink=sap.ui.xmlfragment("FechamentoContabil.view.fragments.newHyperlink",this);this._oDialogNewLink.setModel(this.getView().getModel());this.getView().addDependent(this._oDialogNewLink);this._oDialogNewLink.setContentWidth("550px");this._oDialogNewLink.setContentHeight("280px")}this._oDialogNewLink.open()},onCloseDialogLink:function(){if(this._oDialogNewLink){this._oDialogNewLink.close();this._oDialogNewLink.destroy();this._oDialogNewLink=undefined}},onDeleteLink:function(e){var t=e.getSource();var i=e.getParameter("listItem");var a=i.getBindingContext().getPath();var o=this;s.warning("O hyperlink será removido em todas as instâncias. Essa ação não poderá ser desfeita.",{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e===sap.m.MessageBox.Action.OK){t.attachEventOnce("updateFinished",t.focus,t);o.getView().getModel().remove(a)}}})},getLinkTarefa:function(e){var t=this;var i=new sap.ui.model.Filter({path:"Plano",operator:sap.ui.model.FilterOperator.EQ,value1:this.getView().byId("idInputModelo").getSelectedItem().getText().trim()});var a=new sap.ui.model.Filter({path:"Tarefa",operator:sap.ui.model.FilterOperator.EQ,value1:this.getAtividadeGantt(g.iconAnexo).trim()});var s=sap.ui.getCore().byId("LinkListDialog");s.bindAggregation("items",{path:"/LinkTarefas",filters:[i,a],template:new sap.m.StandardListItem({title:"{Nome}",description:"{Link}",tooltip:"{Descricao}",icon:"sap-icon://chain-link",iconDensityAware:false,iconInset:false,highlight:"Information",type:"Active",wrapping:true})});t._oDialogLinkList.setBusy(false)},onLinkCreate:function(e){var t=this;try{var i=new URL(sap.ui.getCore().byId("inputUrlHyperlink").getValue())}catch(e){s.error('A URL deve iniciar com "http://" ou "https://"');return}var a={Plano:this.getView().byId("idInputModelo").getSelectedItem().getText().trim(),Tarefa:this.getAtividadeGantt(g.iconAnexo).trim(),Nome:sap.ui.getCore().byId("inputNomeHyperlink").getValue(),Descricao:sap.ui.getCore().byId("inputDescHyperlink").getValue(),Link:i.href};var o={success:function(e,i){sap.m.MessageToast.show("Hiperlink cadastrado com sucesso");t.onCloseDialogLink()},error:function(e){var t=JSON.parse(e.responseText).error.message.value;s.error(t)}};var n=this.getView().getModel();n.create("/LinkTarefas",a,o)},createModel:function(e,t){const i=new r(e);this.getView().setModel(i,t)},getAtividadeStatus:function(e){if(e==="R"){return"Em processamento"}if(e==="0"){return"Concluído sem erros"}if(e==="2"){return"Concluído com avisos"}if(e==="4"){return"Concluído com erros"}if(e==="1"){return"Em Aprovação"}return"Não Iniciada"},getAtividadeRespExec:function(e){var t=e.getMetadata();var i;if(t.getName()==="sap.ui.base.Event")i=e.getSource().getParent();else i=e.getParent();for(var a=0;a<6;a++){if(i.getMetadata()._sClassName==="sap.ui.table.Row")break;i=i.getParent()}var s=i.getCells();var o=s[7];if(this.getView().getViewName()==="FechamentoContabil.view.Atividades"){var n=o.getItems();return n[0].getText()}},getAtividadeEmpresa:function(e){var t=e.getMetadata();var i;if(t.getName()==="sap.ui.base.Event")i=e.getSource().getParent();else i=e.getParent();for(var a=0;a<6;a++){if(i.getMetadata()._sClassName==="sap.ui.table.Row")break;i=i.getParent()}var s=i.getCells();var o=s[3];if(this.getView().getViewName()==="FechamentoContabil.view.Atividades"){var n=o.getItems();return n[0].getText()}},updateEmailSuggestions:function(e){this._updateEmailSuggestion=4;if(this._updatingSuggestion===undefined)this._updatingSuggestion=false;if(!this._updatingSuggestion){this._updatingSuggestion=true;this.updateSuggestion(e)}},updateSuggestion:function(e){setTimeout(()=>{if(this._updateEmailSuggestion===undefined)this._updateEmailSuggestion=4;this._updateEmailSuggestion-=1;if(this._updateEmailSuggestion>0)this.updateSuggestion(e);else{let t;if(e.target.id.indexOf("sendTaskInputEmail")!==-1)t="sendTaskInputEmail";const i=this.byId(t);i.setBusy(true);const a=new sap.ui.model.Filter({path:"Name",operator:sap.ui.model.FilterOperator.EQ,value1:i.getValue()});const s={useBatch:false};const o=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",s);o.read("/v2_help_users_office",{filters:[a],top:5,success:function(e){i.setBusy(false);i.removeAllSuggestionRows();for(const t of e.results){const e=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:t.DisplayName}),new sap.m.Text({text:t.UserPrincipalName})]});i.addSuggestionRow(e)}this._updatingSuggestion=false}.bind(this),error:function(e){i.setBusy(false);sap.m.MessageToast.show("Erro ao buscar emails");this._updatingSuggestion=false}.bind(this)})}},250)},emailSugestionSelected:function(e){const t=e.getParameter("selectedRow").getCells();const i=new sap.m.Token({key:t[1].getText(),text:t[1].getText()});e.getSource().addToken(i)},multiInputEmailValidator:function(e){const t=e.text;if(t.indexOf("@")!==-1)return new sap.m.Token({key:t,text:t})}})});