sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/model/type/Boolean"],function(e,t,i,s,a,n,o,l,r){"use strict";return e.extend("votorantim.corp.clocov2planmanagement.controller.DetailTable",{formatter:i,expandLevel:9,_profile:"",_instance:"",onInit:function(){this.createModel({hasSelectedItems:false,viewMode:"table",profileText:"",profileType:"",isTemplate:true,hasChanges:false,visibleRowsNode:1,clipboardData:[]},"detailView");this.createModel({cols:[{label:"Nome",template:"name",width:"40%"},{label:"E-mail",template:"email",width:"40%"},{label:"Usuário SAP",template:"user",width:"20%"}]},"columnsSearchUsers");this.createModel({cols:[]},"columnsSearchHelp");this.createModel({},"changeAlertConfigMass");this.createModel({},"changeTaskMass");this.createModel({},"newTaskPlan");this.createModel({},"motives");this.createModel(this.newEmptyTask(),"newTask");this.getView().setBusyIndicatorDelay(0);this.getView().setBusy(true);this.getRouter().getRoute("detailTable").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("taskTable").attachPatternMatched(this.onTaskView,this)},newEmptyTask:function(){return{EncerramentoMes:true,EncerramentoTri:true,EncerramentoAno:true,EncerramentoEspec:true,EncerramentoUsuario:false,Kind:"0"}},addPlanFieldsToTable:function(){const e=this.byId("tableTemplate");const t=["Status"];const s=e.getColumns();for(const e of s){if(e.getLabel())if(t.indexOf(e.getLabel().getText())!==-1)return}const a=new sap.m.ObjectStatus;a.bindProperty("text",{path:"table>Status",formatter:i.getStatusTaskText});a.bindProperty("state",{path:"table>Status",formatter:i.getStatusTaskState});const n=new sap.ui.table.Column({label:"Status",template:a,width:"150px"});e.insertColumn(n,2)},removePlanFieldsToTable:function(){const e=this.byId("tableTemplate");const t=e.getColumns();const i=["Status"];for(const s of t){if(s.getLabel())if(i.indexOf(s.getLabel().getText())!==-1)e.removeColumn(s)}},filterTable:function(e){this.filterItemTable(e)},filterItemTable:function(e){var t=e.getParameter("query");this._oGlobalFilter=null;if(t){this._oGlobalFilter=new n([new n("Description",o.Contains,t),new n("User_respons",o.Contains,t),new n("User_respons_exec",o.Contains,t),new n("Caminho",o.Contains,t)],false)}this.byId("tableTemplate").getBinding().filter(this._oGlobalFilter,"Application")},showCompanySearchHelp:function(e){const t=e.getSource();if(t.getId().indexOf("idNewTaskCompany")!==-1||t.getId().indexOf("idChangeTaskCompany")!==-1){const e="/v2_help_companies";const i=this.getView().getModel("i18n").getResourceBundle().getText("folderCompanyCode");const s=["BUKRS","Desc"];const a=[{label:"Empresa",template:"BUKRS",width:"40%"},{label:"Descrição",template:"Desc",width:"60%"}];this.getView().getModel("columnsSearchHelp").setProperty("/cols",a);if(t.getId().indexOf("idNewTaskCompany")!==-1)this.onValueHelpRequested(e,"columnsSearchHelp",i,s,this.onSHPressCompanyCreateTask.bind(this),false);else this.onValueHelpRequested(e,"columnsSearchHelp",i,s,this.onSHPressCompanyChangeTask.bind(this),false);return}},onSHPressCompanyCreateTask:function(e){const t=this._oValueHelpDialog.getTable();const i=t.getSelectedIndex();const s=t.getContextByIndex(i).getObject();this.getView().getModel("newTask").setProperty("/Empresa",s.BUKRS);this.getView().getModel("newTask").refresh();this._oValueHelpDialog.close()},onSHPressCompanyChangeTask:function(e){const t=this._oValueHelpDialog.getTable();const i=t.getSelectedIndex();const s=t.getContextByIndex(i).getObject();this.getView().getModel("changeTaskMass").setProperty("/Empresa",s.BUKRS);this._oValueHelpDialog.close()},onTaskView:function(e){let t=e.getParameter("arguments");this._profile=t.profile;this._instance=t.instance;this._item=t.item;this._taskView=true;if(this._instance==0)this.getView().getModel("detailView").setProperty("/isTemplate",true);else this.getView().getModel("detailView").setProperty("/isTemplate",false);this.getRouter().getRoute("task").detachPatternMatched(this.onTaskView,this);this.getRouter().getRoute("folder").detachPatternMatched(this.onFolderView,this);let i,s;if(this._instance==0){i=`/v2_modelos(Profile='${t.profile}',Instance=${t.instance})`;s="to_modelodetalhe"}else{i=`/v2_planos(Profile='${t.profile}',Instance=${t.instance})`;s="toPlanoDetalhes"}this._bindView(i,s)},_bindView:function(e,t){this.getView().bindElement({path:e,parameters:{expand:t},events:{change:this._onBindingChange.bind(this),dataRequested:function(){this.getView().setBusy(true)}.bind(this)}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");return}this.clearTables();let i;if(this._instance!=0){this.getModel("detailView").setProperty("/profileType",this.getView().getModel("i18n").getResourceBundle().getText("mainPlan"));this.getModel("detailView").setProperty("/profileText",this.getView().getBindingContext().getProperty(`/v2_planos(Profile='${this._profile}',Instance=${this._instance})/Descricao`));this.byId("tabBtChangeProfile").setText("trocar plano");i="toPlanoDetalhes"}else{this.getModel("detailView").setProperty("/profileType",this.getView().getModel("i18n").getResourceBundle().getText("mainTemplate"));this.getModel("detailView").setProperty("/profileText",this.getView().getBindingContext().getProperty(`/v2_modelos(Profile='${this._profile}',Instance=${this._instance})/Text`));this.byId("tabBtChangeProfile").setText("trocar modelo");i="to_modelodetalhe"}let s=[];for(const e of this.getView().getBindingContext().getProperty(i)){const t=this.getView().getModel().getProperty("/"+e);s.push(t)}this.getModel("table").setProperty("/data",this.getItemsOnly(s));if(this._taskView){const e=this.getView().getModel("table").getProperty("/data");const t=this.getSelectedRow(this._item,e);this.getView().getModel("table").setProperty("/selectedTask",t);this._taskView=false}this.getView().setBusy(false)},getSelectedRow:function(e,t){let i;for(const s of t){if(s.NodeID===e){i=s;break}}return i},onSelectChange:function(){let e=[];e=this.byId("tableTemplate").getSelectedIndices();let t=false;if(e.length>0){t=true}this.getModel("detailView").setProperty("/hasSelectedItems",t)},onViewModeChange:function(e){this.getView().getParent().getParent().removeAllBeginColumnPages();var t=!l.system.phone;this.getRouter().navTo("detail",{profile:this._profile,instance:this._instance},t)},onDragStart:function(e){var t=this.byId("tableTemplate");var i=e.getParameter("dragSession");var s=e.getParameter("target");var a=s.getIndex();var n=t.getSelectedIndices();var o=[];if(n.length>0){if(n.indexOf(a)===-1){e.preventDefault()}else{for(var l=0;l<n.length;l++){o.push(t.getContextByIndex(n[l]).getObject())}}}else{o.push(t.getContextByIndex(a).getObject())}i.setComplexData("movedep",{draggedRowContexts:o})},goToTask:function(e){let t;if(!e.Profile){let i=e.getParameter("row");t=i.getBindingContext("tree").getProperty("register")}else t=e;this._item=t.NodeID;this.getView().getModel("table").setProperty("/selectedTask",t);if(window.location.href.indexOf(t.NodeID)!==-1){this.getModel("appView").setProperty("/layout","TwoColumnsBeginExpanded");return}if(t.Item==="X"){this.getRouter().navTo("taskTable",{profile:t.Profile,instance:t.Instance,item:t.NodeID})}else{this.getRouter().navTo("folderTable",{profile:t.Profile,instance:t.Instance,item:t.NodeID})}},_onObjectMatched:function(e){let t=e.getParameter("arguments");this._profile=t.profile;this._instance=t.instance;this.getModel("appView").setProperty("/layout","OneColumn");if(this._instance==0)this.getView().getModel("detailView").setProperty("/isTemplate",true);else this.getView().getModel("detailView").setProperty("/isTemplate",false);let i,s;if(this._instance==0){i=`/v2_modelos(Profile='${t.profile}',Instance=${t.instance})`;s="to_modelodetalhe";this.removePlanFieldsToTable()}else{i=`/v2_planos(Profile='${t.profile}',Instance=${t.instance})`;s="toPlanoDetalhes";this.addPlanFieldsToTable()}this._bindView(i,s)},clearTables:function(){const e=this.getView().getModel("table").getProperty("/data");e.splice(0,e.length)},goToMainPage:function(){this.getView().getParent().getParent().removeAllBeginColumnPages();this.getRouter().navTo("main")},onFilterTable:function(e){const t=e.getParameter("column");if(t.getFilterProperty()==="Coe"){e.getParameter("column").setFilterType(new r);const i=e.getParameter("value").trim().toLowerCase();e.preventDefault();function s(){t.setFiltered(false);this.byId("tableTemplate").getBinding().filter("","Application")}if(!i){s.apply(this);return}let a;if(i==="s"||i==="si"||i==="sim")a=true;if(i==="n"||i==="na"||i==="nã"||i==="não"||i==="nao")a=false;if(a!==undefined){const l=new n("Coe",o.EQ,a);t.setFiltered(true);this.byId("tableTemplate").getBinding().filter(l,"Application")}else{s.apply(this)}}}})});