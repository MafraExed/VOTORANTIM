sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/SearchField","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/ValidateException","sap/ui/model/SimpleType","sap/m/MessageBox","sap/m/MessageToast","sap/m/Token","../model/formatter","sap/m/ColumnListItem","sap/m/Label"],function(e,t,s,a,o,i,n,r,l,d,c,g,h,p,u){"use strict";return e.extend("votorantim.corp.clocov2planmanagement.controller.BaseController",{massBatchSize:500,getRouter:function(){return this.getOwnerComponent().getRouter()},onPressChangeAlertConfigMass:function(){let e=false;let t=this.getView();let s;const o=this.getView().getModel("detailView").getProperty("/viewMode");if(o==="tree"){s=this.getView().byId("TreeTemplate");const t=s.getSelectedIndices();for(const a of t){const t=s.getContextByIndex(a).getObject();if(t.register.Item){e=true;break}}}else e=true;if(!e){c.show("Nenhuma tarefa selecionada");return}this.getView().getModel("changeAlertConfigMass").setProperty("/",{Lembrete:false,AtividadeNaoIniciada:false,AtividadeNaoEncerrada:false,AtividadeDisponivel:false,AtividadeReprocessada:false,AtividadeFinalizada:false,updateLembrete:false,updateNaoInic:false,updateNaoEnc:false,updateDisp:false,updateRepro:false,updateFin:false});if(!this._changeAlertConfigMassDialog){this._changeAlertConfigMassDialog=a.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.ChangeAlertConfigMass",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);const s=["idChangeAlertEmailLembrete","idChangeAlertEmailatividadeNaoInic","idChangeAlertEmailAtividadeNaoEnc","idChangeAlertEmailAtividadeDisp","idChangeAlertEmailAtividadeReoroc","idChangeAlertEmailAtividadeFin"];for(const e of s){this.getView().byId(e).addValidator(this.multiInputEmailValidator)}return e}.bind(this))}this._changeAlertConfigMassDialog.then(function(e){e.open()}.bind(this))},onChangeAlertConfigMass:function(){d.warning("Atenção! As Configurações de Alerta serão aplicadas a todas as tarefas selecionadas. Tem certeza que deseja aplicar as alterações?",{actions:[d.Action.OK,d.Action.CANCEL],emphasizedAction:d.Action.OK,onClose:function(e){if(e!==d.Action.OK)return;else{this.getView().setBusy(true);let e;let t;let s=0;const a=this.getView().getModel("detailView").getProperty("/viewMode");const o=this.getView().getModel("changeAlertConfigMass").getProperty("/");if(a==="tree")e=this.getView().byId("TreeTemplate");else e=this.getView().byId("tableTemplate");const i=e.getSelectedIndices();const n={useBatch:true,defaultUpdateMethod:"PUT",groupId:"updateAlertMass"};const r=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",n);const l={};l.groupId=n.groupId;r.setDeferredGroups([n.groupId]);t=i.length;this.setProgress(0);this.displayDialogProgress();const d=a=>{let n=0;for(let g=a;g<i.length;g++){const a=i[g];let h=false;const p=e.getContextByIndex(a).getObject();if(p.register){if(p.register.Item==="X")h=true}else if(p.Item==="X")h=true;if(!h){t--;continue}const u=p.hasOwnProperty("Instance")?p.Instance:p.register.Instance;const f={Profile:p.Profile||p.register.Profile,Instance:u,Item:p.NodeID,Lembrete:o.Lembrete,LembreteEmails:this.getEmailValuesFromTokens("idChangeAlertEmailLembrete"),LembreteTipoNotificacao:o.LembreteTipoNotificacao,AtividadeNaoIniciada:o.AtividadeNaoIniciada,AtividadeNaoInicEmails:this.getEmailValuesFromTokens("idChangeAlertEmailatividadeNaoInic"),AtividadeNaoInicTipoNotificacao:o.AtividadeNaoInicTipoNotificacao,AtividadeNaoEncerrada:o.AtividadeNaoEncerrada,AtividadeNaoEncEmails:this.getEmailValuesFromTokens("idChangeAlertEmailAtividadeNaoEnc"),AtividadeNaoEncTipoNotificacao:o.AtividadeNaoEncTipoNotificacao,AtividadeDisponivel:o.AtividadeDisponivel,AtividadeDispEmails:this.getEmailValuesFromTokens("idChangeAlertEmailAtividadeDisp"),AtividadeDispTipoNotificacao:o.AtividadeDispTipoNotificacao,AtividadeReprocessada:o.AtividadeReprocessada,AtividadeRepTipoNotificacao:o.AtividadeRepTipoNotificacao,AtividadeRepEmails:this.getEmailValuesFromTokens("idChangeAlertEmailAtividadeReoroc"),AtividadeFinalizada:o.AtividadeFinalizada,AtividadeFinTipoNotificacao:o.AtividadeFinTipoNotificacao,AtividadeFinEmails:this.getEmailValuesFromTokens("idChangeAlertEmailAtividadeFin"),updateFin:o.updateFin,updateLembrete:o.updateLembrete,updateNaoInic:o.updateNaoInic,updateNaoEnc:o.updateNaoEnc,updateDisp:o.updateDisp,updateRepro:o.updateRepro};r.update("/"+`v2_notificacoes(Profile='${p.Profile||p.register.Profile}',Instance=${u},Item='${p.NodeID}')`,f,l);n++;s++;if(n===this.massBatchSize||s===t){this.submitChangesSync(r,"updateAlertMass").then(()=>{this.setProgress(s/t*100);if(s!==t)d(s);else{const t=this.getView().getModel("detailView").getProperty("/viewMode");if(t==="tree"){const e=this.getView().getModel("hierarchyChanges").getProperty("/");e.splice(0,e.length)}this.getView().setBusy(false);if(this._item)this.getModel().read(`/v2_tarefas(Profile='${this._profile}',Instance=${this._instance},NodeID='${this._item}')/to_notificacao`);e.clearSelection();c.show(this.getView().getModel("i18n").getResourceBundle().getText("appDataSaved"));this.closeDialogProgress();this.onCloseChangeAlertConfigDialog()}});return}}};d(s)}}.bind(this)})},onCloseChangeAlertConfigDialog:function(){this._changeAlertConfigMassDialog.then(function(e){e.close();e.destroy();this._changeAlertConfigMassDialog=undefined}.bind(this))},updateEmailSuggestions:function(e){this._updateEmailSuggestion=4;if(this._updatingSuggestion===undefined)this._updatingSuggestion=false;if(!this._updatingSuggestion){this._updatingSuggestion=true;this.updateSuggestion(e)}},updateSuggestion:function(e){setTimeout(()=>{if(this._updateEmailSuggestion===undefined)this._updateEmailSuggestion=4;this._updateEmailSuggestion-=1;if(this._updateEmailSuggestion>0)this.updateSuggestion(e);else{let t;if(e.target.id.indexOf("idMultiEmailLembrete")!==-1)t="idMultiEmailLembrete";if(e.target.id.indexOf("idMultiEmailatividadeNaoInic")!==-1)t="idMultiEmailatividadeNaoInic";if(e.target.id.indexOf("idMultiEmailAtividadeNaoEnc")!==-1)t="idMultiEmailAtividadeNaoEnc";if(e.target.id.indexOf("idMultiEmailAtividadeDisp")!==-1)t="idMultiEmailAtividadeDisp";if(e.target.id.indexOf("idMultiEmailAtividadeReoroc")!==-1)t="idMultiEmailAtividadeReoroc";if(e.target.id.indexOf("idMultiEmailAtividadeFin")!==-1)t="idMultiEmailAtividadeFin";if(e.target.id.indexOf("idChangeAlertEmailLembrete")!==-1)t="idChangeAlertEmailLembrete";if(e.target.id.indexOf("idChangeAlertEmailatividadeNaoInic")!==-1)t="idChangeAlertEmailatividadeNaoInic";if(e.target.id.indexOf("idChangeAlertEmailAtividadeNaoEnc")!==-1)t="idChangeAlertEmailAtividadeNaoEnc";if(e.target.id.indexOf("idChangeAlertEmailAtividadeDisp")!==-1)t="idChangeAlertEmailAtividadeDisp";if(e.target.id.indexOf("idChangeAlertEmailAtividadeReoroc")!==-1)t="idChangeAlertEmailAtividadeReoroc";if(e.target.id.indexOf("idChangeAlertEmailAtividadeFin")!==-1)t="idChangeAlertEmailAtividadeFin";const s=this.byId(t);s.setBusy(true);const a=new i({path:"Name",operator:n.EQ,value1:s.getValue()});const o={useBatch:false};const r=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",o);r.read("/v2_help_users_office",{filters:[a],top:5,success:function(e){s.setBusy(false);s.removeAllSuggestionRows();for(const t of e.results){const e=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:t.DisplayName}),new sap.m.Text({text:t.UserPrincipalName})]});s.addSuggestionRow(e)}this._updatingSuggestion=false}.bind(this),error:function(e){s.setBusy(false);c.show("Erro ao buscar emails");this._updatingSuggestion=false}.bind(this)})}},250)},emailSugestionSelected:function(e){const t=e.getParameter("selectedRow").getCells();const s=new g({key:t[1].getText(),text:t[1].getText()});e.getSource().addToken(s)},getEmailValuesFromTokens:function(e){let t;const s=this.getView().byId(e);const a=s.getTokens();for(const e of a){if(t)t+=";"+e.getText();else t=e.getText()}return t},onPressChangeTaskMass:function(){let e=false;let t=this.getView();let s;const o=this.getView().getModel("detailView").getProperty("/viewMode");if(o==="tree"){s=this.getView().byId("TreeTemplate");const t=s.getSelectedIndices();for(const a of t){const t=s.getContextByIndex(a).getObject();if(t.register.Item){e=true;break}}}else e=true;if(!e){c.show("Nenhuma tarefa selecionada");return}this.getView().getModel("changeTaskMass").setProperty("/",{InicioPlanAposDataBase:"NULL"});if(!this._changeTaskMassDialog){this._changeTaskMassDialog=a.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.ChangeTaskMass",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);return e})}this._changeTaskMassDialog.then(function(e){e.open()}.bind(this))},onChangeTaskMass:function(){const e=[];if(this.byId("TypeTaskMass").getSelectedKey()==="0"){e.push("jobTaskMass");e.push("varTaskMass")}if(this.byId("TypeTaskMass").getSelectedKey()==="2"){e.push("tcodeTaskMass")}if(this.validateInputFields(e))return;this.validateInputSAP(["idChangeTaskCompany#companies","idBtnChangeUserExec#user","idBtnChangeUserResp#user","jobTaskMass#program","tcodeTaskMass#tcode","varTaskMass#variant"],null,"jobTaskMass").then(e=>{if(e)return;d.warning("Atenção! Todas as tarefas selecionadas serão modificadas com as novas entradas inseridas. Tem certeza que deseja aplicar as alterações?",{actions:[d.Action.OK,d.Action.CANCEL],emphasizedAction:d.Action.OK,onClose:function(e){if(e!==d.Action.OK){}else{this.getView().setBusy(true);let e;let t;let s;let a;let o=0;const i={groupId:"updateTaskMass"};const n=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",i);n.setDeferredGroups([i.groupId]);const r=this.getView().getModel("detailView").getProperty("/viewMode");const l=this.getView().getModel("changeTaskMass").getProperty("/");if(r==="tree"){t="TreeTemplate";s="tree"}else{t="tableTemplate";s="table"}e=this.getView().byId(t);const d=e.getSelectedIndices();a=d.length;this.setProgress(0);this.displayDialogProgress();const g=t=>{let i=0;for(let h=t;h<d.length;h++){const t=d[h];const p=this.getModel(s).getProperty(e.getContextByIndex(t).getPath());if(r==="tree"){if(!p.register.Item){a--;continue}this.updateChangeMass(p.register,l,n)}else this.updateChangeMass(p,l,n);this.getModel(s).setProperty(e.getContextByIndex(t).getPath(),p);i++;o++;if(i===this.massBatchSize||o===a){this.submitChangesSync(n,"updateTaskMass").then(()=>{this.setProgress(o/a*100);if(o!==a)g(o);else{const e=this.getView().getModel("detailView").getProperty("/viewMode");if(e==="tree"){const e=this.getView().getModel("hierarchyChanges").getProperty("/");e.splice(0,e.length)}this.getView().getModel("changeTaskMass").setProperty("/",{});this.getModel().invalidate();this.onCloseChangeTasMasskDialog();this.getView().setBusy(false);this.closeDialogProgress();if(this._item)this.getModel().read(`/v2_tarefas(Profile='${this._profile}',Instance=${this._instance},NodeID='${this._item}')`);c.show(this.getView().getModel("i18n").getResourceBundle().getText("appDataSaved"))}});return}}};g(o)}}.bind(this)})})},submitChangesSync:async function(e,t){const s={groupId:t};e.setDeferredGroups([t]);await new Promise((t,a)=>{e.submitChanges({groupId:s.groupId,success:function(e){t(e)}.bind(this)})})},setProgress:function(e){this.getView().getModel("appView").setProperty("/progress",e)},displayDialogProgress:function(){if(!this.oDialogProgress){this.oDialogProgress=new sap.m.Dialog({title:"Atualização em andamento",content:new sap.m.ProgressIndicator({percentValue:"{appView>/progress}",displayValue:{path:"appView>/progress",formatter:h.formatProgress}})}).addStyleClass("sapUiContentPadding")}this;this.getView().addDependent(this.oDialogProgress);this.oDialogProgress.open()},closeDialogProgress:function(){this.oDialogProgress.close()},onPressDeleteSelection:function(){let e;const t=this.getView().getModel("detailView").getProperty("/viewMode");if(t==="tree")e=this.getView().byId("TreeTemplate");else e=this.getView().byId("tableTemplate");const s=e.getSelectedIndices();const a=[];for(const t of s){const s=e.getContextByIndex(t).getObject();a.push(s)}if(t==="tree"){for(const e of a){this.removeFromHierarchyChanges(e);this.addHierarchyChange(e.register,"delete")}return}d.warning("Atenção! Todas as tarefas selecionadas serão excluídas. Deseja continuar?",{actions:[d.Action.OK,d.Action.CANCEL],emphasizedAction:d.Action.OK,onClose:function(e){if(e===d.Action.OK){this.getView().setBusy(true);const e={useBatch:true};const t=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",e);const s=(new Date).getTime();const o={};o.groupId=s;o.changeSetId="changeset";t.setDeferredGroups([s]);for(const e of a){t.remove("/"+`v2_hierarquias(Profile='${e.Profile}',Instance=${e.Instance},NodeID='${e.NodeID}')`,o)}t.submitChanges({success:function(e,t){this.getModel().refresh(true);this.getView().byId("tableTemplate").clearSelection();c.show(this.getView().getModel("i18n").getResourceBundle().getText("appDataSaved"))}.bind(this),error:function(e){}.bind(this)})}}.bind(this)})},clearValueState(e){for(const t of e){const e=this.byId(t);if(!e)continue;const s="None";e.setValueState(s)}},validateInputFields(e,t){let s;if(t)s=t;else s=this;let a=false;for(const t of e){const e=s.byId(t);let o="None";const i=e.getBinding("value");const n=e.getBinding("selectedKey");try{if(i)i.getType().validateValue(e.getValue());if(n)n.getType().validateValue(e.getSelectedKey())}catch(t){o="Error";a=true;e.setValueState(o);d.error("Preencher todos os campos obrigatórios");return a}e.setValueState(o)}return a},updateChangeMass:function(e,t,s){if(t.Description)e.Description=t.Description;if(t.User_respons)e.User_respons=t.User_respons;if(t.User_respons_exec)e.User_respons_exec=t.User_respons_exec;if(t.CaminhoCritico)e.CaminhoCritico=t.CaminhoCritico;if(t.Kind)e.Kind=t.Kind;if(t.InicioPlanAposDataBase!=="NULL")e.InicioPlanAposDataBase=t.InicioPlanAposDataBase;if(t.Transacao)e.Transacao=t.Transacao;if(t.Programa)e.Programa=t.Programa;if(t.Variante)e.Variante=t.Variante;if(t.InicioPlanejadoDias)e.InicioPlanejadoDias=t.InicioPlanejadoDias;if(t.InicioPlanejadoHoras)e.InicioPlanejadoHoras=t.InicioPlanejadoHoras;if(t.DuracaoPlanejadoHoras)e.DuracaoPlanejadoHoras=t.DuracaoPlanejadoHoras;if(t.DuracaoPlanejadoDias)e.DuracaoPlanejadoDias=t.DuracaoPlanejadoDias;if(t.Empresa)e.Empresa=t.Empresa;if(t.updateCoe){e.updateCoe=t.updateCoe;if(e.updateCoe==="NO")e.Coe=false;else e.Coe=true}if(t.Departamento)e.Departamento=t.Departamento;const a=this.getBodyHierarchy(e);s.update(`/v2_hierarquias(Profile='${a.Profile}',Instance=${a.Instance},NodeID='${a.NodeID}')`,a,{groupId:"updateTaskMass"})},onCloseChangeTasMasskDialog:function(){this.getView().getModel("newTask").setProperty("/",this.newEmptyTask());this._changeTaskMassDialog.then(function(e){e.close()})},getBodyHierarchy(e){return{Profile:e.Profile,Instance:e.Instance,NodeID:e.NodeID,HierarchyLevel:e.HierarchyLevel,Description:e.Description,ParentNodeID:e.ParentNodeID,Kind:e.Kind,Item:e.Item,User_respons:e.User_respons,Calend:e.Calend,Type:e.Type,BUKRS:e.BUKRS,User_respons_exec:e.User_respons_exec,Programa:e.Programa,Variante:e.Variante,CaminhoCritico:e.CaminhoCritico,EncerramentoMes:e.EncerramentoMes,EncerramentoTri:e.EncerramentoTri,EncerramentoAno:e.EncerramentoAno,EncerramentoEspec:e.EncerramentoEspec,EncerramentoUsuario:e.EncerramentoUsuario,InicioPlanejadoDias:e.InicioPlanejadoDias,InicioPlanejadoHoras:e.InicioPlanejadoHoras,InicioPlanAposDataBase:e.InicioPlanAposDataBase,DuracaoPlanejadoDias:e.DuracaoPlanejadoDias,DuracaoPlanejadoHoras:e.DuracaoPlanejadoHoras,Transacao:e.Transacao,Empresa:e.Empresa,Coe:e.Coe,updateCoe:e.updateCoe,Departamento:e.Departamento,CopyFrom:e.CopyFrom}},onPressCreateTaskPlan:function(){let e=this.getView();if(!this._createTaskPlanDialog){this._createTaskPlanDialog=a.load({id:e.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.CreateTaskPlan",controller:this}).then(function(t){t.setModel(e.getModel());e.addDependent(t);return t})}this._createTaskPlanDialog.then(function(e){e.open()}.bind(this))},onCloseCreateTaskPlanDialog:function(){this._createTaskPlanDialog.then(function(e){e.close()})},CreateTaskPlan:function(){const e=["idCreateTaskDesc","idCreateTaskDataBase","idCreateTaskExerc","idCreateTaskPeriodo","idCreateTaskTpEnc"];if(this.validateInputFields(e))return;this.getView().setBusy(true);this.onCloseCreateTaskPlanDialog();const t=this.getView().getModel("newTaskPlan").getProperty("/");t.Profile=this._profile;t.Instance=parseInt(this._instance);t.Periodo=parseInt(t.Periodo);d.warning("Deseja planejar os jobs para execução automática?",{actions:["Sim","Não"],emphasizedAction:"Sim",onClose:function(e){if(e==="Sim")t.schedule_tasks=true;else t.schedule_tasks=false;const s=(new Date).getTime();const a={};a.groupId=s;const o=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",a);o.setUseBatch(true);o.setDeferredGroups([s]);o.create("/v2_planos",t,a);o.submitChanges({success:function(e,t){this.getView().setBusy(false);if(e.__batchResponses[0].response){const t=JSON.parse(e.__batchResponses[0].response.body);this.displayErrorMessage(t.error.message.value)}else{this.getView().getModel("newTaskPlan").setProperty("/",{});this.getView().getModel().refresh(true);c.show("Plano de Tarefas criado com sucesso")}}.bind(this),error:function(e){this.displayErrorMessage("Erro ao Liberar Plano de Tarefas");this.getView().setBusy(false)}.bind(this)})}.bind(this)})},showTcodeSearchHelp:function(e){const t=e.getSource();const s="/v2_help_transacao";const a="Transação";const o=["Transacao","Aplicacao"];const i=[{label:"Transacao",template:"Transacao",width:"40%"},{label:"Aplicacao",template:"Aplicacao",width:"60%"}];this.getView().getModel("columnsSearchHelp").setProperty("/cols",i);if(t.getId().indexOf("tcodeNewTask")!==-1){this.onValueHelpRequested(s,"columnsSearchHelp",a,o,this.onSHPressTcodeCreateTask.bind(this),false)}if(t.getId().indexOf("tcodeTaskDetail")!==-1){this.onValueHelpRequested(s,"columnsSearchHelp",a,o,this.onSHPressTcodeTaskDetail.bind(this),false)}if(t.getId().indexOf("tcodeTaskMass")!==-1){this.onValueHelpRequested(s,"columnsSearchHelp",a,o,this.onSHPressTcodeTaskMass.bind(this),false)}return},onSHPressTcodeTaskMass:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("changeTaskMass").setProperty("/Transacao",a.Transacao);this.getView().getModel("changeTaskMass").refresh();this._oValueHelpDialog.close()},onSHPressTcodeCreateTask:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("newTask").setProperty("/Transacao",a.Transacao);this.getView().getModel("newTask").refresh();this._oValueHelpDialog.close()},showJobSearchHelp:function(e){const t=e.getSource();const s="/v2_help_programas";const a="Job";const o=["Programa"];const i=[{label:"Programa",template:"Programa",width:"50%"},{label:"Descrição",template:"DescProg",width:"50%"}];this.getView().getModel("columnsSearchHelp").setProperty("/cols",i);if(t.getId().indexOf("jobNewTask")!==-1){this.onValueHelpRequested(s,"columnsSearchHelp",a,o,this.onSHPressJobCreateTask.bind(this),false)}if(t.getId().indexOf("jobTaskDetail")!==-1){this.onValueHelpRequested(s,"columnsSearchHelp",a,o,this.onSHPressJobTaskDetail.bind(this),false)}if(t.getId().indexOf("jobTaskMass")!==-1){this.onValueHelpRequested(s,"columnsSearchHelp",a,o,this.onSHPressJobTaskMass.bind(this),false)}return},onSHPressJobTaskMass:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("changeTaskMass").setProperty("/Programa",a.Programa);this.getView().getModel("changeTaskMass").refresh();this._oValueHelpDialog.close()},onSHPressJobCreateTask:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("newTask").setProperty("/Programa",a.Programa);this.getView().getModel("newTask").refresh();this._oValueHelpDialog.close()},showVarSearchHelp:function(e){const t=e.getSource();const s="Variante";const a=["Nome_variante"];const o=[{label:"Variante",template:"Nome_variante",width:"50%"},{label:"Descrição",template:"Descricao_variante",width:"50%"}];this.getView().getModel("columnsSearchHelp").setProperty("/cols",o);if(t.getId().indexOf("varNewTask")!==-1){const e=this.getView().getModel("newTask").getProperty("/Programa");const t=`/v2_help_programas(Programa='${e}')/to_variantes`;this.onValueHelpRequested(t,"columnsSearchHelp",s,a,this.onSHPressVarCreateTask.bind(this),false)}if(t.getId().indexOf("varTaskMass")!==-1){const e=this.getView().getModel("changeTaskMass").getProperty("/Programa");const t=`/v2_help_programas(Programa='${e}')/to_variantes`;this.onValueHelpRequested(t,"columnsSearchHelp",s,a,this.onSHPressVarTaskMass.bind(this),false)}},onSHPressVarCreateTask:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("newTask").setProperty("/Variante",a.Nome_variante);this.getView().getModel("newTask").refresh();this._oValueHelpDialog.close()},onSHPressVarTaskMass:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("changeTaskMass").setProperty("/Variante",a.Nome_variante);this.getView().getModel("changeTaskMass").refresh();this._oValueHelpDialog.close()},showUserSearchHelp:function(e){const t=e.getSource();if(t.getId().indexOf("btnRespNewFolder")!==-1||t.getId().indexOf("btnRespChangeFolder")!==-1){const e="/v2_help_user";const t=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectUser");const s=["email","user","name"];this.onValueHelpRequested(e,"columnsSearchUsers",t,s,this.onSHPressUserCreateFolder.bind(this),false);return}if(t.getId().indexOf("idBtnCreateUserResp")!==-1){const e="/v2_help_user";const t=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectUser");const s=["email","user","name"];this.onValueHelpRequested(e,"columnsSearchUsers",t,s,this.onSHPressUserRespCreateTask.bind(this),false);return}if(t.getId().indexOf("idBtnCreateUserExec")!==-1){const e="/v2_help_user";const t=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectUser");const s=["email","user","name"];this.onValueHelpRequested(e,"columnsSearchUsers",t,s,this.onSHPressUserExecCreateTask.bind(this),false);return}if(t.getId().indexOf("idBtnChangeUserResp")!==-1){const e="/v2_help_user";const t=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectUser");const s=["email","user","name"];this.onValueHelpRequested(e,"columnsSearchUsers",t,s,this.onSHPressUserRespChangeTask.bind(this),false);return}if(t.getId().indexOf("idBtnChangeUserExec")!==-1){const e="/v2_help_user";const t=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectUser");const s=["email","user","name"];this.onValueHelpRequested(e,"columnsSearchUsers",t,s,this.onSHPressUserExecChangeTask.bind(this),false);return}if(t.getId().indexOf("idCreatePlanResp")!==-1||t.getId().indexOf("btnRespChangeFolder")!==-1){const e="/v2_help_user";const t=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectUser");const s=["email","user","name"];this.onValueHelpRequested(e,"columnsSearchUsers",t,s,this.onSHPressUserCreatePlanResp.bind(this),false);return}if(t.getId().indexOf("idApproverUserId")!==-1){const e="/v2_help_user";const t=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectUser");const s=["email","user","name"];this.onValueHelpRequested(e,"columnsSearchUsers",t,s,this.onSHPressUserAddChangeApprover.bind(this),false);return}},onSHPressUserAddChangeApprover:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();const o=this.getView().getModel("addChangeApprover").getProperty("/");o.UserId=a.user;o.ApproverName=a.name;this.getView().getModel("addChangeApprover").setProperty("/",o);this._oValueHelpDialog.close()},onSHPressUserCreatePlanResp:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("newTaskPlan").setProperty("/RespPE",a.user);this.getView().getModel("newTaskPlan").refresh();this._oValueHelpDialog.close()},onSHPressUserRespCreateTask:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("newTask").setProperty("/User_respons",a.user);this.getView().getModel("newTask").refresh();this._oValueHelpDialog.close()},onSHPressUserRespChangeTask:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("changeTaskMass").setProperty("/User_respons",a.user);this.getView().getModel("changeTaskMass").refresh();this._oValueHelpDialog.close()},onSHPressUserExecChangeTask:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("changeTaskMass").setProperty("/User_respons_exec",a.user);this.getView().getModel("changeTaskMass").refresh();this._oValueHelpDialog.close()},onSHPressUserExecCreateTask:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("newTask").setProperty("/User_respons_exec",a.user);this.getView().getModel("newTask").refresh();this._oValueHelpDialog.close()},onSHPressUserCreateFolder:function(e){const t=this._oValueHelpDialog.getTable();const s=t.getSelectedIndex();const a=t.getContextByIndex(s).getObject();this.getView().getModel("newFolder").setProperty("/User_respons",a.user);this.getView().getModel("newFolder").refresh();this._oValueHelpDialog.close()},onPressRejectChanges:function(){this.getView().setBusy(true);this.getView().getModel().resetChanges(null);this.getView().getModel().mDeferredRequests={};if(this.getView().getViewName()==="votorantim.corp.clocov2planmanagement.view.Detail"){this.byId("detailPage").setShowFooter(false);this.getView().getModel().refresh(true)}if(this.getView().getViewName()==="votorantim.corp.clocov2planmanagement.view.Task"){this.getView().getModel().refresh(true);this.getView().getModel("taskView").setProperty("/hasChanges",false);this.byId("ObjectPageTask").setShowFooter(false)}if(this.getView().getViewName()==="votorantim.corp.clocov2planmanagement.view.Folder"){this.getView().getModel().refresh(true);this.getView().getModel("folderView").setProperty("/hasChanges",false);this.byId("ObjectPageFolder").setShowFooter(false)}},getModel:function(e){return this.getView().getModel(e)},setModel:function(e,t){return this.getView().setModel(e,t)},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},onNavBack:function(){var e=t.getInstance().getPreviousHash();if(e!==undefined){history.go(-1)}else{this.getRouter().navTo("list",{},true)}},validateInputSAP:async function(e,t,s){let a;let o=false;let i;let n;let r=false;const l={};if(t)a=t;else a=this;l.groupId="createFolder";const c=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",l);c.setDeferredGroups(["createFolder"]);const g=[];for(const t of e){const e=t.split("#");const o=a.byId(e[0]);const i=e[1];if(o.getValue().trim()==="")continue;g.push(t);if(i==="companies"){r=true;c.read(`/v2_help_companies(BUKRS='${o.getValue()}')`,l)}if(i==="user"){r=true;c.read(`/v2_help_user(user='${o.getValue()}')`,l)}if(i==="calendar"){r=true;c.read(`/v2_help_calendariosfabrica(IDCalendFabrica='${o.getValue()}')`,l)}if(i==="program"){r=true;c.read(`/v2_help_programas('${encodeURIComponent(o.getValue())}')`,l)}if(i==="tcode"){r=true;c.read(`/v2_help_transacao('${encodeURIComponent(o.getValue())}')`,l)}if(i==="variant"){r=true;const e=a.byId(s);c.read(`/v2_help_variantes_prog(Programa='${encodeURIComponent(e.getValue())}',Nome_variante='${encodeURIComponent(o.getValue())}')`,l)}}if(!r)return false;await new Promise((e,t)=>{c.submitChanges({groupId:l.groupId,success:function(t){n=t.__batchResponses;e(t)}.bind(this)})});for(const[e,t]of n.entries()){if(t.response){o=true;const e=JSON.parse(t.response.body);d.error(e.error.message.value);break}}return o},createModel:function(e,t){const a=new s(e);this.getView().setModel(a,t)},getItemsOnly:function(e){if(e.length>0)return e.filter(e=>e.Item!=="")},displayErrorMessage:function(e){d.error(e)},onValueHelpRequested:function(e,t,s,i,n,r){this._oBasicSearchField=new o;this._fieldsSearch=i;a.load({name:"votorantim.corp.clocov2planmanagement.fragments.SearchHelp",controller:this}).then(function(a){this._oValueHelpDialog=a;this.getView().addDependent(this._oValueHelpDialog);var o=this._oValueHelpDialog.getFilterBar();o.setFilterBarExpanded(false);o.setBasicSearch(this._oBasicSearchField);this._oBasicSearchField.onsapenter=function(e){var t=this._oValueHelpDialog.getFilterBar();t.search()}.bind(this);this._oValueHelpDialog.setTitle(s);this._oValueHelpDialog.setSupportMultiselect(r);this._oValueHelpDialog.attachOk(n);this._oValueHelpDialog.getTableAsync().then(function(s){s.setModel(this.getModel());s.setModel(this.getModel(t),"columns");if(s.bindRows){s.bindAggregation("rows",e)}if(s.bindItems){s.bindAggregation("items",e,function(){return new p({cells:this.getModel("columnsSearchUsers").getProperty("/").cols.map(function(e){return new u({text:"{"+e.template+"}"})})})}.bind(this))}this._oValueHelpDialog.update()}.bind(this));this._oValueHelpDialog.open()}.bind(this))},onFilterBarSearch:function(e){var t=this._oBasicSearchField.getValue(),s=e.getParameter("selectionSet");var a=s.reduce(function(e,t){if(t.getValue()){e.push(new i({path:t.getName(),operator:n.Contains,value1:t.getValue()}))}return e},[]);for(const e of this._fieldsSearch){a.push(new i({filters:[new i({path:e,operator:n.Contains,value1:t})],and:false}))}this._filterTable(new i({filters:a,and:true}))},_filterTable:function(e){var t=this._oValueHelpDialog;t.getTableAsync().then(function(s){if(s.bindRows){s.getBinding("rows").filter(e)}if(s.bindItems){s.getBinding("items").filter(e)}t.update()})},onValueHelpCancelPress:function(){this._oValueHelpDialog.close()},onValueHelpAfterClose:function(){this._oValueHelpDialog.destroy()},getRootView(e){let t=false;let s=this.oParentBlock;while(!t){if(s.getMetadata().getElementName()==="sap.ui.core.mvc.XMLView"){if(s.getViewName()===e){return s}}s=s.oParent}},getTypeOfChange:function(e){if(e==="new")return"I";if(e==="update")return"U";if(e==="delete")return"D"},getRandomNumber:function(e,t){return Math.floor(Math.random()*(t-e))+e},markDeleteNodeHierarchy:function(e,t){if(!e.Item)e.Item="";const s=(e,t)=>{for(const a of t){if(a.NodeID===e.NodeID){a.highlight=e.highlight;return true}if(a.nodes.length>0){if(s(e,a.nodes))return true}}};return s(e,t)},getNode:function(e,t){if(!e)return;const s=(e,t)=>{let a;for(const o of t){if(a)return a;if(o.NodeID===e){a=o;return a}if(o.nodes.length>0){a=s(e,o.nodes);if(a)return a}}return a};return s(e,t)},removeNodeHierarchy:function(e,t){if(!e.Item)e.Item="";const s=(e,t)=>{let a={removed:false,indexToRemove:null};for(const[o,i]of t.entries()){if(a.removed)return a;if(i.NodeID===e.NodeID){i.highlight=e.highlight;a.indexToRemove=o;return a}if(i.nodes.length>0){a=s(e,i.nodes);if(a.removed)return a;if(a.indexToRemove!==null){i.nodes.splice(a.indexToRemove,1);a.removed=true;return a}}}return a};const a=s(e,t);if(!a.removed&&a.indexToRemove!==null){t.splice(indexToRemove,1)}},addNodeHierarchy:function(e,t){if(e.NodeID==="")e.NodeID="NEW_"+this.getRandomNumber(1,1e4).toString();if(!e.Item)e.Item="";const s=this.createNode(e);const a=(e,t)=>{let s=0;for(const o of t){if(o.NodeID===e.ParentNodeID){s=o.nodes.length+1;e.parent=o;e.register.HierarchyLevel=s;o.nodes.push(e);return s}if(o.nodes.length>0){s=a(e,o.nodes);if(s>0)return s}}};return a(s,t)},createNode:function(e,t){let s="";let a="";if((e.Kind===""||!e.Kind)&&e.Item==="X")e.Kind="0";if(e.Item!=="X")s="sap-icon://folder-full";else if(e.Kind==="2")s="sap-icon://person-placeholder";else if(e.Kind==="3")s="sap-icon://notes";else if(e.Kind==="0")s="sap-icon://media-play";if(e.Item!=="X")a="#dcb67a";else a="black";return{NodeID:e.NodeID,register:e,ParentNodeID:e.ParentNodeID,highlight:e.highlight,Icon:s,parent:t,Color:a,nodes:[]}},createNodeHierarchy:function(e){let t=[];const s=(e,t)=>{let a=false;for(let o of e){if(o.NodeID===t.ParentNodeID){o.nodes.push(this.createNode(t,o));a=true;break}if(o.nodes.length>0){a=s(o.nodes,t);if(a)break}}return a};const a=e=>{e.sort((e,t)=>e.register.HierarchyLevel-t.register.HierarchyLevel);for(const t of e){if(t.nodes.length>0){a(t.nodes)}}};while(e.length!==0){for(const[a,o]of e.entries()){if(t.length===0){if(o.ParentNodeID==="null"){t.push(this.createNode(o,t));e.splice(a,1);break}else continue}if(o.ParentNodeID==="null"){t.push(this.createNode(o,t));e.splice(a,1);break}if(s(t,o)){e.splice(a,1);break}}}a(t);return t},pressInfoAlert:function(e){if(e==="lembrete")d.information("Será enviado lembrete aproximadamente 30 minutos antes do início planejado da tarefa, para prevenir atraso.");if(e==="tarefaNaoInic")d.information("Caso já tenha passado o horário planejamento para início da execução da tarefa, e ela não tenha sido iniciada, será enviada notificação de atraso.");if(e==="tarefaNaoEnc")d.information("Caso já tenha passado o horário planejamento para término da execução da tarefa, e ela não tenha sido encerrada, será enviada notificação de atraso.");if(e==="tarefaDisp")d.information("O responsável por esta tarefa será notificado assim que a tarefa precedente for concluída. Este tipo de alerta somente é relevante quando da existência de relação de dependência entre tarefas.");if(e==="tarefaRep")d.information("Em caso de reprocessamento de tarefa predecessora, será enviada notificação para o responsável pela execução desta tarefa. Este tipo de alerta somente é relevante quando da existência de relação de dependência entre tarefas.");if(e==="tarefaFin")d.information("Os destinatários informados aqui serão notificados da conclusão desta tarefa assim que o status for alterado para “Concluído sem erros”.")},onPressChangeStatusPlan:function(){let e=this.getView();this._oldStatus=this.getView().getBindingContext().getObject().Status;if(!this._changeStatusPlanDialog){this._changeStatusPlanDialog=a.load({id:e.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.ChangeStatusPlan",controller:this}).then(function(t){t.setModel(e.getModel());e.addDependent(t);return t})}this._changeStatusPlanDialog.then(function(e){e.open()}.bind(this))},onCloseChangeStatusPlanDialog:function(){this.getModel().setProperty(this.getView().getBindingContext().getPath()+"/Status",this._oldStatus);if(this._changeStatusPlanDialog){this._changeStatusPlanDialog.then(function(e){e.close();e.close();e.destroy()});this._changeStatusPlanDialog=undefined}},ChangeStatusPlan:function(){const e=()=>{this.getView().setBusy(true);const e={Profile:this._profile,Instance:parseInt(this._instance),Status:this.getView().getBindingContext().getObject().Status};this.getView().getModel().callFunction("/change_plan_status",{method:"POST",urlParameters:e,success:function(t,s){this.getView().setBusy(false);if(s.statusCode!=="200"){this.displayErrorMessage("Erro ao alterar Status do Plano de Tarefas")}else{this._oldStatus=e.Status;this.getView().getModel().refresh(true);c.show("Status do Plano de Tarefas atualizado com sucesso");this.onCloseChangeStatusPlanDialog()}}.bind(this),error:function(e){this.displayErrorMessage("Erro ao alterar Status do Plano de Tarefas");this.getView().setBusy(false);this.onCloseChangeStatusPlanDialog()}.bind(this)})};if(this.getView().getBindingContext().getObject().Status===""){this.getView().setBusy(true);const t=this.checkIfHasActiveItems();this.getView().setBusy(false);if(t){d.warning("Já existe apontamento de status no Plano de Tarefas selecionado. Tem certeza que deseja voltar o status para 'Não Liberado'?",{actions:[d.Action.OK,d.Action.CANCEL],emphasizedAction:d.Action.OK,onClose:function(t){if(t!==d.Action.OK){this.getModel().setProperty(this.getView().getBindingContext().getPath()+"/Status",this._oldStatus);return}else{e()}}.bind(this)})}else e()}else e()},onPressChangeApprovalMass:function(){let e=false;let t=this.getView();let s;const o=this.getView().getModel("detailView").getProperty("/viewMode");if(o==="tree"){s=this.getView().byId("TreeTemplate");const t=s.getSelectedIndices();for(const a of t){const t=s.getContextByIndex(a).getObject();if(t.register.Item){e=true;break}}}else e=true;if(!e){c.show("Nenhuma tarefa selecionada");return}if(!this.getModel("addChangeApprover")){this.createModel({Active:false},"addChangeApprover");this.createModel([],"newApprovalList");this.createModel([],"approvalLevels")}else{this.getModel("addChangeApprover").setProperty("/",{Active:false});this.getModel("newApprovalList").setProperty("/",[{Level:1}]);this.getModel("approvalLevels").setProperty("/",[])}this.setAvailableLevels("newApprovalList");if(!this._changeApprovalMassDialog){this._changeApprovalMassDialog=a.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.ChangeApprovalMass",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);return e}.bind(this))}this._changeApprovalMassDialog.then(function(e){e.open()}.bind(this))},openApproverForm(e){const t=this.getView();this._operation=e;if(e!=="change")this.getModel("addChangeApprover").setProperty("/",{Active:true});if(!this._approverFormDialog){this._approverFormDialog=a.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.AddChangeApproval",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);this.byId("idBtnAddChangeApprovalCloseDialog").attachPress(null,this.onCloseApproverFormDialog,this);this.byId("idBtnAddChangeApproval").attachPress(null,this.addApproverMass,this);return e}.bind(this))}this._approverFormDialog.then(function(e){e.open()}.bind(this))},onCloseApproverFormDialog:function(){if(this._approverFormDialog){this._approverFormDialog.then(function(e){e.close();e.destroy()}.bind(this))}this._approverFormDialog=undefined},onPressChangeApproverMass:function(e,t){this._operation="change";this.getView().getModel("addChangeApprover").setProperty("/",t);this.openApproverForm("change")},addApproverMass:function(){const e=this.getModel("newApprovalList").getProperty("/");const t=this.getModel("addChangeApprover").getProperty("/");if(!t.Notification)t.Notification="T";if(!t.UserId){d.error(`Campo "Usuário" é obrigatório`);return}if(!t.ValidFrom){d.error(`Campo "Válido De" é obrigatório`);return}if(!t.ValidTo){d.error(`Campo "Válido Até" é obrigatório`);return}if(t.ValidFrom>t.ValidTo){d.error(`A data "Valido De" não pode ser após a data "Válido Até"`);return}t.highlight=this.getHighlight(t);t.validText=this.getValidText(t);t.notificationText=this.getNotificationText(t);if(this._operation!=="change")e.push(t);const s=function e(t,s){if(t.Level<s.Level){return-1}if(t.Level>s.Level){return 1}return 0};e.sort(s);this.normalizeLevels(e);this.getModel("newApprovalList").setProperty("/",e);this.setAvailableLevels("newApprovalList");this.onCloseApproverFormDialog()},onChangeApppprovalMass:function(){d.warning("Atenção! As Configurações de Aprovação serão aplicadas a todas as tarefas selecionadas. Tem certeza que deseja aplicar as alterações?",{actions:[d.Action.OK,d.Action.CANCEL],emphasizedAction:d.Action.OK,onClose:function(e){if(e!==d.Action.OK)return;else{this.getView().setBusy(true);let e;let t;let s=0;const a=this.getView().getModel("detailView").getProperty("/viewMode");const o=this.getModel("newApprovalList").getProperty("/");const i=this.getModel("addChangeApprover").getProperty("/");if(a==="tree")e=this.getView().byId("TreeTemplate");else e=this.getView().byId("tableTemplate");const n=e.getSelectedIndices();const r={useBatch:true,defaultUpdateMethod:"PUT",groupId:"updateApprovalMass"};const l=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",r);const d={groupId:r.groupId};l.setDeferredGroups([r.groupId]);t=n.length;this.setProgress(0);this.displayDialogProgress();const g=a=>{let r=0;for(const a of n){let n=false;const h=e.getContextByIndex(a).getObject();if(h.register){if(h.register.Item==="X")n=true}else if(h.Item==="X")n=true;if(!n){t--;continue}i.Profile=h.Profile||h.register.Profile;i.Instance=h.hasOwnProperty("Instance")?h.Instance:h.register.Instance;i.Item=h.NodeID;let p={};Object.assign(p,i);p.UserId="";const u=this.getWorkflowBody(p);l.remove(`/v2_workflows(Profile='${i.Profile}',Instance=${i.Instance},Item='${i.Item}',UserId='',Level='')`,d);l.create("/v2_workflows",u,d);for(const e of o){e.Profile=h.Profile||h.register.Profile;e.Instance=h.hasOwnProperty("Instance")?h.Instance:h.register.Instance;e.Item=h.NodeID;const t=this.getWorkflowBody(e);l.create("/v2_workflows",t,d)}r++;s++;if(r===this.massBatchSize||s===t){this.submitChangesSync(l,"updateApprovalMass").then(()=>{this.setProgress(s/t*100);if(s!==t)g(s);else{this.getView().setBusy(false);sap.ui.getCore().getEventBus().publish("TaskApprovals","updateApprovals");e.clearSelection();this.onCloseApprovalMassDialog();c.show(this.getView().getModel("i18n").getResourceBundle().getText("appDataSaved"));this.closeDialogProgress()}});return}}};g(s)}}.bind(this)})},onCloseApprovalMassDialog:function(){this._changeApprovalMassDialog.then(function(e){e.close();e.destroy();this._changeApprovalMassDialog=undefined}.bind(this))},getValidText:function(e){return`<strong style="color:navy">Válido de</strong> ${h.convertFromSapDate(e.ValidFrom)} <strong style="color:navy">até</strong> ${h.convertFromSapDate(e.ValidTo)}`},getNotificationText:function(e){return`<strong style="color:navy">Tipo de Notificação:</strong> ${h.getNotificationText(e.Notification)}`},getHighlight:function(e){let t=(new Date).toISOString().slice(0,10);t=t.replaceAll("-","");if(t<e.ValidFrom)return"Warning";if(t<=e.ValidTo)return"Success";return"Error"},normalizeLevels:function(e){let t=0;for(const s of e){if(s.Level>t){t++;s.Level=t}}},setAvailableLevels:function(e){let t=0;const s=[];const a=this.getModel(e).getProperty("/");for(const e of a){if(e.Level>t){t++;s.push(t)}}t++;s.push(t);this.getModel("approvalLevels").setProperty("/",s)},onPressRemoveApproverMass:function(e,t){const s=this.getModel("newApprovalList").getProperty("/");const a=s.filter(e=>e.Email!==t.Email||e.ValidFrom!==t.ValidFrom||e.ValidTo!==t.ValidTo);this.normalizeLevels(a);this.getModel("newApprovalList").setProperty("/",a);this.setAvailableLevels("newApprovalList")},getWorkflowBody:function(e){let t;if(e.Level)t=e.Level.toString();return{Profile:e.Profile,Instance:e.Instance,Item:e.Item,UserId:e.UserId,Level:t,Active:e.Active,ApproverName:e.Name,ValidFrom:e.ValidFrom,ValidTo:e.ValidTo,Notification:e.Notification}},showDepartamentSearchHelp:function(e){const t=this.getView();this._departamentId=e;const s=t.getBindingContext().getObject();this._departamentDialog=a.load({id:this.getView().getId(),name:"votorantim.corp.clocov2planmanagement.fragments.DepartamentHelp",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);this.getView().byId("departamentTable").bindAggregation("rows",`/v2_departamentos(Profile='${s.Profile}',Departamento='')/toDepartamentos`);return e}.bind(this));this._departamentDialog.then(function(e){e.open()}.bind(this))},filterDepartament:function(e){const t=e.getParameter("query");this._oFilterDepartament=null;if(t){this._oFilterDepartament=new i([new i("Departamento",n.Contains,t)],false)}this.byId("departamentTable").getBinding().filter(this._oFilterDepartament,"Application")},onPressApplyDepartament:function(e){const t=this.getView().byId("departamentTable");const s=t.getContextByIndex(t.getSelectedIndex()).getObject();this.byId(this._departamentId).setValue(s.Departamento);if(this._departamentId==="idAreaTask")this.onDataChanged();this.onCloseDepartamentDialog()},onPressCreateDepartament:function(){this._oCreateDepartamentDialog=new sap.m.Dialog({title:"Criar Área/Departamento",content:new sap.m.Input({placeholder:"Área/Departamento",id:"idNewDepartament"}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Criar Departamento",press:this.createDepartament.bind(this)}),endButton:new sap.m.Button({text:"Cancelar",press:this.onCloseDepartamentCreateDialog.bind(this)})}).addStyleClass("sapUiResponsivePadding--content");this.getView().addDependent(this._oCreateDepartamentDialog);this._oCreateDepartamentDialog.open()},onCloseDepartamentCreateDialog:function(){this._oCreateDepartamentDialog.close();this._oCreateDepartamentDialog.destroy();this._oCreateDepartamentDialog=null},createDepartament(){const e=this.getView().getBindingContext().getObject();const t={Profile:e.Profile,Departamento:this._oCreateDepartamentDialog.getContent()[0].getValue()};this.getView().setBusy(true);this.getModel().create("/v2_departamentos",t,{success:function(e,s){this.getView().setBusy(false);this.byId(this._departamentId).setValue(t.Departamento);this.onCloseDepartamentDialog();this.onCloseDepartamentCreateDialog()}.bind(this),error:function(e,t){this.getView().setBusy(false);const s=JSON.parse(e.responseText);d.error(s.error.message.value)}.bind(this)})},onCloseDepartamentDialog:function(){if(this._departamentDialog){this._departamentDialog.then(function(e){e.close();e.destroy()}.bind(this))}this._departamentDialog=undefined},_getRouteName:function(){const e=this.getOwnerComponent().getRouter();const t=e.getHashChanger().getHash();const{name:s}=e.getRouteInfoByHash(t);return s},checkIfHasActiveItems:function(){let e=false;const t=this.getView().getBindingContext().getProperty("toPlanoDetalhes");for(const s of t){const t=this.getView().getModel().getProperty("/"+s);if(t.Status!==""){e=true;break}}return e},onPressDeletePlan:function(){const e=this.getView().getBindingContext().getObject().Status;if(e!==""){this.displayErrorMessage("Só é possível excluir Plano de Tarefas com status de 'Não Liberado'.");return}let t;this.getView().setBusy(true);const s=this.checkIfHasActiveItems();this.getView().setBusy(false);if(s)t="Já existe apontamento de status no Plano de Tarefas selecionado. Tem certeza que deseja Eliminar? O Plano não poderá ser recuperado posteriormente.";else t="Tem certeza que deseja Eliminar? O Plano não poderá ser recuperado posteriormente.";d.warning(t,{actions:[d.Action.OK,d.Action.CANCEL],emphasizedAction:d.Action.OK,onClose:function(e){if(e!==d.Action.OK)return;else{this.getView().setBusy(true);const e={useBatch:true,defaultUpdateMethod:"PUT",groupId:"deletePlan"};const t=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",e);const s={};s.groupId=e.groupId;t.setDeferredGroups([e.groupId]);const a=this.getView().getBindingContext().getObject();t.remove("/"+`v2_planos(Profile='${a.Profile}',Instance=${a.Instance})`,s);t.submitChanges({success:function(e,t){this.getView().setBusy(false);if(e.__batchResponses[0].response){const t=JSON.parse(e.__batchResponses[0].response.body);this.displayErrorMessage(t.error.message.value)}else{c.show("Plano de Tarefas excluído com sucesso");this.goToMainPage()}}.bind(this),error:function(e){this.displayErrorMessage("Erro ao excluir Plano de Tarefas");this.getView().setBusy(false)}.bind(this)})}}.bind(this)})},onPressOpenSettings:function(){const e=this.getView();if(!this._settingsDialog){this._settingsDialog=a.load({id:e.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.Settings",controller:this}).then(function(t){t.setModel(e.getModel());e.addDependent(t);t.setBusyIndicatorDelay(0);return t}.bind(this))}this._settingsDialog.then(function(e){this.getSettings(e);e.open()}.bind(this))},onChangeSettings:function(){const e=this.getModel("motives").getProperty("/");const t=this.getView().getModel("settings").getProperty("/");if(t.LateTasksPopup)if(!e.length||e.length===0){d.error("Nenhum motivo de atraso cadastrado");return}this._settingsDialog.then(function(e){e.setBusy(true)});this.getView().getModel().update(`/v2_configurations(Profile='${t.Profile}',Instance=${t.Instance})`,t,{success:e=>{this.onCloseSettingsDialog();c.show("Configurações atualizadas")}})},getSettings:function(e){const t=this.getView().getBindingContext().getObject();e.setBusy(true);this.getModel().read(`/v2_configurations(Profile='${t.Profile}',Instance=${t.Instance})`,{success:t=>{this.createModel(t,"settings");e.setBusy(false)}})},onCloseSettingsDialog:function(){if(this._settingsDialog){this._settingsDialog.then(function(e){e.close();e.destroy()})}this._settingsDialog=undefined},multiInputEmailValidator:function(e){const t=e.text;if(t.indexOf("@")!==-1)return new sap.m.Token({key:t,text:t})},onPressOpenPlanHeader:function(){const e=this.getView();if(!this._planHeader){this._planHeader=a.load({id:e.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.PlanHeader",controller:this}).then(function(t){t.setModel(e.getModel());e.addDependent(t);t.setBusyIndicatorDelay(0);return t}.bind(this))}this._planHeader.then(function(e){e.open()}.bind(this))},onClosePlanHeaderDialog:function(){if(this._planHeader){this._planHeader.then(function(e){e.close();e.destroy()})}this._planHeader=undefined},newTaskBody:function(e,t){return{Profile:e.Profile,Instance:e.Instance,NodeID:e.NodeID,Item_prev:t.NodeID,Resp:e.Resp,InicioPlanejadoDias:e.InicioPlanejadoDias,InicioPlanejadoHoras:e.InicioPlanejadoHoras,FimPlanejadoDias:e.FimPlanejadoDias,FimPlanejadoHoras:e.FimPlanejadoHoras,TipoTarefa:e.TipoTarefa,Transacao:e.Transacao,DescTarefa:e.Description||e.DescTarefa,DuracaoPlanejadoDias:e.DuracaoPlanejadoDias,DuracaoPlanejadoHoras:e.DuracaoPlanejadoHoras,CaminhoCritico:e.CaminhoCritico,Caminho:e.Caminho,NomePrograma:e.NomePrograma,VariantePrograma:e.VariantePrograma,RespExec:e.RespExec,Empresa:e.Empresa,InicioPlanAposDataBase:e.InicioPlanAposDataBase}},onPressAddMotives:function(){const e=this.getView();if(!this._motivesDialog){this._motivesDialog=a.load({id:e.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.ConfigureLateTaskMotives",controller:this}).then(function(t){e.addDependent(t);t.setBusyIndicatorDelay(0);this.getModel().read(`/v2_modelos(Profile='${this._profile}',Instance=${this._instance})/toMotivoAtraso`,{success:function(e,t){this.getModel("motives").setProperty("/",t.data.results)}.bind(this)});return t}.bind(this))}this._motivesDialog.then(function(e){this.getSettings(e);e.open()}.bind(this))},onCloseAddMotivesDialog:function(){this.getView().getModel("settings").setProperty("/LateTasksPopup",true);if(this._motivesDialog){this._motivesDialog.then(function(e){e.close();e.destroy()})}this._motivesDialog=undefined},onMotiveSelectChange:function(){let e=[];e=this.byId("idMotivesTable").getSelectedIndices();if(e.length>0)this.byId("idRemoveMotiveButton").setEnabled(true);else this.byId("idRemoveMotiveButton").setEnabled(false)},onPressAddMotive:function(){const e={useBatch:true,groupId:"updateMotives"};const t=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",e);const s={};s.groupId=e.groupId;t.setDeferredGroups([e.groupId]);const a=this.byId("idInputMotive").getValue();if(a.trim()===""){d.error("Preencher o Motivo")}else{const e={Profile:this._profile,Instance:parseInt(this._instance),Seq:0,Motivo:a,Tipo:"ATRASO"};t.create("/"+`v2_motivo_atrasos`,e,s);t.submitChanges({success:function(t,s){this.getView().setBusy(false);if(t.__batchResponses[0].response){const e=JSON.parse(t.__batchResponses[0].response.body);this.displayErrorMessage(e.error.message.value)}else{c.show("Motivo adicionado com sucesso");this.byId("idInputMotive").setValue("");const t=this.getModel("motives").getProperty("/");t.unshift(e);this.getModel("motives").setProperty("/",t)}}.bind(this),error:function(e){this.displayErrorMessage("Erro ao adicionar Motivo");this.getView().setBusy(false)}.bind(this)})}},onPressRemoveMotive:function(){const e={useBatch:true,groupId:"deleteMotives"};const t=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",e);const s={};s.groupId=e.groupId;t.setDeferredGroups([e.groupId]);const a=this.byId("idMotivesTable").getSelectedIndices();for(const e of a){const a=this.byId("idMotivesTable").getContextByIndex(e).getObject();t.remove(`/v2_motivo_atrasos(Profile='${this._profile}',Instance=${this._instance},Seq=${a.Seq})`,s)}t.submitChanges({success:function(e,t){this.getView().setBusy(false);if(e.__batchResponses[0].response){const t=JSON.parse(e.__batchResponses[0].response.body);this.displayErrorMessage(t.error.message.value)}else{c.show("Motivo removido com sucesso");const e=this.getModel("motives").getProperty("/");for(let t=a.length;t>0;t--){const s=a[t-1];e.splice(s,1)}this.getModel("motives").setProperty("/",e);this.byId("idMotivesTable").clearSelection()}}.bind(this),error:function(e){this.displayErrorMessage("Erro ao remover Motivo");this.getView().setBusy(false)}.bind(this)})}})});