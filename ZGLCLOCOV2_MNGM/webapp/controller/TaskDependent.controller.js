sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/m/library","sap/ui/core/Fragment","sap/m/Popover","sap/m/Button","sap/m/FormattedText","sap/m/HBox","sap/ui/model/Sorter","sap/m/MessageToast"],function(e,t,o,s,n,i,r,a,d,p,h){"use strict";var l=s.URLHelper;return e.extend("votorantim.corp.clocov2planmanagement.controller.TaskDependent",{formatter:o,onInit:function(){this.byId("idGrapPredSuc").setCurrentZoomLevel(.85);this.createModel({cols:[{label:"Tarefa",template:"DescTarefa",width:"37%"},{label:"Responsável",template:"RespExec",width:"16%"},{label:"Caminho",template:"Caminho",width:"47%"}]},"columnsSearchDeps");this.createModel({nodes:[],lines:[]},"graphPredSuc");this.createModel([],"dependentGraphNode");this.createModel([],"dependentGraphLine");this.createModel([],"newGraphItemsNode");this.createModel([],"newGraphItemsLine");this.createModel([],"dependentsOfNewItems");this.createModel([],"linesRemoved");this.getView().attachModelContextChange(null,this.onContextChange,this)},onExit:function(){this.getView().detachModelContextChange(this.onContextChange,this)},onContextChange:function(e){if(!this.getView().getModel())return;if(!this.getView().getBindingContext())return;const t=this.getView().getBindingContext().getObject();if(this._lastItem===t.NodeID)return;this._lastItem=t.NodeID;const o=this.getView().getBindingContext().getProperty("toDependentes");const s=[];const n=[];for(const e of o){const t=this.getView().getModel().getProperty("/"+e);this.mountNodes(t,s,n)}this.getModel("dependentGraphNode").setProperty("/",s);this.getModel("dependentGraphLine").setProperty("/",n);this.getModel("newGraphItemsNode").setProperty("/",[]);this.getModel("newGraphItemsLine").setProperty("/",[]);this.getModel("dependentsOfNewItems").setProperty("/",[]);this.mountGraph(t)},mountNodes:function(e,t,o){if(e.Item_prev==="000000000000"){t.push(e);return}else{o.push(e)}if(this.getDependentIndex(t,e.NodeID)===-1){const o={...e};o.Item_prev="000000000000";t.push(o)}},openSearchHelpDependent:function(e){const t=e.getSource();if(!this._taskView)this._taskView=this.getRootView("votorantim.corp.clocov2planmanagement.view.Task");var o=new p({path:"Caminho",descending:false});const s={path:this._taskView.getBindingContext().getPath()+"/to_tarefas",sorter:o};let n;let i;if(t.getId().indexOf("idBtnAddPredGraph")!==-1){i=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectPredec");n="predecessor"}if(t.getId().indexOf("idBtnAddSucGraph")!==-1){i=this.getView().getModel("i18n").getResourceBundle().getText("taskSelectPredec");n="sucessor"}const r=function(e){this.onSHPressPredTasks(e,n)};const a=["DescTarefa","RespExec","Caminho"];this.onValueHelpRequested(s,"columnsSearchDeps",i,a,r.bind(this),true)},onSHPressPredTasks:function(e,t){const o=this._graphRightClickNode[0].getValue().taskDetail;if(!this._taskView)this._taskView=this.getRootView("votorantim.corp.clocov2planmanagement.view.Task");const s=this._oValueHelpDialog.getTable();let n=s.getSelectedIndices();const i=this.getView().getModel("newGraphItemsNode").getProperty("/");const r=this.getView().getModel("newGraphItemsLine").getProperty("/");const a=this.getView().getModel("dependentGraphNode").getProperty("/");const d=[];for(const e of n){const t=s.getContextByIndex(e).getObject();if(t.Empresa!=="")d.push(e);else h.show(`Erro: Tarefa ${t.DescTarefa} não tem empresa cadastrada`)}n=d;if(n.length===0)return;this.onDataChanged();const p=[];for(const e of n){const n=s.getContextByIndex(e).getObject();if(n.NodeID===o.NodeID)continue;if(t==="predecessor")p.push(n);else p.push(o)}this.getDependentsOfNewItems(p).then(()=>{for(const e of n){const n=s.getContextByIndex(e).getObject();if(n.NodeID===o.NodeID)continue;let d;let p=a.findIndex(e=>e.Item_prev===n.Item_prev||e.NodeID===n.NodeID);if(p!==-1)continue;p=i.findIndex(e=>e.Item_prev===n.Item_prev||e.NodeID===n.NodeID);if(p!==-1)continue;if(t==="predecessor"){d=n}else d=o;let h;if(t==="predecessor")h=this.newTaskBody(o,n);else h=this.newTaskBody(n,o);r.push(h);let l=this.getDependentIndex(i,n.NodeID);if(l===-1){l=this.getDependentIndex(a,n.NodeID);if(l===-1){const e=this.newTaskBody(n,{NodeID:"000000000000"});i.push(e)}}const c="changeDep";this._taskView.getModel().setDeferredGroups([c]);this._taskView.getModel().createEntry("/v2_dependentes",{properties:h,groupId:c})}this.getView().getModel("newGraphItemsNode").setProperty("/",i);this.getView().getModel("newGraphItemsLine").setProperty("/",r);this.mountGraph();this._oValueHelpDialog.close()})},getDependentsOfNewItems:async function(e){const t="depofnewitems";this.getView().setBusy(true);this.getModel().setDeferredGroups([t]);if(e.length===0)return;for(const o of e){this.getModel().read(`/v2_dependentes(Profile='${o.Profile}',Instance=${o.Instance},NodeID='${o.NodeID}',Item_prev='')/toDependentes`,{groupId:t})}await new Promise((e,o)=>{this.getModel().submitChanges({groupId:t,success:function(t,o){const s=this.getModel("dependentsOfNewItems").getProperty("/");for(const e of t.__batchResponses){s.push(...e.data.results)}this.getModel("dependentsOfNewItems").setProperty("/",s);this.getView().setBusy(false);e(o)}.bind(this)})});return},onDataChanged:function(){if(!this._taskView)this._taskView=this.getRootView("votorantim.corp.clocov2planmanagement.view.Task");if(!this._taskView.getModel("taskView").getProperty("/hasChanges")){this._taskView.byId("ObjectPageTask").setShowFooter(true);this._taskView.getModel("taskView").setProperty("/hasChanges",true)}this._lastItem=null;this.getView().getModel("taskView").setProperty("/suggestMassChanges",true)},onPressRemoveDep:function(e,t){const o=this.getView().getModel("newGraphItemsLine").getProperty("/");if(!this._taskView)this._taskView=this.getRootView("votorantim.corp.clocov2planmanagement.view.Task");this.onDataChanged();const s={groupId:"changeDep"};const n=`/v2_dependentes(Profile='${t.toDetail.Profile}',Instance=${t.toDetail.Instance},NodeID='${t.to}',Item_prev='${t.from}')`;const i=o.findIndex(e=>e.Item_prev===t.from&&e.NodeID===t.to);if(i===-1){this._taskView.getModel().setDeferredGroups(["changeDep"]);this._taskView.getModel().remove(n,s);this.removeFromGraph(true,t)}else{for(const[e,o]of Object.entries(this._taskView.getModel().getPendingChanges())){if(o.NodeID===t.to&&o.Item_prev===t.from){this._taskView.getModel().resetChanges(["/"+e],true,true);break}}this.removeFromGraph(false,t)}this.mountGraph()},removeFromGraph(e,t){const o=this.getModel("dependentGraphNode").getProperty("/");const s=this.getModel("dependentGraphLine").getProperty("/");const n=this.getModel("newGraphItemsNode").getProperty("/");const i=this.getModel("newGraphItemsLine").getProperty("/");const r=this.getModel("linesRemoved").getProperty("/");r.push(t);this.getModel("linesRemoved").setProperty("/",r);if(e){const e=s.findIndex(e=>e.Item_prev===t.from&&e.NodeID===t.to);s.splice(e,1);this.getModel("dependentGraphLine").setProperty("/",s)}else{const e=i.findIndex(e=>e.Item_prev===t.from&&e.NodeID===t.to);i.splice(e,1);this.getModel("newGraphItemsLine").setProperty("/",i)}const a=e=>{if(!this._taskView)this._taskView=this.getRootView("votorantim.corp.clocov2planmanagement.view.Task");const t=this._taskView.getBindingContext().getObject();if(t.NodeID===e)return;let r=i.findIndex(t=>t.Item_prev===e||t.NodeID===e);if(r===-1)r=s.findIndex(t=>t.Item_prev===e||t.NodeID===e);if(r===-1){r=this.getDependentIndex(o,e);if(r!==-1){o.splice(r,1);this.getModel("dependentGraphNode").setProperty("/",o)}r=this.getDependentIndex(n,e);if(r!==-1){n.splice(r,1);this.getModel("newGraphItemsNode").setProperty("/",n)}}};a(t.from);a(t.to)},pressOptionsGraph:function(e){const t=this.getView();const o=e.getParameter("buttonElement");const s=e.getSource().getParent();const i=s.getCustomData("task");if(!this._optionsNode){this._optionsNode=n.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.GraphOptions",controller:this}).then(function(e){t.addDependent(e);return e})}this._optionsNode.then(function(e){this._graphRightClickNode=i;e.openBy(o)}.bind(this))},refreshGraph:function(){this.invalidate()},mountGraph:function(e){const t=this.getModel("dependentGraphNode").getProperty("/");const s=this.getModel("dependentsOfNewItems").getProperty("/");const n=this.getModel("dependentGraphLine").getProperty("/");const i=this.getModel("newGraphItemsNode").getProperty("/");const r=this.getModel("newGraphItemsLine").getProperty("/");const a=this.getModel("linesRemoved").getProperty("/");const d=this.getView().getModel("graphPredSuc");const p=d.getProperty("/nodes");const h=d.getProperty("/lines");const l=(e,t,o,s,n,i,r,a,d,p,h)=>({key:e,title:t,graphStatus:i,attributes:[{label:"Empresa",value:h},{label:"Início",value:n},{label:"Responsável Exec.",value:o},{label:"Responsável",value:s}],taskDetail:{Profile:r,Instance:a,NodeID:d,Item_prev:p},actionButtons:[{icon:"sap-icon://overflow",title:"Opções"}]});const c=(e,t,o,s)=>({from:e,fromDetail:o,to:t,toDetail:s,lineActions:[{icon:"sap-icon://delete",title:"Remover"}]});p.splice(0,p.length);h.splice(0,h.length);d.setProperty("/nodes",p);d.setProperty("/lines",h);if(!e)e=this.getView().getBindingContext().getObject();p.push(l(e.NodeID,e.DescTarefa,e.RespExec,e.Resp,o.getEndPlanText(e.InicioPlanejadoDias,e.InicioPlanAposDataBase),"Success",e.Profile,e.Instance,e.NodeID,e.Item_prev,e.Empresa));for(const s of t){if(s.NodeID===e.NodeID)continue;p.push(l(s.NodeID,s.DescTarefa,s.RespExec,s.Resp,o.getEndPlanText2(s.InicioPlanejadoDias,s.InicioPlanAposDataBase),"",s.Profile,s.Instance,s.NodeID,s.Item_prev,s.Empresa))}for(const e of n){h.push(c(e.Item_prev,e.NodeID,t[this.getDependentIndex(t,e.Item_prev)],e))}for(const e of i){p.push(l(e.NodeID,e.DescTarefa,e.RespExec,e.Resp,o.getEndPlanText(e.InicioPlanejadoDias,e.InicioPlanAposDataBase),"",e.Profile,e.Instance,e.NodeID,e.Item_prev,e.Empresa))}for(const e of r){let o;let s=this.getDependentIndex(t,e.Item_prev);if(s!==-1)o=t[s];else o=i[this.getDependentIndex(i,e.Item_prev)];h.push(c(e.Item_prev,e.NodeID,o,e))}for(const e of s){let n;if(p.filter(t=>t.key===e.NodeID).length===0)p.push(l(e.NodeID,e.DescTarefa,e.RespExec,e.Resp,o.getEndPlanText(e.InicioPlanejadoDias,e.InicioPlanAposDataBase),"",e.Profile,e.Instance,e.NodeID,e.Item_prev,e.Empresa));if(e.Item_prev==="000000000000")continue;if(h.filter(t=>t.to===e.NodeID&&t.from===e.Item_prev).length===0){let o=this.getDependentIndex(t,e.Item_prev);if(o!==-1)n=t[o];else n=s[this.getDependentIndex(s,e.Item_prev)];const i=a.findIndex(t=>t.from===e.Item_prev&&t.to===e.NodeID);if(i===-1)h.push(c(e.Item_prev,e.NodeID,n,e))}}d.setProperty("/nodes",p);d.setProperty("/lines",h)},getDependentIndex:function(e,t){return e.map(e=>e.NodeID).indexOf(t)},linePress:function(e){const t=e.getSource();const o=t.getCustomData("task")[0].getValue();const s=`<p style="text-align:Center">A tarefa <span style="color: navy"><strong>${o.fromDetail.DescTarefa}</strong></span> é <strong>predecessora</strong> da tarefa <span style="color: navy"><strong>${o.toDetail.DescTarefa}</strong></span></p>`;const n=new d({justifyContent:"Center",items:[new r({text:"Remover",press:function(e){this.onPressRemoveDep(e,o)}.bind(this)})]}).addStyleClass("sapUiTinyMarginBottom");if(!this._optionsLine){this._optionsLine=new i({placement:"Bottom",showHeader:false,content:[new a({htmlText:s})],footer:n}).addStyleClass("sapUiResponsivePadding--content")}else{this._optionsLine.destroyFooter();this._optionsLine.setFooter(n);this._optionsLine.getContent()[0].setHtmlText(s)}e.preventDefault();this._optionsLine.openBy(e.getParameter("opener"))}})});