sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/m/library","sap/ui/core/Fragment","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,n,a,o,s,i){"use strict";return e.extend("votorantim.corp.clocov2planmanagement.controller.TaskAttachments",{formatter:n,onInit:function(){this.createModel({hasSelectedItems:false},"attachmentView");this.createModel({},"addAttachment")},onAnexarArquivo:function(){const e=this.byId("fileUploader");if(e.getValue()===""){sap.m.MessageBox.error("Nenhum arquivo selecionado");return}const t=["AddAttachTitle"];if(this.validateInputFields(t))return;if(!this._taskView)this._taskView=this.getRootView("votorantim.corp.clocov2planmanagement.view.Task");const n=this._taskView.getBindingContext().getObject();const a=`/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/v2_tarefas(Profile='${n.Profile}',Instance=${n.Instance},NodeID='${n.NodeID}')/to_anexo_upload`;e.setSendXHR(true);e.setUploadUrl(a);e.removeAllHeaderParameters();const o=this._taskView.getModel().oHeaders;const s=o["x-csrf-token"];const i=this.getView().getModel("addAttachment").getProperty("/");let r=`${i.Title}##${i.Comment}##${e.getValue()}`;r=r.replaceAll("\n"," ");r=encodeURIComponent(r);let d=new sap.ui.unified.FileUploaderParameter({name:"slug",value:r});e.addHeaderParameter(d);d=new sap.ui.unified.FileUploaderParameter({name:"X-CSRF-Token",value:s});e.addHeaderParameter(d);this._addAttachmentDialog.then(function(e){e.setBusy(true)});e.upload()},handleUploadAttachment:function(e){this.onCloseAddAttachmentDialog();this.byId("fileUploader").setValue("");const t=e.getParameter("responseRaw");const n=new DOMParser;const a=n.parseFromString(t,"text/xml");if(a.getElementsByTagName("error").length>0){s.error(a.getElementsByTagName("message")[0].textContent);return}this.byId("idAttachmentTable").getBinding("items").refresh()},onPressAddAttachment:function(){const e=this.getView();this.getView().getModel("addAttachment").setProperty("/",{});if(!this._addAttachmentDialog){this._addAttachmentDialog=o.load({id:e.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.AddAttachment",controller:this}).then(function(t){t.setModel(e.getModel());e.addDependent(t);return t})}this._addAttachmentDialog.then(function(e){e.open()}.bind(this))},onCloseAddAttachmentDialog:function(){this._addAttachmentDialog.then(function(e){e.setBusy(false);e.close()})},onSelectChange:function(){const e=this.byId("idAttachmentTable").getSelectedItems();let t=false;if(e.length>0){t=true}this.getModel("attachmentView").setProperty("/hasSelectedItems",t)},onDeleteAttachments:function(){const e=this.byId("idAttachmentTable");const t=e.getSelectedItems();s.warning("Atenção! Todas os anexos selecionados serão excluídos. Deseja continuar?",{actions:[s.Action.OK,s.Action.CANCEL],emphasizedAction:s.Action.OK,onClose:function(n){if(n===s.Action.OK){this.getView().setBusy(true);const n={useBatch:true};const a=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",n);const o=(new Date).getTime();const s={};s.groupId=o;a.setDeferredGroups([o]);for(const e of t){const t=e.getBindingContext().getObject();s.changeSetId=Math.floor(Math.random()*101)+Math.floor(Math.random()*101);a.remove(`/v2_anexos(Profile='${t.Profile}',Instance=${t.Instance},Item='${t.Item}',fileId='${encodeURIComponent(t.fileId)}')`,s)}a.submitChanges({success:function(t,n){e.removeSelections();this.getModel("attachmentView").setProperty("/hasSelectedItems",false);this.getModel().refresh(true);this.getView().setBusy(false);i.show(this.getView().getModel("i18n").getResourceBundle().getText("appDataSaved"))}.bind(this),error:function(e){}.bind(this)})}}.bind(this)})}})});