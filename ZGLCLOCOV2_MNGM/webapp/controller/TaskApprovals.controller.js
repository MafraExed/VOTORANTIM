sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/m/library","sap/ui/core/Fragment","sap/m/Token","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,o,s,i,r,a,n,l,p){"use strict";var h=s.URLHelper;return e.extend("votorantim.corp.clocov2planmanagement.controller.TaskApprovals",{formatter:o,onInit:function(){this.createModel({cols:[{label:"Nome",template:"name",width:"40%"},{label:"E-mail",template:"email",width:"40%"},{label:"Usuário SAP",template:"user",width:"20%"}]},"columnsSearchUsers");this.createModel([],"approvals");this.createModel([],"approvalHeader");this.createModel({},"addChangeApprover");this.createModel([],"approvalLevels");this.getView().attachModelContextChange(null,this.onContextChange,this);this.registerEventBus()},onExit:function(){this.getView().detachModelContextChange(this.onContextChange,this);sap.ui.getCore().getEventBus().unsubscribe("TaskApprovals","updateApprovals",this.onContextChange)},registerEventBus:function(){const e=sap.ui.getCore().getEventBus();e.subscribe("TaskApprovals","updateApprovals",this.onContextChange,this)},onContextChange:function(e){if(!this.getView().getModel())return;if(!this.getView().getBindingContext())return;const t=this.getView().getBindingContext().getObject();this._lastItem=t.NodeID;this.getApprovalData()},onDataChanged:function(){if(!this._taskView)this._taskView=this.getRootView("votorantim.corp.clocov2planmanagement.view.Task");if(!this._taskView.getModel("taskView").getProperty("/hasChanges")){this._taskView.byId("ObjectPageTask").setShowFooter(true);this._taskView.getModel("taskView").setProperty("/hasChanges",true)}},getApprovalData:function(){const e=this.getView().getBindingContext().getObject();const t=[new a({path:"Profile",operator:n.EQ,value1:e.Profile}),new a({path:"Instance",operator:n.EQ,value1:e.Instance}),new a({path:"Item",operator:n.EQ,value1:e.NodeID})];this.getModel().read(`/v2_workflows`,{filters:t,success:function(e,t){const o=[];for(const e of t.data.results){if(!e.UserId){this.getModel("approvalHeader").setProperty("/",e);continue}e.Level=parseInt(e.Level);e.highlight=this.getHighlight(e);e.validText=this.getValidText(e);e.notificationText=this.getNotificationText(e);o.push(e)}this.getModel("approvals").setProperty("/",o);this.setAvailableLevels("approvals")}.bind(this)})},setAvailableLevels:function(e){let t=0;const o=[];const s=this.getModel(e).getProperty("/");for(const e of s){if(e.Level>t){t++;o.push(t)}}t++;o.push(t);this.getModel("approvalLevels").setProperty("/",o)},onPressAddNewApprover:function(){this._operation="add";this.getView().getModel("addChangeApprover").setProperty("/",{operation:"Novo Aprovador"});this.openApproverDialog()},openApproverDialog(e){const t=this.getView();if(!this._addChangeApproverDialog){this._addChangeApproverDialog=i.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.AddChangeApproval",controller:this}).then(function(e){e.setModel(t.getModel());e.setBusyIndicatorDelay(0);t.addDependent(e);this.byId("idBtnAddChangeApproval").attachPress(null,this.addNewApprover,this);this.byId("idBtnAddChangeApprovalCloseDialog").attachPress(null,this.onCloseNewApproverDialog,this);return e}.bind(this))}this._addChangeApproverDialog.then(function(e){e.open()}.bind(this))},addNewApprover:async function(){let e;await this._addChangeApproverDialog.then(function(t){e=t}.bind(this));e.setBusy(true);const t=this.getModel("approvals").getProperty("/");const o=this.getModel("addChangeApprover").getProperty("/");const s=this.getView().getBindingContext().getObject();if(!o.Notification)o.Notification="T";if(!o.UserId){p.error(`Campo "Usuário" é obrigatório`);e.setBusy(false);return}if(!o.ValidFrom){p.error(`Campo "Válido De" é obrigatório`);e.setBusy(false);return}if(!o.ValidTo){p.error(`Campo "Válido Até" é obrigatório`);e.setBusy(false);return}if(o.ValidFrom>o.ValidTo){p.error(`A data "Valido De" não pode ser após a data "Válido Até"`);e.setBusy(false);return}if(o.UserId===this.getView().getBindingContext().getObject().RespExec){p.error(`O Aprovador não pode ser o Executor da tarefa`);e.setBusy(false);return}this.getView().setBusy(true);if(!o.ApproverName){await this.getUserName(o)}this.validateInputSAP(["idApproverUserId#user"],null,"").then(i=>{if(i){this.getView().setBusy(false);e.setBusy(false);return}this.getView().setBusy(false);o.highlight=this.getHighlight(o);o.validText=this.getValidText(o);o.notificationText=this.getNotificationText(o);o.Profile=s.Profile;o.Instance=s.Instance;o.Item=s.NodeID;if(this._operation!=="change")t.push(o);const r=function e(t,o){if(t.Level<o.Level){return-1}if(t.Level>o.Level){return 1}return 0};t.sort(r);this.normalizeLevels(t);this.getModel("approvals").setProperty("/",t);this.setAvailableLevels("approvals");e.setBusy(false);this.onCloseNewApproverDialog();this.updateSAP();this.onDataChanged()})},getUserName:async function(e){const t=new a({path:"user",operator:n.EQ,value1:e.UserId});await new Promise((e,o)=>{this.getModel().read("/v2_help_user",{filters:[t],success:function(t){if(t.results.length>0)this.getView().getModel("addChangeApprover").setProperty("/ApproverName",t.results[0].name);e(t)}.bind(this)})})},onCloseNewApproverDialog:function(){if(this._addChangeApproverDialog){this._addChangeApproverDialog.then(function(e){e.close();e.destroy()}.bind(this))}this._addChangeApproverDialog=undefined},onPressRemoveApprover:function(e,t){const o=this.getModel("approvals").getProperty("/");const s=o.filter(e=>e.UserId!==t.UserId||e.Level!==t.Level||e.ValidFrom!==t.ValidFrom||e.ValidTo!==t.ValidTo);this.normalizeLevels(s);this.getModel("approvals").setProperty("/",s);this.setAvailableLevels("approvals");this.updateSAP();this.onDataChanged()},onPressChangeApprover:function(e,t){this._operation="change";this.getView().getModel("addChangeApprover").setProperty("/",t);this.openApproverDialog()},updateSAP:function(){const e=this.getView().getBindingContext().getObject();this.removeAllFromSAP(e);const t=this.getModel("approvals").getProperty("/");for(const e of t){const t=this.getWorkflowBody(e);this.getModel().createEntry("/v2_workflows",{properties:t,groupId:"workflows"})}const o=this.getModel("approvalHeader").getProperty("/");this.getModel().createEntry("/v2_workflows",{properties:o,groupId:"workflows"})},removeAllFromSAP:function(e){const t={groupId:"workflows"};this.getModel().setDeferredGroups(["workflows"]);const o=`/v2_workflows(Profile='${e.Profile}',Instance=${e.Instance},Item='${e.NodeID}',UserId='',Level='')`;this.getModel().remove(o,t)},onChangeActiveApproval:function(){this.onDataChanged();this.updateSAP()},onUserChanged:function(){this.getView().getModel("addChangeApprover").setProperty("/ApproverName","");this.onDataChanged()}})});