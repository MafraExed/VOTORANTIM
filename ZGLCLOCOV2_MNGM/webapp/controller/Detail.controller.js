sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/m/MessageBox"],function(e,t,i,o,s,n,r,a,l){"use strict";return e.extend("votorantim.corp.clocov2planmanagement.controller.Detail",{formatter:i,expandLevel:9,_profile:"",_instance:"",onInit:function(){this.createModel({hasSelectedItems:false,viewMode:"tree",profileText:"",profileType:"",isTemplate:true,hasChanges:false,visibleRowsNode:1,clipboardData:[]},"detailView");this.createModel({cols:[{label:"Nome",template:"name",width:"40%"},{label:"E-mail",template:"email",width:"40%"},{label:"Usuário SAP",template:"user",width:"20%"}]},"columnsSearchUsers");this.createModel({cols:[]},"columnsSearchHelp");this.createModel({HierarchyLevel:"",Description:"",User_respons:"",Calend:"",selectedRow:{}},"newFolder");this.createModel({},"changeAlertConfigMass");this.createModel({},"changeTaskMass");this.createModel({},"newTaskPlan");this.createModel({},"motives");this.createModel(this.newEmptyTask(),"newTask");this.createModel([],"hierarchyChanges");this._aClipboardData=[];this.getView().setBusyIndicatorDelay(0);this.getView().setBusy(true);this.getRouter().getRoute("detail").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("task").attachPatternMatched(this.onTaskView,this);this.getRouter().getRoute("folder").attachPatternMatched(this.onFolderView,this);this.byId("TreeTemplate").expandToLevel(3)},newEmptyTask:function(){return{EncerramentoMes:true,EncerramentoTri:true,EncerramentoAno:true,EncerramentoEspec:true,EncerramentoUsuario:false,Kind:"0"}},filterTable:function(e){this.filterTreeTable(e.getParameter("query"))},filterTreeTable:function(e){const t=this.getView().getModel("tree").getProperty("/data");const i=this.getView().getModel("tree").getProperty("/complete");if(i.length>0){t.length=0;this.getView().getModel("tree").setProperty("/data",i)}if(!e){this.getView().getModel("tree").refresh();return}this.getView().getModel("tree").setProperty("/complete",t);var o=t[0].nodes.filter(function t(i){if(i.register.Item)return i.register.Description.indexOf(e)!==-1;if(i.nodes){return(i.nodes=i.nodes.filter(t)).length}});this.getView().getModel("tree").setProperty("/data",o);this.getView().getModel("tree").refresh()},onTaskView:function(e){let t=e.getParameter("arguments");this._profile=t.profile;this._instance=t.instance;this._item=t.item;this._taskView=true;if(this._instance==0)this.getView().getModel("detailView").setProperty("/isTemplate",true);else this.getView().getModel("detailView").setProperty("/isTemplate",false);this.getRouter().getRoute("task").detachPatternMatched(this.onTaskView,this);this.getRouter().getRoute("folder").detachPatternMatched(this.onFolderView,this);let i,o;if(this._instance==0){i=`/v2_modelos(Profile='${t.profile}',Instance=${t.instance})`;o="to_modelodetalhe"}else{i=`/v2_planos(Profile='${t.profile}',Instance=${t.instance})`;o="toPlanoDetalhes"}this._bindView(i,o)},_bindView:function(e,t){this.getView().bindElement({path:e,parameters:{expand:t},events:{change:this._onBindingChange.bind(this),dataRequested:function(){this.getView().setBusy(true)}.bind(this)}})},_onBindingChange:function(e){var t=this.getView(),i=t.getElementBinding();if(!i.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");return}this.clearTables();let o;if(this._instance!=0){this.getModel("detailView").setProperty("/profileType",this.getView().getModel("i18n").getResourceBundle().getText("mainPlan"));this.getModel("detailView").setProperty("/profileText",this.getView().getBindingContext().getProperty(`/v2_planos(Profile='${this._profile}',Instance=${this._instance})/Descricao`));this.byId("btChangeProfile").setText("trocar plano");o="toPlanoDetalhes"}else{this.getModel("detailView").setProperty("/profileType",this.getView().getModel("i18n").getResourceBundle().getText("mainTemplate"));this.getModel("detailView").setProperty("/profileText",this.getView().getBindingContext().getProperty(`/v2_modelos(Profile='${this._profile}',Instance=${this._instance})/Text`));this.byId("btChangeProfile").setText("trocar modelo");o="to_modelodetalhe"}let s=[];for(const e of this.getView().getBindingContext().getProperty(o)){const t=this.getView().getModel().getProperty("/"+e);s.push(t)}this.getModel("tree").setProperty("/data",this.createNodeHierarchy(s));if(this._taskView||this._folderView){const e=this.getView().getModel("tree").getProperty("/data");const t=this.getNode(this._item,e);this.getView().getModel("tree").setProperty("/selectedTask",t.register);this._taskView=false;this._folderView=false}this.getView().setBusy(false)},onFolderView:function(e){let t=e.getParameter("arguments");this._profile=t.profile;this._instance=t.instance;this._item=t.item;this._folderView=true;if(this._instance==0)this.getView().getModel("detailView").setProperty("/isTemplate",true);else this.getView().getModel("detailView").setProperty("/isTemplate",false);let i,o;if(this._instance==0){i=`/v2_modelos(Profile='${t.profile}',Instance=${t.instance})`;o="to_modelodetalhe"}else{i=`/v2_planos(Profile='${t.profile}',Instance=${t.instance})`;o="toPlanoDetalhes"}this._bindView(i,o);this.getRouter().getRoute("task").detachPatternMatched(this.onTaskView,this);this.getRouter().getRoute("folder").detachPatternMatched(this.onFolderView,this)},onExpand:function(){if(this.expandLevel<3){this.expandLevel+=1}else{this.expandLevel=9}this.byId("TreeTemplate").collapseAll();this.byId("TreeTemplate").expandToLevel(this.expandLevel)},onCollapse:function(){if(this.expandLevel===0)return;if(this.expandLevel===9){this.expandLevel=3}else{this.expandLevel-=1}this.byId("TreeTemplate").collapseAll();this.byId("TreeTemplate").expandToLevel(this.expandLevel)},onSelectChange:function(){let e=[];e=this.byId("TreeTemplate").getSelectedIndices();let t=false;if(e.length>0){t=true}this.getModel("detailView").setProperty("/hasSelectedItems",t)},onViewModeChange:function(e){this.getView().getParent().getParent().removeAllBeginColumnPages();var t=!a.system.phone;this.getRouter().navTo("detailTable",{profile:this._profile,instance:this._instance},t)},goToTask:function(e){const t=this.getView().getModel("hierarchyChanges").getProperty("/");let i;let o=e.getParameter("row");i=o.getBindingContext("tree").getProperty("register");this._item=i.NodeID;this.getView().getModel("tree").setProperty("/selectedTask",i);const s=e=>{if(i.Item==="X"){if(window.location.href.indexOf(i.NodeID)!==-1){this.getModel("appView").setProperty("/layout","TwoColumnsBeginExpanded");return}this.getView().getParent().getParent().removeAllMidColumnPages();this.getRouter().navTo("task",{profile:i.Profile,instance:i.Instance,item:i.NodeID})}else{if(window.location.href.indexOf(i.NodeID)!==-1){this.getModel("appView").setProperty("/layout","TwoColumnsBeginExpanded");return}this.getView().getParent().getParent().removeAllMidColumnPages();this.getRouter().navTo("folder",{profile:i.Profile,instance:i.Instance,item:i.NodeID})}};if(t.length>0){l.warning("Deseja salvar as alterações feitas até o momento?",{actions:[l.Action.OK,l.Action.CANCEL],emphasizedAction:l.Action.OK,onClose:function(t){if(t===l.Action.OK){this.onSaveDetailChanges();if(i.NodeID.indexOf("NEW")!==-1)this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");else s(e)}}.bind(this)})}else s(e)},goToTaskMenu:function(e){const t=this.getView().getModel("hierarchyChanges").getProperty("/");let i;i=e.register;this._item=i.NodeID;this.getView().getModel("tree").setProperty("/selectedTask",i);const o=e=>{if(i.Item==="X"){if(window.location.href.indexOf(i.NodeID)!==-1)return;this.getView().getParent().getParent().removeAllMidColumnPages();this.getRouter().navTo("task",{profile:i.Profile,instance:i.Instance,item:i.NodeID})}else{if(window.location.href.indexOf(i.NodeID)!==-1)return;this.getView().getParent().getParent().removeAllMidColumnPages();this.getRouter().navTo("folder",{profile:i.Profile,instance:i.Instance,item:i.NodeID})}};if(t.length>0){l.warning("Deseja salvar as alterações feitas até o momento?",{actions:[l.Action.OK,l.Action.CANCEL],emphasizedAction:l.Action.OK,onClose:function(t){if(t===l.Action.OK){this.onSaveDetailChanges();if(i.NodeID.indexOf("NEW")!==-1)this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");else o(e)}}.bind(this)})}else o(e)},_onObjectMatched:function(e){let t=e.getParameter("arguments");this._profile=t.profile;this._instance=t.instance;this.getModel("appView").setProperty("/layout","OneColumn");if(this._instance==0)this.getView().getModel("detailView").setProperty("/isTemplate",true);else this.getView().getModel("detailView").setProperty("/isTemplate",false);let i,o;if(this._instance==0){i=`/v2_modelos(Profile='${t.profile}',Instance=${t.instance})`;o="to_modelodetalhe"}else{i=`/v2_planos(Profile='${t.profile}',Instance=${t.instance})`;o="toPlanoDetalhes"}this._bindView(i,o)},clearTables:function(){const e=this.getView().getModel("table").getProperty("/data");this.getView().getModel("tree").setProperty("/data",[]);const t=this.getView().getModel("hierarchyChanges").getProperty("/");t.splice(0,t.length);e.splice(0,e.length)},openCreateFolderDialog:function(e){let t=this.getView();this.getView().getModel("newFolder").setProperty("/selectedRow",e);if(!this._newFolderDialog){this._newFolderDialog=o.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.NewFolder",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);return e})}this._newFolderDialog.then(function(e){e.open()}.bind(this))},openCreateTaskDialog:function(e){this.clearValueState(["newTaskDesc","jobNewTask","varNewTask","tcodeNewTask"]);let t=this.getView();this.getView().getModel("newTask").setProperty("/selectedRow",e.getSource().data("rowkey"));if(!this._newTaskDialog){this._newTaskDialog=o.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.NewTask",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);return e})}this._newTaskDialog.then(function(e){e.open()}.bind(this))},onCreateFolder:function(){const e=this.getView().getModel("newFolder").getProperty("/");const t=["newFolderInputDescription","btnRespNewFolder","btnCalendarNewFolder"];if(this.validateInputFields(t))return;this.validateInputSAP(["btnRespNewFolder#user","btnCalendarNewFolder#calendar"]).then(t=>{if(t)return;if(e.selectedRow.register.Item)e.ParentNodeID=e.selectedRow.register.ParentNodeID;else e.ParentNodeID=e.selectedRow.register.NodeID;e.Profile=e.selectedRow.register.Profile;e.Instance=e.selectedRow.register.Instance;e.NodeID="";this.addHierarchyChange(e,"new");this.getView().getModel("newFolder").setProperty("/",{});this.onCloseNewFolderDialog();this.byId("TreeTemplate").clearSelection()})},onCreateTask:function(){const e=["idNewTaskCompany","newTaskDesc","idBtnCreateUserExec","newTaskPlanDias","newTaskPlanHoras","newTaskPlaDuracHoras"];if(this.byId("newTaskType").getSelectedKey()==="0"){e.push("jobNewTask");e.push("varNewTask")}if(this.byId("newTaskType").getSelectedKey()==="2"){e.push("tcodeNewTask")}if(this.validateInputFields(e))return;this.validateInputSAP(["idNewTaskCompany#companies","idBtnCreateUserExec#user","idBtnCreateUserResp#user","jobNewTask#program","tcodeNewTask#tcode","varNewTask#variant"],null,"jobNewTask").then(e=>{if(e)return;const t=this.getView().getModel("newTask").getProperty("/");if(t.selectedRow.register.Item)t.ParentNodeID=t.selectedRow.register.ParentNodeID;else t.ParentNodeID=t.selectedRow.register.NodeID;t.Profile=t.selectedRow.register.Profile;t.Instance=t.selectedRow.register.Instance;t.NodeID="";t.Item="X";this.addHierarchyChange(t,"new");this.getView().getModel("newTask").setProperty("/",this.newEmptyTask());this.onCloseNewTaskDialog();this.byId("TreeTemplate").clearSelection()})},addHierarchyChange:function(e,t){const i=this.getView().getModel("tree").getProperty("/data");const o=this.getView().getModel("hierarchyChanges").getProperty("/");const s=this.getModel("detailView").getProperty("/visibleRowsNode");if(!this.byId("detailPage").getShowFooter())this.byId("detailPage").setShowFooter(true);if(t==="new"){let n={};Object.assign(n,e);n.highlight="Success";n.typeOfChange=this.getTypeOfChange(t);const r=this.addNodeHierarchy(n,i);n.HierarchyLevel=r;o.push(n);this.getModel("detailView").setProperty("/visibleRowsNode",s+1)}if(t==="delete"){let s={};Object.assign(s,e);s.highlight="Error";s.typeOfChange=this.getTypeOfChange(t);this.removeNodeHierarchy(e,i);o.push(s)}this.getView().getModel("tree").refresh()},onCloseNewFolderDialog:function(){this._newFolderDialog.then(function(e){e.close()})},onCloseNewTaskDialog:function(){this._newTaskDialog.then(function(e){e.close()})},onSaveDetailChanges:function(){const e=this.getTypeOfChange("new");const t=this.getTypeOfChange("update");const i=this.getTypeOfChange("delete");const o={json:true,useBatch:true};this.getView().setBusy(true);const n=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",o);const r=this.getView().getModel("hierarchyChanges").getProperty("/");if(r.length===0)return;const a=(new Date).getTime();const l={};l.groupId=a;l.changeSetId="changeset";n.setDeferredGroups([a]);for(const o of r){const s=this.getBodyHierarchy(o);if(o.typeOfChange===e){n.create("/"+`v2_hierarquias`,s,l)}if(o.typeOfChange===t){n.update("/"+`v2_hierarquias(Profile='${o.Profile}',Instance=${o.Instance},NodeID='${o.NodeID}')`,s,l)}if(o.typeOfChange===i){if(o.NodeID.indexOf("NEW")!==-1)continue;n.remove("/"+`v2_hierarquias(Profile='${o.Profile}',Instance=${o.Instance},NodeID='${o.NodeID}')`,l)}}n.submitChanges({success:function(e,t){console.log(t);const i=this.getView().getModel("hierarchyChanges").getProperty("/");i.splice(0,i.length);const o=this.getView().getModel("tree").getProperty("/data/0");this.getModel().refresh(true);s.show(this.getView().getModel("i18n").getResourceBundle().getText("appDataSaved"));this.byId("detailPage").setShowFooter(false)}.bind(this),error:function(e){}.bind(this)})},menuDeleteNode:function(e){const t=e.getSource().data("rowkey");this.removeFromHierarchyChanges(t);this.addHierarchyChange(t.register,"delete")},removeFromHierarchyChanges:function(e){let t=this.getView().getModel("hierarchyChanges").getProperty("/");t=t.filter(t=>{if(e.NodeID===t.NodeID)return false;else return true});this.getView().getModel("hierarchyChanges").setProperty("/",t)},onCopyByMenuContext:function(e){const t=this.getView().getModel("detailView").getProperty("/clipboardData");const i={};const o=e.getSource().data("rowkey");if(t.length>0)t.splice(0,t.length);Object.assign(i,o);t.push(i);s.show("Dados copiados")},onPasteByMenuContext:function(e){const t=this.getView().getModel("detailView").getProperty("/clipboardData");const i=e.getSource().data("rowkey");t[0].register.CopyFrom=t[0].NodeID;if(t[0].NodeID.indexOf("NEW")!==-1){t[0].register.NodeID=t[0].NodeID;t[0].register.CopyFrom=t[0].register.CopyFrom.replace("NEW","")}else{t[0].NodeID+="NEW";t[0].register.NodeID+="NEW"}if(i.register.Item){t[0].ParentNodeID=i.parent.NodeID;t[0].register.ParentNodeID=i.parent.NodeID}else{t[0].ParentNodeID=i.NodeID;t[0].register.ParentNodeID=i.NodeID}this.addHierarchyChange(t[0].register,"new");const o=e=>{const t={};Object.assign(t,e);t.register.CopyFrom=t.NodeID;t.NodeID+="NEW";t.register.NodeID+="NEW";t.register.ParentNodeID+="NEW";t.ParentNodeID+="NEW";this.addHierarchyChange(t.register,"new");if(t.nodes.length>0){for(const e of t.nodes){o(e)}}};if(t[0].nodes.length>0){for(const e of t[0].nodes){o(e)}}},showCompanySearchHelp:function(e){const t=e.getSource();if(t.getId().indexOf("idNewTaskCompany")!==-1||t.getId().indexOf("idChangeTaskCompany")!==-1){const e="/v2_help_companies";const i=this.getView().getModel("i18n").getResourceBundle().getText("folderCompanyCode");const o=["BUKRS","Desc"];const s=[{label:"Empresa",template:"BUKRS",width:"40%"},{label:"Descrição",template:"Desc",width:"60%"}];this.getView().getModel("columnsSearchHelp").setProperty("/cols",s);if(t.getId().indexOf("idNewTaskCompany")!==-1)this.onValueHelpRequested(e,"columnsSearchHelp",i,o,this.onSHPressCompanyCreateTask.bind(this),false);else this.onValueHelpRequested(e,"columnsSearchHelp",i,o,this.onSHPressCompanyChangeTask.bind(this),false);return}},onSHPressCompanyCreateTask:function(e){const t=this._oValueHelpDialog.getTable();const i=t.getSelectedIndex();const o=t.getContextByIndex(i).getObject();this.getView().getModel("newTask").setProperty("/Empresa",o.BUKRS);this.getView().getModel("newTask").refresh();this._oValueHelpDialog.close()},onSHPressCompanyChangeTask:function(e){const t=this._oValueHelpDialog.getTable();const i=t.getSelectedIndex();const o=t.getContextByIndex(i).getObject();this.getView().getModel("changeTaskMass").setProperty("/Empresa",o.BUKRS);this._oValueHelpDialog.close()},showCalendarSearchHelp:function(e){const t=e.getSource();if(t.getId().indexOf("btnCalendarNewFolder")!==-1||t.getId().indexOf("btnCalendarChangeFolder")){const e="/v2_help_calendariosfabrica";const t=this.getView().getModel("i18n").getResourceBundle().getText("folderFactoryCal");const i=["Texto","IDCalendFabrica"];const o=[{label:"ID",template:"IDCalendFabrica",width:"40%"},{label:"Calendário",template:"Texto",width:"60%"}];this.getView().getModel("columnsSearchHelp").setProperty("/cols",o);this.onValueHelpRequested(e,"columnsSearchHelp",t,i,this.onSHPressCalendarCreateFolder.bind(this),false);return}},onSHPressCalendarCreateFolder:function(e){const t=this._oValueHelpDialog.getTable();const i=t.getSelectedIndex();const o=t.getContextByIndex(i).getObject();this.getView().getModel("newFolder").setProperty("/Calend",o.IDCalendFabrica);this.getView().getModel("newFolder").refresh();this._oValueHelpDialog.close()},onPressChangeFolderMass:function(){let e=false;let t=this.getView();let i;const n=this.getView().getModel("detailView").getProperty("/viewMode");if(n==="tree")i=this.getView().byId("TreeTemplate");else i=this.getView().byId("tableTemplate");const r=i.getSelectedIndices();for(const t of r){const o=i.getContextByIndex(t).getObject();if(!o.register.Item){e=true;break}}if(!e){s.show("Nenhuma pasta selecionada");return}if(!this._changeFolderMassDialog){this._changeFolderMassDialog=o.load({id:t.getId(),name:"votorantim.corp.clocov2planmanagement.fragments.ChangeFolderMass",controller:this}).then(function(e){e.setModel(t.getModel());t.addDependent(e);return e})}this._changeFolderMassDialog.then(function(e){e.open()}.bind(this))},onCloseChangeMassFolderDialog:function(){this._changeFolderMassDialog.then(function(e){e.close()})},onChangeFolderMass:function(){const e=[];if(this.validateInputFields(e))return;this.validateInputSAP(["btnRespChangeFolder#user","btnCalendarChangeFolder#calendar"]).then(e=>{if(e)return;l.warning("Atenção! Todas as pastas selecionadas serão modificadas com as novas entradas inseridas. Tem certeza que deseja aplicar as alterações?",{actions:[l.Action.OK,l.Action.CANCEL],emphasizedAction:l.Action.OK,onClose:function(e){if(e===l.Action.OK){let e;let t=0;const i={groupId:"updateFolderMass"};const o=new sap.ui.model.odata.v2.ODataModel("/sap/opu/odata/sap/ZGWGLFI_CLOCO_SRV/",i);o.setDeferredGroups([i.groupId]);this.getView().setBusy(true);let n;const r=this.getView().getModel("detailView").getProperty("/viewMode");if(r==="tree")n=this.getView().byId("TreeTemplate");else n=this.getView().byId("tableTemplate");const a=this.getView().getModel("newFolder").getProperty("/");const l=n.getSelectedIndices();e=l.length;this.setProgress(0);this.displayDialogProgress();const d=i=>{let r=0;for(let g=i;g<l.length;g++){const i=l[g];const h=this.getModel("tree").getProperty(n.getContextByIndex(i).getPath());if(h.register.Item){e--;continue}if(a.Description)h.register.Description=a.Description;if(a.User_respons)h.register.User_respons=a.User_respons;if(a.Type)h.register.Type=a.Type;if(a.BUKRS)h.register.BUKRS=a.BUKRS;if(a.Calend)h.register.Calend=a.Calend;const c=this.getBodyHierarchy(h.register);this.getModel("tree").setProperty(n.getContextByIndex(i).getPath(),h);o.update(`/v2_hierarquias(Profile='${c.Profile}',Instance=${c.Instance},NodeID='${c.NodeID}')`,c,{groupId:"updateFolderMass"});r++;t++;if(r===this.massBatchSize||t===e){this.submitChangesSync(o,"updateFolderMass").then(()=>{this.setProgress(t/e*100);if(t!==e)d(t);else{const e=this.getView().getModel("hierarchyChanges").getProperty("/");e.splice(0,e.length);this.onCloseChangeMassFolderDialog();this.getView().setBusy(false);this.closeDialogProgress();if(this._item)this.getModel().read(`/v2_pastas(Profile='${this._profile}',Instance=${this._instance},Item='${this._item}')`);s.show(this.getView().getModel("i18n").getResourceBundle().getText("appDataSaved"))}});return}}};d(t)}}.bind(this)})})},onDragStart:function(e){var t=this.byId("TreeTemplate");var i=e.getParameter("dragSession");var o=e.getParameter("target");var s=o.getIndex();var n=t.getSelectedIndices();var r=[];if(n.length>0){if(n.indexOf(s)===-1){e.preventDefault()}else{for(var a=0;a<n.length;a++){r.push(t.getContextByIndex(n[a]))}}}else{r.push(t.getContextByIndex(s))}i.setComplexData("hierarchymaintenance",{draggedRowContexts:r})},onDrop:function(e){const t=e.getParameters();var i=this.byId("TreeTemplate");var o=e.getParameter("dragSession");var s=e.getParameter("droppedControl");var n=o.getComplexData("hierarchymaintenance").draggedRowContexts;var r=i.getContextByIndex(s.getIndex());let a=false;if(n.length===0||!r){return}var l=i.getBinding().getModel();var d=r.getProperty();if(d.register.Item!=="X"&&t.dropPosition!=="Before"){for(var g=0;g<n.length;g++){if(r.getPath().indexOf(n[g].getPath())===0){continue}a=true;const e=n[g].getProperty();e.ParentNodeID=d.NodeID;e.parent=d;e.register.ParentNodeID=d.NodeID;const t=n[g].getObject();l.setProperty(n[g].getPath(),undefined,n[g],true);d.nodes.unshift(t)}this.recalculateHierarchyLevel(d.nodes);this.getView().getModel("tree").refresh()}else{for(var g=0;g<n.length;g++){if(r.getPath().indexOf(n[g].getPath())===0){continue}a=true;const e=n[g].getProperty();e.ParentNodeID=d.parent.NodeID;e.register.ParentNodeID=d.parent.NodeID;e.parent=d.parent;const i=n[g].getObject();l.setProperty(n[g].getPath(),undefined,n[g],true);if(t.dropPosition==="After"||t.dropPosition==="On")d.parent.nodes.splice(d.register.HierarchyLevel,0,i);else d.parent.nodes.splice(d.register.HierarchyLevel-1,0,i)}this.recalculateHierarchyLevel(d.parent.nodes);this.getView().getModel("tree").refresh()}if(a)if(!this.byId("detailPage").getShowFooter())this.byId("detailPage").setShowFooter(true)},recalculateHierarchyLevel:function(e){let t=0;const i=e.filter(function(e,t,i){return e!==undefined});e.length=0;e.push(...i);for(const i of e){if(i){i.register.HierarchyLevel=t+1;this.updateNode(i.register);t++}}},updateNode:function(e){if(!e.typeOfChange)e.typeOfChange="U";const t=this.getView().getModel("hierarchyChanges").getProperty("/");const i=t.find(t=>t.NodeID===e.NodeID);if(i){i.ParentNodeID=e.ParentNodeID;i.HierarchyLevel=e.HierarchyLevel}else{t.push(e)}this.getView().getModel("hierarchyChanges").setProperty("/",t)},onCutByMenuContext:function(e){this.onCopyByMenuContext(e);this.menuDeleteNode(e)},onDragDepStart:function(e){var t=this.byId("TreeTemplate");var i=e.getParameter("dragSession");var o=e.getParameter("target");var s=o.getIndex();var n=t.getSelectedIndices();var r=[];if(n.length>0){if(n.indexOf(s)===-1){e.preventDefault()}else{for(var a=0;a<n.length;a++){r.push(t.getContextByIndex(n[a]).getObject().register)}}}else{r.push(t.getContextByIndex(s).getObject().register)}i.setComplexData("movedep",{draggedRowContexts:r})},goToMainPage:function(){this.getView().getParent().getParent().removeAllBeginColumnPages();this.getRouter().navTo("main")}})});