"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(e,t)}function _iterableToArray(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,i=new Array(t);n<t;n++){i[n]=e[n]}return i}
/*!
 * SiGC - GestiÃ³n de Compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["com/innova/sigc/utils/isEmpty","com/innova/sigc/lib/formUtils/formUtils","com/innova/sigc/model/process/Vendor","com/innova/sigc/service/http","com/innova/sigc/utils/showToast","com/innova/sigc/model/constant","com/innova/sigc/model/process/VendorByHistory","com/innova/sigc/model/process/VendorByData","com/innova/sigc/service/petitions","com/innova/sigc/model/searchHelp/SearchHelp","sap/ui/core/Fragment","sap/ui/model/json/JSONModel"],function(e,t,n,i,r,o,a,s,d,l,u,c){return{onAddVendorButton:function e(){var n=this;var i=this.getView();u.load({id:i.getId(),name:"com.innova.sigc.view.biddingProcess.dialog.vendor.AddVendor",controller:this}).then(function(e){var r=e;i.addDependent(r);r.getEndButton().attachPress(r.close.bind(r));n._oAddVendorDialog=r;r.attachAfterClose(r.destroy.bind(r));n._oFormAddVendor=n.byId("byDataForm");t.addValidatorAllMultiInputs({fields:n._oFormAddVendor.getControlsByFieldGroupId("MultiInputGroup")});r.open()}).catch(this.errorHandler.bind(this))},onSearchVendor:function n(r,a){var l=this;var u=this.byId(a);if(a==="byDataForm"){Promise.resolve(this._oAddVendorDialog.setBusy(true)).then(this._isValidForm.bind(this,u)).then(t.getFormData.bind(t,u)).then(function(e){return new s(e)}).then(i.post.bind(i,o.api.GET_VENDOR_DATA_PATH)).then(function(t){var n=t.data;if(e(n)){throw new Error("No se encontraron datos")}var i=l._filterDataTable(n);if(e(i)){throw new Error("No hay proveedores disponibles")}l._oAddVendorDialog.setModel(new c({data:i}),"vendorsByData");l.byId("addVendorButton").setEnabled(true)}).catch(this.errorHandler.bind(this)).finally(this._oAddVendorDialog.setBusy.bind(this._oAddVendorDialog,false))}else{Promise.resolve(this._oAddVendorDialog.setBusy(true)).then(this._isValidForm.bind(this,u)).then(t.getFormData.bind(t,u)).then(this._buildDataRequest.bind(this)).then(d.post.bind(d,o.GET_VENDOR_HISTORY)).then(function(t){var n=t.data;if(e(n)){throw new Error(l._i18n.getText("Commons.0042"))}return n}).then(this._buildVendorsByIdRequest.bind(this)).then(function(t){var n=t.data;var i=l._filterDataTable(n);if(e(i)){throw new Error(l._i18n.getText("0138"))}l._oAddVendorDialog.setModel(new c({data:i}),"vendorsByHistory");l.byId("addVendorButton").setEnabled(true)}).catch(this.errorHandler.bind(this)).finally(this._oAddVendorDialog.setBusy.bind(this._oAddVendorDialog,false))}},onAddVendorHistory:function e(){var t=this;Promise.resolve(this._oAddVendorDialog.setBusy(true)).then(this._getSelectedVendors.bind(this)).then(this._buildOffersRequest.bind(this)).then(this._sendOffersHistory.bind(this)).then(this._fetchOffers.bind(this)).then(function(){r(t._i18n.getText("Commons.0021"));t._oFormModel.refresh(true);t.byId("vendorsTable").clearSelection();t._oAddVendorDialog.close()}).catch(this.errorHandler.bind(this)).finally(this._oAddVendorDialog.setBusy.bind(this._oAddVendorDialog,false))},onShowNewVendorDialog:function e(){var t=this;var n=this.getView();u.load({id:n.getId(),name:"com.innova.sigc.view.biddingProcess.dialog.vendor.NewVendor",controller:this}).then(function(e){var i=e;n.addDependent(i);i.getEndButton().attachPress(i.close.bind(i));t._oNewVendorDialog=i;t._oNewVendorDialog.setModel(new c({emails:[],phones:[],categories:[]}),"vendors");i.attachAfterClose(i.destroy.bind(i));i.open()})},onCreateVendorAndOffer:function e(){var t=this;Promise.resolve(this._oNewVendorDialog.setBusy(true)).then(this._validateFields.bind(this)).then(this._buildVendorRequest.bind(this)).then(i.post.bind(i,"".concat(o.api.VENDOR_PATH))).then(function(e){var n=e.data;t._iVendorId=n.idProv}).then(function(){return i.post("".concat(o.api.OFFERS_PATH),{processId:t._numProc,vendorId:t._iVendorId})}).then(this._fetchOffers.bind(this)).then(function(){r(t._i18n.getText("Commons.0021"));t.byId("vendorsTable").clearSelection();t._oNewVendorDialog.close()}).catch(this.errorHandler.bind(this)).finally(this._oNewVendorDialog.setBusy.bind(this._oNewVendorDialog,false))},onAddField:function e(t,n){var i=t.getParent();var r=i.getParent();var o=r.getBinding();var a=o.getModel();var s={index:Math.random(),smtpAddr:"",remark:"",telNumber:"",telExtens:"",id:""};a.setProperty("/".concat(n),[].concat(_toConsumableArray(a.getProperty("/".concat(n))),[s]));r.clearSelection()},onDeleteField:function e(t,n){var i=t.getParent();var r=i.getParent();var o=r.getBinding();var a=o.getModel();var s=r.getSelectedIndices();var d=a.getProperty("/".concat(n));s.forEach(function(e){var t=r.getContextByIndex(e);var n=t.getObject(),i=n.index;d=d.filter(function(e){return e.index!==i})});a.setProperty("/".concat(n),d);r.clearSelection()},onTypeEmail:function e(t){var n=t.getSource();var i=this.byId("saveVendorButton");var r=n.getValue();var o=/^\w+[\w-+.]*@\w+([-.]\w+)*\.[a-zA-Z]{2,}$/;if(r&&!o.test(r)){n.setValueState(sap.ui.core.ValueState.Warning);n.setValueStateText(this._i18n.getText("0179"));i.setEnabled(false)}else{n.setValueState(sap.ui.core.ValueState.None);i.setEnabled(true)}},onValidateName:function t(n,i){var r=n.getSource();var o=this.getView().byId("saveVendorButton");var a=r.getValue();if(e(a)){r.setValueState(sap.ui.core.ValueState.Error);r.setValueStateText("Debe digitar ".concat(i));o.setEnabled(false)}else{r.setValueState(sap.ui.core.ValueState.None);o.setEnabled(true)}},onCountryChange:function e(t){var n=this;var r=t.getSource().getSelectedKey();i.get("".concat(o.api.GET_REGIONS_HELP,"?land1=").concat(r),new l("REGIONS")).then(function(e){var t=e.data;n._oNewVendorDialog.getModel("vendors").setProperty("/regions",t)})},onSendInvitationsToVendors:function e(){Promise.resolve(this._oPage.setBusy(true)).then(this._getSelectedIndices.bind(this,this.byId("vendorsTable"))).then(this._validateSendIntationsToVendors.bind(this)).then(function(e){return e.map(function(e){return{angnr:e.getProperty("angnr")}})}).then(i.post.bind(i,o.api.VENDOR_INVITATION_PATH)).then(r.bind(r,this._i18n.getText("Commons.0021"))).then(this._fetchOffers.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onDeleteOffers:function t(){var n=this;Promise.resolve(this._oPage.setBusy(true)).then(this._getSelectedIndices.bind(this,this.byId("vendorsTable"))).then(function(e){return e.filter(function(e){return!e.getProperty("estaOfer")}).map(function(e){return{angnr:e.getProperty("angnr")}})}).then(function(t){return e(t)?Promise.reject(n._i18n.getText("0353")):t}).then(i.delete.bind(i,o.api.OFFER_DELETE_PATH)).then(this._clearVendorSection.bind(this)).then(r.bind(r,this._i18n.getText("Commons.0021"))).then(this._fetchOffers.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onShowEditVendorEmailsDialog:function e(t){var n=this;var i=t.getBindingContext("processModel");var r=i.getObject(),o=r.vendor,a=r.vendorId;var s=o.emails;var d=this.getView();u.load({id:d.getId(),name:"com.innova.sigc.view.biddingProcess.dialog.vendor.EditVendorEmails",controller:this}).then(function(e){var t=e;d.addDependent(t);t.getEndButton().attachPress(t.close.bind(t));n._oEditVendorEmailsDialog=t;n._oEditVendorEmailsDialog.setModel(new c({emails:s,vendorId:a}),"vendors");t.attachAfterClose(t.destroy.bind(t));t.open()})},onEditVendorEmails:function e(){var t=this;var n=this._oEditVendorEmailsDialog.getModel("vendors");var a=n.getProperty("/emails");var s=n.getProperty("/vendorId");Promise.resolve(this._oEditVendorEmailsDialog.setBusy.bind(this._oEditVendorEmailsDialog,true)).then(function(){t._validateEmailFields({list:a,i18n:t._i18n})}).then(i.post.bind(i,"".concat(o.api.VENDORS_PATH,"/").concat(s,"/").concat(o.api.EMAILS_PATH),{emails:a})).then(this._clearVendorSection.bind(this)).then(r.bind(r,this._i18n.getText("Commons.0021"))).then(this._fetchOffers.bind(this)).then(this._oEditVendorEmailsDialog.close.bind(this._oEditVendorEmailsDialog)).catch(this.errorHandler.bind(this)).finally(this._oEditVendorEmailsDialog.setBusy.bind(this._oEditVendorEmailsDialog,false))},_filterDataTable:function e(t){var n=this._oFormModel.getProperty("/offers");var i=n.map(function(e){return e.vendor.idProv});return t.filter(function(e){return!i.includes(e.idProv)})},_sendOffersHistory:function e(t){return t.reduce(function(e,t){return e.then(function(e){return t.then(function(t){return[].concat(_toConsumableArray(e),[t])})})},Promise.resolve([]))},_getSelectedVendors:function t(){var n=this.byId("vendorTable");var i=this.byId("vendor2Table");var r=n.getSelectedIndices();var o=i.getSelectedIndices();if(e(r)&&e(o)){throw new Error(this._i18n.getText("0139"))}var a=[];var s=[];r.forEach(function(e){var t=n.getContextByIndex(e);var i=t.getObject();a.push(i)});o.forEach(function(e){var t=i.getContextByIndex(e);var n=t.getObject();s.push(n)});a=a.concat(s);return a},_buildOffersRequest:function e(t){var n=this;var r=[];t.forEach(function(e){r.push(i.post("".concat(o.api.OFFERS_PATH),{processId:n._numProc,vendorId:e.idProv}))});return r},_searchVendorId:function e(t){return t.reduce(function(e,t){return e.then(function(e){return t.then(function(t){return[].concat(_toConsumableArray(e),[t])})})},Promise.resolve([]))},_buildVendorsByIdRequest:function e(t){return i.post("".concat(o.api.VENDOR_ID_PATH),{lifnr:t.map(function(e){return e.LIFNR})})},_buildDataRequest:function e(n){var i={matnr:t.getMultiInputDataVendor(n.matnr),matkl:t.getMultiInputDataVendor(n.matkl),ekorg:t.getMultiInputDataVendor(n.ekorg),txz01:t.getMultiInputDataVendor(n.txz01?[n.txz01]:[]),date:n.date};return new a(i)},_validateFields:function e(){var t=this.byId("oINombre1");var n=this.byId("oIPais");var i=this.byId("oIFiscalId");var r=this.byId("oITipoIdFiscal");this._oListEmails=this.byId("emailTable").getBinding().oList;this._oListPhones=this.byId("phoneTable").getBinding().oList;this._oListCategories=this.byId("categoryTable").getBinding().oList;this._validateInputField({input:t,valueStateText:this._i18n.getText("0106")});this._validateComboBoxFields({comboBox:r,valueStateText:this._i18n.getText("0178")});this._validateInputField({input:i,valueStateText:this._i18n.getText("0177")});this._validateInputField({input:n,valueStateText:this._i18n.getText("0107")});this._validateEmailFields({list:this._oListEmails,i18n:this._i18n});this._validatePhoneFields({list:this._oListPhones,i18n:this._i18n});this._validateCategoryFields({list:this._oListCategories,i18n:this._i18n})},_validateInputField:function t(n){var i=n.input,r=n.valueStateText;var o=i.getValue();i.setValueState(sap.ui.core.ValueState.None);if(e(o)){i.setValueState(sap.ui.core.ValueState.Error);i.setValueStateText(r);throw new Error(r)}},_validateComboBoxFields:function t(n){var i=n.comboBox,r=n.valueStateText;var o=i.getSelectedKey();i.setValueState(sap.ui.core.ValueState.None);if(e(o)){i.setValueState(sap.ui.core.ValueState.Error);i.setValueStateText(r);throw new Error(r)}},_validateEmailFields:function t(n){var i=n.list,r=n.i18n;if(e(i)){throw new Error(r.getText("0108"))}if(!this._validateEmails(i)){throw new Error(r.getText("0109"))}},_validatePhoneFields:function t(n){var i=n.list,r=n.i18n;if(!e(i)){if(!this._validatePhones(i)){throw new Error(r.getText("0119"))}}},_validateCategoryFields:function t(n){var i=n.list,r=n.i18n;if(!e(i)){if(!this._validateCategories(i)){throw new Error(r.getText("0120"))}}},_buildVendorRequest:function e(){this._oListPhones=this.byId("phoneTable").getBinding().oList;this._oListCategories=this.byId("categoryTable").getBinding().oList;var t=this.byId("oINombre1");var i=this.byId("oINombre2");var r=this.byId("oIPoblacion");var o=this.byId("oIDistrito");var a=this.byId("oICalle");var s=this.byId("oICriterioBusqueda");var d=this.byId("oIEdificio");var l=this.byId("oICodigoPostal");var u=this.byId("oIPais");var c=this.byId("oICiudad");var h=this.byId("oIFiscalId");var f=this.byId("oIFiscalId2");var v=this.byId("oITipoIdFiscal");var g=this.byId("oIIdioma");var b=[];var _=[];var y=[];this._oListCategories.forEach(function(e){b.push({id:parseInt(e.id,10)})});this._oListPhones.forEach(function(e){_.push({telNumber:e.telNumber,telExtens:e.telExtens})});this._oListEmails.forEach(function(e){y.push({smtpAddr:e.smtpAddr,remark:e.remark})});return new n({idProv:1152469087,name1:t.getValue()||null,name2:i.getValue()||null,city1:r.getValue()||null,city2:o.getValue()||null,street:a.getValue()||null,postCode1:l.getValue()||null,houseNum1:d.getValue()||null,country:u.getSelectedKey()||null,region:c.getSelectedKey()||null,sort1:s.getValue()||null,stcd1:h.getValue()||null,stcd2:f.getValue()||null,spras:g.getSelectedKey()||null,stcdt:v.getSelectedKey()||null,emails:y,phones:_,category:b})},_validateEmails:function t(n){var i=true;n.forEach(function(t){if(e(t.smtpAddr)){i=false}});return i},_validatePhones:function t(n){var i=true;n.forEach(function(t){if(e(t.telNumber)){i=false}});return i},_validateCategories:function t(n){var i=true;n.forEach(function(t){if(e(t.id)){i=false}});return i},_buildInvitationRequest:function e(){var t=this;var n=[];this._oListEmails.forEach(function(e){n.push(i.post.bind(i,"".concat(o.api.VENDOR_INVITATION_PATH),{vendorId:t._iVendorId,email:e.smtpAddr}))});return n},_sendInvitations:function e(t){return t.reduce(function(e,t){return e.then(function(e){return t().then(function(t){return[].concat(_toConsumableArray(e),[t])})})},Promise.resolve([]))},_clearVendorSection:function e(){this._oFormModel.setProperty("/offers",[]);this.byId("vendorsTable").clearSelection()},_validateSendIntationsToVendors:function t(n){var i=n.filter(function(e){return!e.getProperty("estaOfer")});if(e(i)){this.byId("vendorsTable").clearSelection();throw new Error(this._i18n.getText("0372"))}return i}}});