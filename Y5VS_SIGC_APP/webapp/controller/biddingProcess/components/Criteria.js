"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _arrayLikeToArray(e,t)}function _iterableToArray(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,r=new Array(t);i<t;i++){r[i]=e[i]}return r}function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach(function(t){_defineProperty(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function _defineProperty(e,t,i){if(t in e){Object.defineProperty(e,t,{value:i,enumerable:true,configurable:true,writable:true})}else{e[t]=i}return e}
/*!
 * SiGC - GestiÃ³n de Compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["com/innova/sigc/lib/formUtils/formUtils","com/innova/sigc/model/constant","com/innova/sigc/model/process/EntProvEvaluationCriteria","com/innova/sigc/model/process/EvaluationCriteria","com/innova/sigc/model/process/LevelEvaluationCriteria","com/innova/sigc/model/process/TypesEvaluationCriteria","com/innova/sigc/model/process/ValoracionEvaluationCriteria","com/innova/sigc/service/http","com/innova/sigc/utils/checkIfNumberBetween","com/innova/sigc/utils/getSelectedRowsContext","com/innova/sigc/utils/isEmpty","com/innova/sigc/utils/showToast","com/innova/sigc/utils/sumPropPesoValor","com/innova/vendor/lodash.filter","sap/ui/core/Fragment"],function(e,t,i,r,a,o,n,s,l,u,c,d,v,h,p){return{onShowNewEvaluationCriteriaDialog:function e(t){var i=this;this._validateTechnicalEvaluator({type:t}).then(this._getEvaluationCriteriaDialog.bind(this,{type:t})).then(function(e){var r=e;var a=r.getBeginButton();var o=i.getResourceBundle().getText("Commons.0005");a.setText(o);a.setTooltip(o);a.attachPress(i._createEvaluationCriteria.bind(i,{type:t}));i._oNewEvaluationCriteriaDialog=r;i._oNewEvaluationCriteriaDialog.unbindElement();i._oNewEvaluationCriteriaDialog.open()}).catch(this.errorHandler.bind(this))},onEditEvaluationCriteria:function e(t,i){var r=this;var a=t.getBindingContext("processModel");var o=a.getPath();this._getEvaluationCriteriaDialog({type:i}).then(function(e){var t=e;var a=t.getBeginButton();var n=r.getResourceBundle().getText("Commons.0017");a.setText(n);a.setTooltip(n);a.attachPress(r._updateEvaluationCriteria.bind(r,{path:o,type:i}));r._oNewEvaluationCriteriaDialog=t;r._oNewEvaluationCriteriaDialog.unbindElement();r._oNewEvaluationCriteriaDialog.bindElement({path:o,model:"processModel"});r._oNewEvaluationCriteriaDialog.open()})},onDeleteEvaluationCriteria:function e(i){var r=this;Promise.resolve(this._oPage.setBusy(true)).then(this._getSelectedIndices.bind(this,i.getParent().getParent())).then(function(e){r._deleteEvaluationCriteriaIds=e.map(function(e){return e.getProperty("id")});return s.delete("".concat(t.api.EVALUATION_CRITERIA_PATH),r._deleteEvaluationCriteriaIds)}).then(function(){r._deleteBindingRows({path:"/evaluationCriteria",ids:r._deleteEvaluationCriteriaIds});r._sumOfEvaluationCriteria(r._oFormModel.getProperty("/evaluationCriteria"))}).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onCreateEvaluationCriteriaForPrice:function e(){var s=this;var l=this.byId("pesoValorPrice");var u=l.getValue();Promise.resolve(this._oPage.setBusy(true)).then(function(){l.setValueState(sap.ui.core.ValueState.None);if(c(u)){l.setValueState(sap.ui.core.ValueState.Error);throw new Error(s.getResourceBundle().getText("Commons.0027"))}}).then(function(){return new r({tipo:o.C,criterio:t.CRITERIA_PRICE_KEY,valoracion:n.Y.key,pesoValor:u,user:s.byId("userPrice").getValue(),indCabPos:a.P.key,entradaProveedor:i.B.key,processId:s._numProc})}).then(this._createOrUpdateEvaluationCriteriaForPrice.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onPesoValorChange:function e(t){try{var i;var r=(i=this._oNewEvaluationCriteriaDialog)===null||i===void 0?void 0:i.getBeginButton();t.setValueState(sap.ui.core.ValueState.None);r.setEnabled(true);this._checkInputValuePesoValor({input:t,button:r});var a=this._sumOfEvaluationCriteriaByType({input:t,button:r,type:this._oNewEvaluationCriteriaDialog.data("type")});this._isGreaterThan100({input:t,button:r,sum:a})}catch(e){this.errorHandler(e)}},onPesoChange:function e(i){try{var r=this.byId("priceButton");i.setValueState(sap.ui.core.ValueState.None);r.setEnabled(true);this._checkInputValuePesoValor({input:i,button:r});var o=i.getValue();var n=this._oFormModel.getProperty("/evaluationCriteria").filter(function(e){var i=e.tipo,r=e.criterio;return i===a.C.key&&r!==t.CRITERIA_PRICE_KEY});var s=n===null||n===void 0?void 0:n.reduce(v,parseFloat(o));this._isGreaterThan100({input:i,button:r,sum:s})}catch(e){this.errorHandler(e)}},onSendTechnicalInvitation:function e(){this._oPage.setBusy(true);var i=this.byId("technicalCriteriaTable");u(i,{i18n:this._i18n}).then(this._buildReqTechnicalInvitations.bind(this)).then(s.post.bind(s,"".concat(t.api.PROCESS_PATH,"/").concat(this._numProc,"/technical-invitation"))).then(d.bind(d,this._i18n.getText("Commons.0021"))).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onValoracionChange:function e(t){var i=t.getSelectedKey();var r=this.byId("entradaProveedorComboBox");var a=r.getBinding("items");if(i===n.Y.key||i===n.Z.key){a.filter([new sap.ui.model.Filter({path:"key",operator:sap.ui.model.FilterOperator.EQ,value1:"B"},false),new sap.ui.model.Filter({path:"key",operator:sap.ui.model.FilterOperator.EQ,value1:"D"},false)])}else{a.filter([])}r.setEditable(!c(i));r.setSelectedKey()},onChangeEvaluationRadioButton:function e(i){var r=i.getSource();Promise.resolve(this._oPage.setBusy(true)).then(s.update.bind(s,"".concat(t.api.PROCESS_PATH,"/").concat(this._numProc),{evaluationMethod:r.getSelectedIndex()})).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},_sumOfEvaluationCriteria:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i=h(t,{tipo:o.C});var r=h(t,{tipo:o.T});var a=i===null||i===void 0?void 0:i.reduce(v,0);var n=r===null||r===void 0?void 0:r.reduce(v,0);this._oFormModel.setProperty("/sumTechEval",n);this._oFormModel.setProperty("/sumCommercialEval",a);return{sumCommercialEval:a,sumTechEval:n}},_buildEvaluationCriteria:function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var r=i.findIndex(function(e){return e.criterio===t.CRITERIA_PRICE_KEY&&e.tipo===o.C});if(r!==-1){var a,n;var s=i[r];var l=s?this.getResourceBundle().getText("Commons.0017"):this.getResourceBundle().getText("Commons.0005");var u=(a=s===null||s===void 0?void 0:s.pesoValor)!==null&&a!==void 0?a:"";var c=(n=s===null||s===void 0?void 0:s.user)!==null&&n!==void 0?n:"";var d=this.byId("pesoValorPrice");d.setValue(u);d.setValueState(sap.ui.core.ValueState.None);this.byId("userPrice").setValue(c);var v=this.byId("priceButton");v.setText(l);v.setTooltip(l)}},_createEvaluationCriteria:function i(a){var n=this;var l=a.type;var u=this.byId("evaluationCriteriaForm");Promise.resolve(this._oNewEvaluationCriteriaDialog.setBusy(true)).then(this._isValidForm.bind(this,u)).then(e.getFormData.bind(e,u)).then(function(e){return new r(_objectSpread(_objectSpread({},e),{},{tipo:o[l],user:l==="T"?n._oFormModel.getProperty("/respTecnico"):"",processId:n._numProc}))}).then(s.post.bind(s,t.api.EVALUATION_CRITERIA_PATH)).then(this._addEvaluationCriteriaModel.bind(this)).then(this._oNewEvaluationCriteriaDialog.close.bind(this._oNewEvaluationCriteriaDialog)).catch(this.errorHandler.bind(this)).finally(this._oNewEvaluationCriteriaDialog.setBusy.bind(this._oNewEvaluationCriteriaDialog,false))},_addEvaluationCriteriaModel:function e(t){var i=t.data;this._oFormModel.setProperty("/evaluationCriteria",[].concat(_toConsumableArray(this._oFormModel.getProperty("/evaluationCriteria")),[i]));this._sumOfEvaluationCriteria(this._oFormModel.getProperty("/evaluationCriteria"));d(this.getResourceBundle().getText("Commons.0021"))},_updateEvaluationCriteria:function i(a){var n=a.path,l=a.type;var u=this.byId("evaluationCriteriaForm");var c=this._oFormModel.getProperty("".concat(n,"/id"));Promise.resolve(this._oNewEvaluationCriteriaDialog.setBusy(true)).then(this._isValidForm.bind(this,u)).then(e.getFormData.bind(e,u)).then(function(e){return new r(_objectSpread({tipo:o[l]},e))}).then(s.update.bind(s,"".concat(t.api.EVALUATION_CRITERIA_PATH,"/").concat(c))).then(this._updateEvaluationCriteriaModel.bind(this,n)).then(this._oNewEvaluationCriteriaDialog.close.bind(this._oNewEvaluationCriteriaDialog)).catch(this.errorHandler.bind(this)).finally(this._oNewEvaluationCriteriaDialog.setBusy.bind(this._oNewEvaluationCriteriaDialog,false))},_updateEvaluationCriteriaModel:function e(t,i){var r;var a=i.data;this._oFormModel.setProperty("".concat(t),a);this._sumOfEvaluationCriteria(this._oFormModel.getProperty("/evaluationCriteria"));d(this.getResourceBundle().getText("Commons.0021"));(r=this._oNewEvaluationCriteriaDialog)===null||r===void 0?void 0:r.close()},_getEvaluationCriteriaDialog:function e(t){var i=this;var r=t.type;var a=this.getView();return p.load({id:a.getId(),name:"com.innova.sigc.view.biddingProcess.dialog.criteria.NewEvaluationCriteria".concat(r),controller:this}).then(function(e){var t=e;a.addDependent(t);t.getEndButton().attachPress(t.close.bind(t));t.attachAfterClose(function(){i._oNewEvaluationCriteriaDialog=undefined;t.destroy()});t.data("type",r);return t})},_checkInputValuePesoValor:function e(t){var i=t.input,r=t.button;var a=i.getValue();var o=l(a,0,100);if(!o){r===null||r===void 0?void 0:r.setEnabled(false);i.setValue(undefined);i.setValueState(sap.ui.core.ValueState.Error);throw new Error(this.getResourceBundle().getText("0092"))}},_sumOfEvaluationCriteriaByType:function e(t){var i;var r=t.input,a=t.type;var n=r.getValue();var s=h(this._oFormModel.getProperty("/evaluationCriteria"),{tipo:o["".concat(a)]});if(r.getBindingContext("processModel")){s=s.filter(function(e){var t=e.id;return t!==r.getBindingContext("processModel").getProperty("id")})}return(i=s)===null||i===void 0?void 0:i.reduce(v,parseFloat(n))},_isGreaterThan100:function e(t){var i=t.sum,r=t.button,a=t.input;if(i>100){r.setEnabled(false);a.setValue(undefined);a.setValueState(sap.ui.core.ValueState.Error);throw new Error(this.getResourceBundle().getText("0093"))}},_createOrUpdateEvaluationCriteriaForPrice:function e(i){var r=this._oFormModel.getProperty("/evaluationCriteria");var a=r.findIndex(function(e){return e.criterio===t.CRITERIA_PRICE_KEY&&e.tipo===o.C});if(a!==-1){var n=r[a].id;return s.update("".concat(t.api.EVALUATION_CRITERIA_PATH,"/").concat(n),i).then(this._updateEvaluationCriteriaModel.bind(this,"/evaluationCriteria/".concat(a)))}var l=this.byId("priceButton");return s.post(t.api.EVALUATION_CRITERIA_PATH,i).then(this._addEvaluationCriteriaModel.bind(this)).then(l.setText.bind(l,this.getResourceBundle().getText("Commons.0017")))},_loadItemsUser:function e(){var i=this;return s.get(t.api.EVALUATORS_PATH).then(function(e){var t=e.data;i._oFormModel.setProperty("/valueHelp/respTecnico",t.filter(function(e){var t=e.role,i=e.status;return t.includes("TECHNICAL_EVALUATOR")&&i==="Verified"}))})},_buildReqTechnicalInvitations:function e(t){var i=t.filter(function(e){var t=e.object;return!c(t.user)}).map(function(e){var t=e.object;return t.user});if(c(i)){throw new Error(this._i18n.getText("Commons.0037"))}return{users_id:i}},_validateTechnicalEvaluator:function e(t){var i=t.type;if(i==="T"&&c(this._oFormModel.getProperty("/respTecnico"))){return Promise.reject(new Error(this._i18n.getText("0373")))}return Promise.resolve()}}});