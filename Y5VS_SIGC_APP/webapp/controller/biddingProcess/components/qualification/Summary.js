"use strict";function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,o)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _defineProperty(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(e,t)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,o=new Array(t);n<t;n++){o[n]=e[n]}return o}function _iterableToArrayLimit(e,t){var n=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(n==null)return;var o=[];var r=true;var i=false;var a,s;try{for(n=n.call(e);!(r=(a=n.next()).done);r=true){o.push(a.value);if(t&&o.length===t)break}}catch(e){i=true;s=e}finally{try{if(!r&&n["return"]!=null)n["return"]()}finally{if(i)throw s}}return o}function _arrayWithHoles(e){if(Array.isArray(e))return e}sap.ui.define(["com/innova/sigc/factory/summaryQualification/qualification","com/innova/sigc/lib/richTextEditor/editor","com/innova/sigc/formatter/formatMessage","com/innova/sigc/model/constant","com/innova/sigc/model/process/roundsProcessStatus/RoundsProcessStatus","com/innova/sigc/model/offer/offerStatus/useOfferStatus","com/innova/sigc/model/process/processStatus/useProcessStatus","com/innova/sigc/service/http","com/innova/sigc/utils/isEmpty","com/innova/sigc/utils/keyBy","com/innova/sigc/utils/showToast","com/innova/vendor/lodash.filter","com/innova/vendor/lodash.find","com/innova/vendor/lodash.get","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/Sorter"],function(e,t,n,o,r,i,a,s,c,u,l,d,f,v,m,p,h,g){return{onExpandSelection:function e(t){var n=this.byId(t);var o=n.getSelectedIndices();if(c(o)){n.expandToLevel(1)}else{n.expand(o)}},onCollapseSelection:function e(t){var n=this.byId(t);var o=n.getSelectedIndices();if(c(o)){n.collapseAll()}else{n.collapse(o)}},onWinnerOfferButtonPress:function e(t){var r=this;var i=t.offerId,a=t.vendorName,c=t.isPartialProcess,u=t.hasPositionsRejected;if(u){l(this._i18n.getText("0361"));return}if(c){l(this._i18n.getText("0358"));return}m.success(n(this._i18n.getText("0279"),a),{actions:[this._i18n.getText("Commons.0003"),this._i18n.getText("Commons.0004")],emphasizedAction:m.Action.OK,onClose:function e(t){if(t===r._i18n.getText("Commons.0003")){Promise.resolve(r._oPage.setBusy(true)).then(s.post.bind(r,"".concat(o.api.OFFERS_PATH,"/").concat(i,"/winner"),{})).then(function(){l(r._i18n.getText("Commons.0021"))}).then(r._fetchAPI.bind(r,r._numProc)).then(r._fetchOffers.bind(r)).then(r._fetchQualificationSummary.bind(r)).catch(r.errorHandler.bind(r)).finally(r._oPage.setBusy.bind(r._oPage,false))}}})},onDeclineOfferButtonPress:function e(){m.show(this._i18n.getText("0280"),{actions:[m.Action.OK,m.Action.CANCEL],emphasizedAction:m.Action.OK,onClose:function e(t){sap.m.MessageToast.show("Action selected: ".concat(t))}})},onCantAsigChange:function e(t,n){var o=t.cantOfer;var r=n.getSource();var i=+r.getValue();var a=r.getBindingContext();var s=a.getPath();var c=a.getModel();var u=s.split("qualifications"),d=_slicedToArray(u,1),f=d[0];var v=this._getCantAsignByEvaluator({value:i,cantOfer:o});var m=c.getProperty("".concat(f,"menge"));var p=this._sumAllCantAsig({qualifications:c.getProperty("".concat(f,"qualifications")),currentQualification:c.getProperty(s)});if(p+v>m){var h;l(this._i18n.getText("0357"));v=(h=c.getProperty("".concat(s,"/value")))!==null&&h!==void 0?h:0;c.setProperty("".concat(s,"/value"),v)}else{var g;var y=c.getProperty("".concat(f,"updatedCantAsig"));y=(g=y)!==null&&g!==void 0?g:[];y=[].concat(_toConsumableArray(y),[{offerId:a.getProperty("offerId"),processPositionId:a.getProperty("processPositionId"),cantAsig:v}]);c.setProperty("".concat(s,"/value"),v);c.setProperty("".concat(f,"updated"),true);c.setProperty("".concat(f,"updatedCantAsig"),y)}c.updateBindings(true);c.refresh()},onSaveCantOferByPos:function e(){var t=this;Promise.resolve(this._oPage.setBusy(true)).then(this._getUpdatedRowsCantAsig.bind(this)).then(s.post.bind(this,"".concat(o.api.POSITION_OFFERS_CANT_ASIGN_PATH))).then(function(){l(t._i18n.getText("Commons.0021"))}).then(this._fetchAPI.bind(this,this._numProc)).then(this._fetchOffers.bind(this)).then(this._fetchQualificationSummary.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onUndoWinningOfferButtonPress:function e(t){var r=this;var i=t.vendorName,a=t.offerId;m.confirm(n(this._i18n.getText("0310"),i),{actions:[this._i18n.getText("Commons.0003"),this._i18n.getText("Commons.0004")],emphasizedAction:m.Action.OK,onClose:function e(t){if(t===r._i18n.getText("Commons.0003")){Promise.resolve(r._oPage.setBusy(true)).then(s.post.bind(r,"".concat(o.api.OFFERS_RESET_PATH),[{angnr:a}])).then(function(){l(r._i18n.getText("Commons.0021"))}).then(r._fetchAPI.bind(r,r._numProc)).then(r._fetchOffers.bind(r)).then(r._fetchQualificationSummary.bind(r)).catch(r.errorHandler.bind(r)).finally(r._oPage.setBusy.bind(r._oPage,false))}}})},onNewRoundDialog:function e(){Promise.resolve(this._oPage.setBusy(true)).then(this._fetchOffers.bind(this)).then(this._buildOffersFromRound.bind(this)).then(this._openNewRoundDialog.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onNewRound:function e(){var t=this;m.confirm(this._i18n.getText("0346"),{actions:[this._i18n.getText("Commons.0003"),this._i18n.getText("Commons.0004")],emphasizedAction:m.Action.OK,onClose:function e(n){if(n===t._i18n.getText("Commons.0003")){var r;Promise.resolve(t._oNewRoundDialog.setBusy(true)).then(t._getSelectedItems.bind(t,t.byId("newRoundTable"))).then(t._buildReqNewRound.bind(t,{message:t._oNewRoundEditor.getContent(),fechaLimite:(r=t.byId("limOfertaNewRound").getDateValue())===null||r===void 0?void 0:r.toISOString()})).then(s.post.bind(s,"".concat(o.api.PROCESS_PATH,"/").concat(t._numProc,"/new-round"))).then(t._fetchAPI.bind(t,t._numProc)).then(t._fetchOffers.bind(t)).then(t._fetchQualificationSummary.bind(t)).then(function(){l(t._i18n.getText("Commons.0021"));t._oNewRoundDialog.close()}).catch(t.errorHandler.bind(t)).finally(t._oNewRoundDialog.setBusy.bind(t._oNewRoundDialog,false))}}})},_fetchQualificationSummary:function e(){var t=this._oFormModel.getData();var n=t.waers,r=t.conversionCurrency,i=t.offers;if(c(i)){return Promise.resolve()}var a=this._fetchWithCurrentWaers({waers:n});if(!c(r)){a=this._fetchWithConversionCurrency({conversionCurrency:r,offers:i,conversionDate:t.conversionDate})}return a.then(s.post.bind(s,"".concat(o.api.PROCESS_PATH,"/").concat(this._numProc,"/").concat(o.api.GLOBAL_CALIFICATION))).then(this._handleResponseQualificationSummary.bind(this))},_fetchWithCurrentWaers:function e(t){var n=t.waers;return Promise.resolve({currencyBase:n,rates:[{currency:n,value:1}]})},_handleResponseQualificationSummary:function e(t){var n=t.data;this._buildSummaryQualifications(this._oFormModel.getData(),n)},_buildSummaryQualifications:function e(t,n){var o=d(v(t,"offers",[]),{estaOfer:true});var i=v(t,"positions",[]);var s=v(t,"roundsProcess",[]);var c=v(t,"waers","");var u=v(t,"conversionCurrency","");var l=f(s,{estatusRonda:r.ABIERTO.status});var m=this._getDefaultQualificationColumns(),p=_slicedToArray(m,3),h=p[2];var g=v(t,"status","");var y=a.isAdjudication(g);var _=a.isPartialAdjudication(g);this.byId("roundTitle").setText("".concat(this._i18n.getText("0311")," #").concat(l.round));this._buildSummaryQualificationsByHeader({conversionCurrency:u,globalQualifications:n,isPartialProcess:_,isWinningProcess:y,offers:o,processStatus:g,waers:c});this._buildSummaryQualificationsByPos({columns:h,globalQualifications:n,isPartialProcess:_,isWinningProcess:y,offers:o,processPositions:i,processStatus:g,round:l})},_buildSummaryQualificationsByHeader:function t(n){var o=this;var r=n.conversionCurrency,s=n.globalQualifications,l=n.isPartialProcess,d=n.isWinningProcess,f=n.offers,m=n.processStatus,p=n.waers;var y=[{label:this._i18n.getText("0176"),name:"name",template:"name"}];var _=this._getGlobalQualificationMax(s);var b=u(s,"id");var P=[{name:this._i18n.getText("0248")},{name:this._i18n.getText("0249")},{name:this._i18n.getText("0250")},{name:this._i18n.getText("0251")},{name:this._i18n.getText("0356")},{name:this._i18n.getText("Commons.0036")}];f.forEach(function(e){var t,n,s,u,f,h,g;var T=(t=b[e.angnr])!==null&&t!==void 0?t:{},S=T.global;var A=v(e,"vendor.idProv","");var O=v(e,"positions",[]);var w=v(e,"status","");var I=v(e,"statusEvaluatorType","");var C={offerId:e.angnr,vendorId:A,label:v(e,"vendor.name1",""),name:A,template:"Custom",offerStatus:w,processStatus:m};y.push(C);var R={offerStatus:w,offerStatusType:I,processStatus:m};P=[_objectSpread(_objectSpread({},(n=P)===null||n===void 0?void 0:n[0]),{},_defineProperty({},C.name,[{type:"Qualifications",value:v(S,"tecnical",0),status:R,highest:_.tecnical}])),_objectSpread(_objectSpread({},(s=P)===null||s===void 0?void 0:s[1]),{},_defineProperty({},C.name,[{type:"Qualifications",value:v(S,"comercial",0),status:R,highest:_.comercial}])),_objectSpread(_objectSpread({},(u=P)===null||u===void 0?void 0:u[2]),{},_defineProperty({},C.name,[{type:"Qualifications",value:v(S,"total",0),status:R,highest:_.total}])),_objectSpread(_objectSpread({},(f=P)===null||f===void 0?void 0:f[3]),{},_defineProperty({posProc:o.getResourceBundle().getText("0133")},C.name,[{type:"Total",value:v(S,"offerValue",0),offerId:e.angnr,vendorName:v(e,"vendor.name1",""),status:R,waers:p||r}])),_objectSpread(_objectSpread({},(h=P)===null||h===void 0?void 0:h[4]),{},_defineProperty({posProc:o.getResourceBundle().getText("0133")},C.name,[{type:"PurchaseOrder",value:v(e,"purchaseOrder",""),offerId:e.angnr,vendorName:v(e,"vendor.name1",""),status:R}])),_objectSpread(_objectSpread({},(g=P)===null||g===void 0?void 0:g[5]),{},_defineProperty({},C.name,[{type:"Operations",offerId:e.angnr,vendorName:v(e,"vendor.name1",""),status:R,isTotalWinningOffer:i.isTotalWinningOffer(w),isPartialOffer:!c(O)&&!O.every(function(e){var t=e.status;return c(t)||i.isPositionRejected(t)}),isWinningOfferForPositions:!c(O)&&O.every(function(e){var t=e.status;return i.isWinningPosition(t)}),isWinningProcess:d,isPartialProcess:l,isOfferRejected:i.isOfferRejected(w),hasPositionsRejected:!c(O)&&O.some(function(e){var t=e.status;return i.isPositionRejected(t)}),hasPurchaseOrder:a.inPurchaseOrder(m)}]))]});var T=this.byId("summaryHeaderPanel");T.setHeaderText("".concat(this.getResourceBundle().getText("0082")," (").concat(s.length,")"));this.byId("summaryHeaderTreeTable").bindColumns({path:"/columns",sorter:new g("id"),factory:e.bindColumnsToTreeTable.bind(this)}).bindRows({path:"/rows"}).setModel(new h({columns:y,rows:P}))},_buildSummaryQualificationsByPos:function t(n){var o=this;var r=n.columns,i=n.globalQualifications,a=n.isWinningProcess,s=n.offers,c=n.processPositions,l=n.processStatus,d=n.round;var m=JSON.parse(JSON.stringify(c));var p=u(i,"id");s.forEach(function(e){var t;var n=(t=p[e.angnr])!==null&&t!==void 0?t:{},i=n.positions,s=i===void 0?[]:i;var c=v(e,"vendor.idProv","");var u=v(e,"pricesPerRound",[]);var h=v(e,"positions",[]);var g=v(e,"status","");var y=v(e,"statusEvaluatorType","");var _={offerId:e.angnr,vendorId:c,label:v(e,"vendor.name1",""),name:c,template:"Custom",offerStatus:g,processStatus:l};r.push(_);m=m.map(function(t){var n,r,i,m,p,_,b;var P=f(u,{positionId:t.id,roundId:d.roundId});var T=f(h,{positionId:t.id});var S=f(s,{processPositionId:t.id});var A={offerStatus:g,offerStatusType:y,positionStatus:T===null||T===void 0?void 0:T.status,positionStatusType:T===null||T===void 0?void 0:T.statusEvaluatorType,processStatus:l};return _objectSpread(_objectSpread({},t),{},(b={},_defineProperty(b,"".concat(c),[{type:"Qualifications",value:v(S,"califications.total",0),status:A}]),_defineProperty(b,"qualifications",[_objectSpread(_objectSpread({},t===null||t===void 0?void 0:(n=t.qualifications)===null||n===void 0?void 0:n[0]),{},_defineProperty({posProc:o.getResourceBundle().getText("0133")},"".concat(c),[{type:"Qualifications",value:v(S,"califications.comercial",0),status:A}])),_objectSpread(_objectSpread({},t===null||t===void 0?void 0:(r=t.qualifications)===null||r===void 0?void 0:r[1]),{},_defineProperty({posProc:o.getResourceBundle().getText("0130")},"".concat(c),[{type:"Qualifications",value:v(S,"califications.tecnical",0),status:A}])),_objectSpread(_objectSpread({},t===null||t===void 0?void 0:(i=t.qualifications)===null||i===void 0?void 0:i[2]),{},(m={posProc:o.getResourceBundle().getText("0140")},_defineProperty(m,"".concat(c),[{type:"price",price:P,menge:t.menge,status:A}]),_defineProperty(m,"type","price"),m)),_objectSpread(_objectSpread({},t===null||t===void 0?void 0:(p=t.qualifications)===null||p===void 0?void 0:p[3]),{},_defineProperty({posProc:o.getResourceBundle().getText("0144")},"".concat(c),[{type:"cantOfer",cantOfer:T===null||T===void 0?void 0:T.cantOfer,meins:t.meins,status:A}])),_objectSpread(_objectSpread({},t===null||t===void 0?void 0:(_=t.qualifications)===null||_===void 0?void 0:_[4]),{},_defineProperty({posProc:o.getResourceBundle().getText("0145"),type:"cantAsig"},"".concat(c),[{type:"cantAsig",value:T===null||T===void 0?void 0:T.cantAsig,cantOfer:T===null||T===void 0?void 0:T.cantOfer,isWinningProcess:a,offerId:e.angnr,processPositionId:t.id,status:A}]))]),b))})});this.byId("summaryPositionTreeTable").unbindColumns().unbindRows().bindColumns({path:"/columns",sorter:new g("id"),factory:e.bindColumnsToTreeTable.bind(this)}).bindRows({path:"/rows",parameters:{arrayNames:["qualifications"],numberOfExpandedLevels:"/numberOfExpandedLevels",rootLevel:1}}).setModel(new h({columns:r,rows:m}))},_getUpdatedRowsCantAsig:function e(){var t;var n=this.byId("summaryPositionTreeTable").getModel();var o=n.getProperty("/rows");var r=(t=d(o,{updated:true}))!==null&&t!==void 0?t:[];if(!r.length){throw new Error(this._i18n.getText("Commons.0035"))}return r.reduce(function(e,t){return e.concat(t.updatedCantAsig)},[])},_buildOffersFromRound:function e(){var t=this._oFormModel.getProperty("/offers");var n=d(t,{estaOfer:true}).filter(function(e){var t=e.status;return!i.isPositionRejected(t)});if(!n.length){throw new Error(this._i18n.getText("0313"))}return{offers:n,hasPartialWinner:n.some(function(e){var t=e.status;return i.isPartialWinner(t)})}},_openNewRoundDialog:function e(n){var o=this;var r=n.offers,i=n.hasPartialWinner;var a=this.getView();p.load({id:a.getId(),name:"com.innova.sigc.view.biddingProcess.dialog.qualification.NewRoundDialog",controller:this}).then(function(e){var n=e;a.addDependent(n);n.getEndButton().attachPress(n.close.bind(n));o._oNewRoundDialog=n;o._oNewRoundDialog.setModel(new h({offers:r,hasPartialWinner:i}));o.byId("limOfertaNewRound").setMinDate(new Date);t.removeEditorManager();setTimeout(function(){o._oNewRoundEditor=t.initializeQuillEditor.call(o,{container:o.byId("editorNewRound").getDomRef(),placeholder:o._i18n.getText("0314")});o._oNewRoundEditor.render()});n.attachAfterClose(n.destroy.bind(n));n.open()})},_buildReqNewRound:function e(t,n){var o=t.message,r=t.fechaLimite;return{fechaLimite:r,message:o,vendors:n.map(function(e){return e.getBindingContext().getProperty("vendorId")})}},_getCantAsignByEvaluator:function e(t){var n=t.value,o=t.cantOfer;var r=+n;if(n<0){r=0}else if(n>+o){r=+o}return r},_sumAllCantAsig:function e(t){var n=t.qualifications,o=n===void 0?[]:n,r=t.currentQualification,i=r===void 0?{}:r;var a=f(o,{type:"cantAsig"});return Object.entries(a).filter(function(e){var t=_slicedToArray(e,2),n=t[1];return Array.isArray(n)}).filter(function(e){var t=_slicedToArray(e,2),n=t[1];return i.offerId!==n[0].offerId&&i.processPositionId!==n[0].processPositionId}).reduce(function(e,t){var n;var o=_slicedToArray(t,2),r=o[1];var i=_slicedToArray(r,1),a=i[0];var s=(n=a.value)!==null&&n!==void 0?n:0;return e+parseInt(s,10)},0)},_getGlobalQualificationMax:function e(t){return t.map(function(e){return e.global}).reduce(function(e,t){var n=(e===null||e===void 0?void 0:e.comercial)>t.comercial?e.comercial:t.comercial;var o=(e===null||e===void 0?void 0:e.tecnical)>t.tecnical?e.tecnical:t.tecnical;var r=(e===null||e===void 0?void 0:e.total)>t.total?e.total:t.total;return{comercial:n,tecnical:o,total:r}},{})}}});