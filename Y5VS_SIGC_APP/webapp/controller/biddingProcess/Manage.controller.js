"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _arrayLikeToArray(e,t)}function _iterableToArray(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,r=new Array(t);i<t;i++){r[i]=e[i]}return r}function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach(function(t){_defineProperty(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function _defineProperty(e,t,i){if(t in e){Object.defineProperty(e,t,{value:i,enumerable:true,configurable:true,writable:true})}else{e[t]=i}return e}
/*!
 * SiGC - GestiÃ³n de Compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["./Base","./components/qualification/Main","./components/Attachment","./components/CreateOrder","./components/Criteria","./components/General","./components/Positions","./components/Questions","./components/Vendors","com/innova/sigc/formatter/date","com/innova/sigc/formatter/getEmailString","com/innova/sigc/formatter/getNameRespTec","com/innova/sigc/formatter/getObjTextProp","com/innova/sigc/formatter/formatStatus","com/innova/sigc/formatter/intEvaluation","com/innova/sigc/lib/formUtils/formUtils","com/innova/sigc/model/constant","com/innova/sigc/model/process/processStatus/useProcessStatus","com/innova/sigc/model/process/TypesDocEnum","com/innova/sigc/service/http","com/innova/sigc/utils/isEmpty","com/innova/sigc/utils/parseUniversalDate","com/innova/sigc/utils/showToast","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/library","sap/m/Text"],function(e,t,i,r,o,n,a,s,c,l,u,d,h,m,f,b,p,_,y,g,v,P,I,S,T,C,M,D){var E="general";var O=M.ButtonType;var w=M.DialogType;return e.extend("com.innova.sigc.controller.biddingProcess.Manage",_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({formatter:{date:l,getEmailString:u,getNameRespTec:d,getObjTextProp:h,parseUniversalDate:P,intEvaluation:f}},i),r),o),n),a),t),s),c),{},{onInit:function e(){this._oReq={};this._oPage=this.byId("page");this._oGeneralForm=this.byId("generalDataForm");this._i18n=this.getResourceBundle();this._oIconTabBar=this.byId("iconTabBar");this._oInputSociedad=this.byId("oIBukrsManage");this._oInputOrgCompras=this.byId("oIEkorgManage");this._oInputGrupCompras=this.byId("oIEkgrpManage");this._oInputCompAsignado=this.byId("oIErnamManage");this._numProc=null;this._currentTab=E;this._previousTab=E;this._oFormModel=new S({attachments:[],enableTabs:false,evaluationCriteria:[],positions:[],sumCommercialEval:0,sumTechEval:0,tipoDoc:y.LIC_COT,valueHelp:{catProc:[],tipoProc:[],respJuridico:[],respTecnico:[]},vendors:[]});this._oFormModel.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);this.setModel(this._oFormModel,"processModel");this._oStatusModel=new S({});this.setModel(this._oStatusModel,"status");this._oRouter=this.getRouter();this._oRouter.getRoute("manageBiddingProcess").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function e(t){var i=t.getParameter("arguments"),r=i.query;this._oMainModel=this.getModel("main");this._numProc=r;this._fromPage=v(r)?"biddingProcess":"listBiddingProcesses";Promise.resolve(this._oPage.setBusy(true)).then(this._resetView.bind(this)).then(this._fetchAPI.bind(this,this._numProc)).then(this._renderEditors.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},_resetView:function e(){this._currentTab=E;this._previousTab=E;this._oFormModel.setData({attachments:[],enableTabs:false,evaluationCriteria:[],positions:[],sumCommercialEval:0,sumTechEval:0,tipoDoc:y.LIC_COT,valueHelp:{catProc:[],tipoProc:[],respJuridico:[],respTecnico:[]},vendors:[]});this._oStatusModel.setData({enableGeneral:true,enableCriteria:true,enablePositions:true,enableVendors:true,enableQualification:true,inNewRound:false,inEvaluation:false,inAdjudication:false,inPurchaseOrder:false});this.byId("processCurrency").setEditable(true);this.byId("processCurrency").setRequired(true);this.byId("processConversionCurrency").setEditable(true);this.byId("processConversionCurrency").setRequired(true);this.byId("conversionCurrencyContainer").setVisible(true);this.byId("waersContainer").setVisible(true);this.byId("offerPartialSwitch").setEnabled(true);this.byId("pesoValorPrice").setValue();this.byId("userPrice").setValue();this.onLoadItems(this.byId("tipoProcComboBox"));this.onLoadItems(this.byId("catProcMultiComboBox"));this.onLoadItems(this.byId("respJuridicoComboBox"));this.onLoadItems(this.byId("respTecnicoComboBox"));this._oIconTabBar.setSelectedKey(E);this.byId("Tree").collapseAll();this._oGeneralForm.getFormContainers().forEach(function(e){b.cleanFields({formElements:e.getFormElements()})});this._resetAttachments();this.byId("businessCriteriaTable").clearSelection();this.byId("positionTable").clearSelection();this.byId("technicalCriteriaTable").clearSelection();this.byId("vendorsTable").clearSelection();this.byId("limRecepDP").setMinDate(new Date);this.byId("limPregFechaDP").setMinDate(new Date);this.byId("limOferta").setMinDate(new Date)},_fetchAPI:function e(t){if(!v(t)){return g.get("".concat(p.api.PROCESS_PATH,"/").concat(t)).then(this._handleResponse.bind(this))}return this._setDefaultParameters()},_setDefaultParameters:function e(){var t=this;this._bindDefaultData(this._oMainModel.getProperty("/bukrs"),this._oInputSociedad);this._bindDefaultData(this._oMainModel.getProperty("/ekorg"),this._oInputOrgCompras);this._bindDefaultData(this._oMainModel.getProperty("/ekgrp"),this._oInputGrupCompras);this._bindDefaultData(this._oMainModel.getProperty("/sysParams/UNAME"),this._oInputCompAsignado);this._bindDefaultData(this._oMainModel.getProperty("/sysParams/SMTP_ADDR"),this.byId("oIEmailManage"));return g.get("".concat(p.api.CUSTOM_TEMPLATE,"/offer_vendor_invitation")).then(function(e){var i=e.data;t._oFormModel.setProperty("/templateInvitation",i===null||i===void 0?void 0:i.content)})},_bindDefaultData:function e(t,i){i.setValue(t);i.setDescription();i.destroySuggestionItems().addSuggestionItem(new sap.ui.core.ListItem({key:t,text:t}));i.setSelectedKey(t);i.fireChangeEvent(t)},_fetchOffers:function e(){var t=this;return g.get("".concat(p.api.PROCESS_PATH,"/").concat(this._numProc,"/").concat(p.api.OFFERS_PATH)).then(function(e){var i=e.data;t._oFormModel.setProperty("/offers",i)})},_handleResponse:function e(t){var i=t.data;var r=i.offers,o=r===void 0?[]:r,n=i.evaluationCriteria,a=i.status;this._oGeneralForm.getFormContainers().forEach(function(e){b.setDataInFields({formElements:e.getFormElements(),data:_objectSpread({},i)})});this._validateProcessCurrency({offers:o,waers:i.waers,conversionCurrency:i.conversionCurrency});this._validatePartialOffers({offers:o});this._sumOfEvaluationCriteria(n);this._buildEvaluationCriteria(n);this._validateProcessStatus(a);this._oFormModel.setData(_objectSpread(_objectSpread({},i),{},{enableTabs:true}),true);this._oFormModel.setProperty("/stateOfProcess",m({status:a,i18n:this._i18n}));this._oStatusModel.refresh()},_validateProcessStatus:function e(t){var i=_.inNewRound(t);var r=_.inEvaluation(t);var o=_.inAdjudication(t);var n=_.inPurchaseOrder(t);var a=!r&&!i&&!o&&!n;this._oStatusModel.setData({enableGeneral:a,enableCriteria:a,enablePositions:a,enableVendors:a,enableAttachments:a,enableQualification:!i&&!o&&!n,inNewRound:i,inEvaluation:r,inAdjudication:o,isAdjudication:_.isAdjudication(t),inPurchaseOrder:n})},_callTabsStrategy:function e(){var t=this;for(var i=arguments.length,r=new Array(i),o=0;o<i;o++){r[o]=arguments[o]}var n={additionalInformation:this._additionalInformationStrategy,commercialQualification:this._fetchCommercialQualifications,general:this._renderEditors.bind(this),qualification:this._fetchQualifications,qualificationSummary:this._fetchQualificationSummary,questions:this._fetchQuestions,technicalQualification:this._fetchTechnicalQualifications,vendor:this._fetchOffers};var a=n[this._currentTab];return this._fetchAPI(this._numProc).then(function(){return a===null||a===void 0?void 0:a.call.apply(a,[t].concat(r))})},_getSelectedIndices:function e(t){var i=t.getSelectedIndices();if(v(i)){return Promise.reject(new Error(this.getResourceBundle().getText("Commons.0022")))}return Promise.resolve(i.map(function(e){return t.getContextByIndex(e)}))},_getSelectedItems:function e(t){var i=t.getSelectedItems();if(v(i)){throw new Error(this._i18n.getText("Commons.0022"))}return i},_deleteBindingRows:function e(t){var i=t.path,r=t.ids;this._oFormModel.setProperty("".concat(i),_toConsumableArray(this._oFormModel.getProperty("".concat(i)).filter(function(e){var t=e.id;return!r.includes(t)})));I(this.getResourceBundle().getText("Commons.0021"))},_isValidForm:function e(t){var i=b.validateForm({formContainers:t.getFormContainers()});if(!i){throw new Error(this._i18n.getText("Commons.0027"))}return Promise.resolve()},onNavBack:function e(){if(this._fromPage==="biddingProcess"){this._oRouter.navTo("biddingProcess",{},{},true)}else{this._oRouter.navTo("listBiddingProcesses",{},{},true)}},onRefresh:function e(){Promise.resolve(this._oPage.setBusy(true)).then(this._callTabsStrategy.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onSelectItemTabBar:function e(t){var i=t.key;this._currentTab=i;if(this._previousTab!==i){this._previousTab=this._currentTab;Promise.resolve(this._oPage.setBusy(true)).then(this._callTabsStrategy.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))}},onShowTextDialog:function e(t,i){var r=new T({type:w.Message,title:i,content:new D({text:t}),beginButton:new C({type:O.Emphasized,text:"OK",press:function e(){r.close()}})});r.attachAfterClose(r.destroy.bind(r));r.open()}}))});