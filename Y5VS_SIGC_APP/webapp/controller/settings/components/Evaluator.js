"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(!t)return;if(typeof t==="string")return _arrayLikeToArray(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);if(a==="Object"&&t.constructor)a=t.constructor.name;if(a==="Map"||a==="Set")return Array.from(t);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _arrayLikeToArray(t,e)}function _arrayLikeToArray(t,e){if(e==null||e>t.length)e=t.length;for(var a=0,i=new Array(e);a<e;a++){i[a]=t[a]}return i}function _iterableToArrayLimit(t,e){var a=t==null?null:typeof Symbol!=="undefined"&&t[Symbol.iterator]||t["@@iterator"];if(a==null)return;var i=[];var r=true;var o=false;var n,s;try{for(a=a.call(t);!(r=(n=a.next()).done);r=true){i.push(n.value);if(e&&i.length===e)break}}catch(t){o=true;s=t}finally{try{if(!r&&a["return"]!=null)a["return"]()}finally{if(o)throw s}}return i}function _arrayWithHoles(t){if(Array.isArray(t))return t}function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,i)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){_defineProperty(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function _defineProperty(t,e,a){if(e in t){Object.defineProperty(t,e,{value:a,enumerable:true,configurable:true,writable:true})}else{t[e]=a}return t}
/*!
 * SiGC - GestiÃ³n de Compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["com/innova/sigc/lib/formUtils/formUtils","com/innova/sigc/model/constant","com/innova/sigc/model/settings/Evaluator","com/innova/sigc/model/settings/ImportSapUsers","com/innova/sigc/service/http","com/innova/sigc/service/petitions","com/innova/sigc/utils/getSelectedRowsContext","com/innova/sigc/utils/isEmail","com/innova/sigc/utils/isEmpty","com/innova/sigc/utils/showToast","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel"],function(t,e,a,i,r,o,n,s,l,u,c,d,g){return{onShowCreateEvaluatorDialog:function t(){var e=this;var a="create";this._getEvaluatorsDialog({action:a}).then(function(t){var i=t;var r=i.getBeginButton();var o=e.getResourceBundle().getText("Commons.0029");r.setText(o);r.setTooltip(o);r.attachPress(e.onCreateEvaluator.bind(e,{action:a}));e.getModel("evaluators").setProperty("/editMail",true);e._oEvaluationCriteriaDialog=i;e._oEvaluationCriteriaDialog.unbindElement();e._oEvaluationCriteriaDialog.open()}).catch(this.errorHandler.bind(this))},onShowUpdateEvaluatorDialog:function t(e){var a=this;var i=e.getBindingContext("evaluators");var r=i.getPath();var o="edit";this._getEvaluatorsDialog({action:o}).then(function(t){var e=t;var i=e.getBeginButton();var n=a.getResourceBundle().getText("Commons.0017");i.setText(n);i.setTooltip(n);i.attachPress(a.onUpdateEvaluator.bind(a,{path:r,action:o}));a.getModel("evaluators").setProperty("/editMail",false);a._oEvaluationCriteriaDialog=e;a._oEvaluationCriteriaDialog.unbindElement();a._oEvaluationCriteriaDialog.bindElement({path:r,model:"evaluators"});a._oEvaluationCriteriaDialog.open()}).catch(this.errorHandler.bind(this))},onCreateEvaluator:function t(a){var i=a.action;Promise.resolve(this._oEvaluationCriteriaDialog.setBusy(true)).then(this._validateFieldsForEvaluator.bind(this)).then(this._buildReqForEvaluators.bind(this,{action:i})).then(r.post.bind(r,e.api.EVALUATORS_PATH)).then(this._getEvaluators.bind(this)).then(this._oEvaluationCriteriaDialog.close.bind(this._oEvaluationCriteriaDialog)).catch(this.errorHandler.bind(this)).finally(this._oEvaluationCriteriaDialog.setBusy.bind(this._oEvaluationCriteriaDialog,false))},onUpdateEvaluator:function t(a){var i=a.path,o=a.action;var n=this.getModel("evaluators").getProperty("".concat(i,"/id"));Promise.resolve(this._oEvaluationCriteriaDialog.setBusy(true)).then(this._validateFieldsForEvaluator.bind(this)).then(this._buildReqForEvaluators.bind(this,{action:o})).then(r.update.bind(r,"".concat(e.api.EVALUATORS_PATH,"/").concat(n))).then(this._getEvaluators.bind(this)).then(this._oEvaluationCriteriaDialog.close.bind(this._oEvaluationCriteriaDialog)).catch(this.errorHandler.bind(this)).finally(this._oEvaluationCriteriaDialog.setBusy.bind(this._oEvaluationCriteriaDialog,false))},onResendInvitationMail:function t(){var e=this;var a=this.byId("evaluatorsTable");var i=this.getResourceBundle();if(a.getSelectedIndices().length){c.confirm(i.getText("0165"),{actions:[i.getText("0166"),c.Action.CANCEL],emphasizedAction:i.getText("0166"),onClose:function t(r){if(i.getText("0166")===r){e._resendInvitationMail({oTable:a,i18n:i})}}})}else{u(i.getText("Commons.0030"))}},onChangeEvaluatorStatus:function t(e){var a=this;var i=this.byId("evaluatorsTable");var r=this.getResourceBundle();if(i.getSelectedIndices().length){var o={locked:{title:r.getText("0167"),message:r.getText("0168")},unlocked:{title:r.getText("0169"),message:r.getText("0170")}};var n=o[e],s=n.title,l=n.message;c.confirm(l,{actions:[c.Action.OK,c.Action.CANCEL],title:s,emphasizedAction:c.Action.OK,onClose:function t(o){if(c.Action.OK===o){var n=e==="locked";a._changeEvaluatorStatus({oTable:i,i18n:r,locked:n})}}})}else{u(r.getText("Commons.0030"))}},onShowImportSapUsersDialog:function e(){var a=this;var i=this.getView();d.load({id:i.getId(),name:"com.innova.sigc.view.settings.dialog.evaluator.ImportSapUsers",controller:this}).then(function(e){var r=e;i.addDependent(r);r.getEndButton().attachPress(r.close.bind(r));r.attachAfterClose(r.destroy.bind(r));t.addValidatorAllMultiInputs({fields:a.byId("importSapUsersForm").getControlsByFieldGroupId("MultiInputGroup")});a._oImportSapUsersDialog=r;a._oImportSapUsersDialog.open()})},onSearchSapUsers:function a(){var i=this;var r=this.byId("importSapUsersForm");Promise.resolve(this._oImportSapUsersDialog.setBusy(true)).then(t.getFormData.bind(t,r)).then(this._buildReqToSap.bind(this)).then(o.post.bind(o,e.GET_IMPORT_SAP_USERS)).then(function(t){var e=t.data;var a=i.getModel("evaluators").getProperty("/data");var r=e.filter(function(t){var e=t.BNAME;return!a.find(function(t){var a=t.bname;return a===e})});i.byId("sapUsersTable").setModel(new g({data:r}))}).catch(this.errorHandler.bind(this)).finally(this._oImportSapUsersDialog.setBusy.bind(this._oImportSapUsersDialog,false))},onConfirmSapUsers:function t(){var i=this;var o=this.byId("sapUsersTable");var n=o.getSelectedItems();if(n.length){this._oImportSapUsersDialog.setBusy(true);setTimeout(function(){Promise.resolve().then(function(){return n.map(function(t){return new a({firstname:t.getBindingContext().getProperty("NAME"),lastname:t.getBindingContext().getProperty("LAST_NAME"),email:t.getBindingContext().getProperty("EMAIL"),bname:t.getBindingContext().getProperty("BNAME"),roles:i._getRolesForEvaluator({tech:t.getBindingContext().getProperty("TECH"),legal:t.getBindingContext().getProperty("LEGAL")})})})}).then(i._validateEvaluatorEmails.bind(i)).then(r.post.bind(r,e.api.EVALUATORS_SAP_PATH)).then(u.bind(u,i.getResourceBundle().getText("Commons.0021"))).then(i._oImportSapUsersDialog.close.bind(i._oImportSapUsersDialog,false)).then(i._getEvaluators.bind(i)).catch(i.errorHandler.bind(i)).finally(i._oImportSapUsersDialog.setBusy.bind(i._oImportSapUsersDialog,false))})}},_getEvaluators:function t(){var a=this;return r.get(e.api.EVALUATORS_PATH).then(function(t){var e=t.data;a.setModel(new g({data:e,editMail:true}),"evaluators")})},_validateFieldsForEvaluator:function t(){var e=this.byId("firstname").getValue();var a=this.byId("lastname").getValue();var i=this.byId("email").getValue();if(l(e)||l(a)||l(i)){throw new Error(this.getResourceBundle().getText("Commons.0027"))}},_buildReqForEvaluators:function t(e){var i=e.action;var r=this.byId("firstname");var o=this.byId("lastname");var n=this.byId("email");var s=this.byId("technical").getSelected();var l=this.byId("legal").getSelected();return new a(_objectSpread(_objectSpread({firstname:r.getValue(),lastname:o.getValue()},i==="create"&&{email:n.getValue()}),{},{roles:this._getRolesForEvaluator({tech:s,legal:l})}))},_getRolesForEvaluator:function t(e){var a=e.tech,i=e.legal;var r=[];if(a){r.push("TECHNICAL_EVALUATOR")}if(i){r.push("LEGAL_EVALUATOR")}return r},_getEvaluatorsDialog:function t(e){var a=e.action;var i=this.getView();return d.load({id:i.getId(),name:"com.innova.sigc.view.settings.dialog.evaluator.CreateOrUpdate",controller:this}).then(function(t){var e=t;i.addDependent(e);e.getEndButton().attachPress(e.close.bind(e));e.attachAfterClose(e.destroy.bind(e));e.data("action",a);return e})},_resendInvitationMail:function t(a){var i=a.oTable,o=a.i18n;this._oPage.setBusy(true);n(i,{i18n:o}).then(function(t){return t.map(function(t){var e=t.object;return{id:e.id}})}).then(r.post.bind(r,e.api.EVALUATORS_RESEND_INVITATION_MAIL_PATH)).then(u.bind(u,o.getText("Commons.0021"))).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},_changeEvaluatorStatus:function t(a){var i=a.oTable,o=a.i18n,s=a.locked;this._oPage.setBusy(true);n(i,{i18n:o}).then(function(t){return t.map(function(t){var e=t.object;return{id:e.id,locked:s}})}).then(r.post.bind(r,e.api.EVALUATORS_CHANGE_STATUS_PATH)).then(u.bind(u,o.getText("Commons.0021"))).then(this._getEvaluators.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},_validateEvaluatorEmails:function t(e){var a=e.every(s);if(!a){throw new Error(this.getResourceBundle().getText("0360"))}return e},_buildReqToSap:function t(e){var a={};Object.entries(e).forEach(function(t){var e=_slicedToArray(t,2),i=e[0],r=e[1];a[i]=r===null||r===void 0?void 0:r.map(function(t){return{SIGN:"I",OPTION:"EQ",LOW:t}})});return new i(a)}}});