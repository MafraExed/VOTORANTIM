"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(n==null)return;var r=[];var o=true;var a=false;var i,l;try{for(n=n.call(e);!(o=(i=n.next()).done);o=true){r.push(i.value);if(t&&r.length===t)break}}catch(e){a=true;l=e}finally{try{if(!o&&n["return"]!=null)n["return"]()}finally{if(a)throw l}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _defineProperty(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(e,t)}function _iterableToArray(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++){r[n]=e[n]}return r}
/*!
 * SiGC - GestiÃ³n de Compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["com/innova/sigc/factory/searchHelp/searchHelp","com/innova/sigc/lib/formUtils/formUtils","com/innova/sigc/model/constant","com/innova/sigc/model/searchHelp/SearchHelp","com/innova/sigc/service/petitions","com/innova/sigc/utils/hasAllPropsEmpty","com/innova/sigc/utils/keyBy","com/innova/sigc/utils/throwError","com/innova/sigc/utils/toLowerCase","com/innova/vendor/lodash.find","com/innova/vendor/lodash.get","sap/base/strings/formatMessage","sap/ui/core/Fragment","sap/ui/core/ListItem","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel"],function(e,t,n,r,o,a,i,l,s,c,u,d,y,h,p,m,g){var f={factory:e,getControlFieldname:function e(t){var n=t.getName();var r=t.data("fieldname");return r!==null&&r!==void 0?r:n},onValueHelpRequest:function e(t){var a=t.getSource();var i=f.getControlFieldname(a);this._oControlSHelp=a;var l=new r(i.toUpperCase(),{FCAT:"X"});Promise.resolve(a.setBusy(true)).then(o.post.bind(o,n.GET_SEARCH_HELP,l)).then(function(e){var t=e.data;return t}).then(f._processDynamicData.bind(this)).then(f._showDynamicDialog.bind(this,l)).catch(this.errorHandler.bind(this)).then(a.setBusy.bind(a,false))},onValidateInputLiveChange:function e(t){var n;var r=t.getSource();var o=r.data("disableButtonId");(n=this.byId("".concat(o)))===null||n===void 0?void 0:n.setEnabled(false)},onValidateInputValue:function e(t){var n,r=this;var o=t.getSource();var a=s(o.data("lowercase"),o.getValue());var i=o.data("disableButtonId");o.setValueState(sap.ui.core.ValueState.None);(n=this.byId("".concat(i)))===null||n===void 0?void 0:n.setEnabled(true);if(a){var l;var c=f.getControlFieldname(o);var u=Promise.resolve();if(!this._oSearchHelpContext){u=f._validateValueInSearchHelp.call(this,{name:c,value:a}).then(function(e){var t=e;if(!t){o.setValueState(sap.ui.core.ValueState.Error);o.setValue(null)}else{r._oSearchHelpContext=e}o.setDescription(t===null||t===void 0?void 0:t.FTEXT)})}Promise.resolve(o.setBusy(true)).then(function(){return u}).then(this===null||this===void 0?void 0:(l=this[o.data("calledOnChange")])===null||l===void 0?void 0:l.bind(this,o)).catch(this.errorHandler.bind(this)).finally(function(){r._oSearchHelpContext=null;o.setBusy(false)})}else{o.setDescription("")}},onSearch:function e(t,n){var r=[];if(n&&n.length>0){r=f._getFilter(this._oControlSHelp.getName(),n,t.getModel().getProperty("/catalog"))}var o=f._getBindingItems.call(this,t);if(r.length!==0){o.filter(new p(r,false))}else{o.filter([])}},onClose:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];try{if(t.length){var n=this._oControlSHelp.getMetadata().getName();var r="_setValue".concat(n.split(".").pop(),"Control");if(f["".concat(r)]){f["".concat(r)].call(this,t,this._oControlSHelp,this._sKeySHelp)}}this._sKeySHelp=null;this._oControlSHelp=null;f.onCloseDynamicDialog.call(this)}catch(e){this.errorHandler(e)}},onConfirmSelectedOption:function e(){try{var t=this.byId("dynamicSHTable");var n=t.getSelectedItems();if(n.length){var r=this._oControlSHelp.getMetadata().getName();var o="_setValue".concat(r.split(".").pop(),"Control");if(f["".concat(o)]){f["".concat(o)].call(this,n,this._oControlSHelp,this._sKeySHelp)}this._sKeySHelp=null;this._oControlSHelp=null;f.onCloseDynamicDialog.call(this)}}catch(e){this.errorHandler(e)}},onToggleFilters:function e(t){this.byId("SimpleFormSH").setVisible(t);this.byId("execButton").setVisible(t)},onCustomFilter:function e(){var i=this;try{var s=this.byId("dynamicContainer");var c=this.byId("staticContainer");var u=t.getDataFromFields({formElements:[].concat(_toConsumableArray(s.getFormElements()),_toConsumableArray(c.getFormElements()))});l(a(u),this.getMessageTextPool("064"));var d=f.getControlFieldname(this._oControlSHelp);var y=new r(d.toUpperCase());f._setRequestData(y,u);Promise.resolve(this._oDynamicDialog.setBusy(true)).then(o.post.bind(o,n.GET_SEARCH_HELP,y)).then(function(e){return e.data}).then(f._processDynamicData.bind(this)).then(function(e){i._oDynamicTable.destroyColumns();i._oDynamicTable.destroyItems();i._oDynamicDialog.setModel(e)}).catch(this.errorHandler.bind(this)).finally(this._oDynamicDialog.setBusy.bind(this._oDynamicDialog,false))}catch(e){this.errorHandler(e);this._oDynamicDialog.setBusy(false)}},onCloseDynamicDialog:function e(){if(this._oDynamicDialog){this._oDynamicDialog.close();this._oDynamicDialog.destroy();this._oDynamicDialog=null}},_setSelected:function e(t,n){var r=n.tokens,o=n.key;return t.map(function(e){return _objectSpread(_objectSpread({},e),{},{selected:r.some(function(t){return t.getKey()===e[o]})})})},_processDynamicData:function e(t){var n=i(t.catalog,"FIELDNAME");var r=t.data;var o=c(n,{F4AVAILABL:"X"});this._sKeySHelp=o.FIELDNAME;if(this._oControlSHelp.getMetadata().getName()==="sap.m.MultiInput"){r=f._setSelected(r,{tokens:this._oControlSHelp.getTokens(),key:this._sKeySHelp})}var a="".concat(n[this._sKeySHelp].SCRTEXT_L||n[this._sKeySHelp].REPTEXT);var l="";if(r.length>0){l=d(this.getMessageTextPool("K304"),["".concat(r.length),a])}return f._setSearchHelpModel.call(this,{catalog:n,data:r,title:l,lang:u(t,"spras",[]),shortTitle:a})},_setSearchHelpModel:function e(t){var n=t.catalog,r=t.data,o=t.lang,a=o===void 0?[]:o,i=t.title,l=t.shortTitle;var s=new g({catalog:n,data:r,lang:a,properties:{key:this._sKeySHelp,shortTitle:"".concat(l),mode:this._oControlSHelp.data("multi")?"MultiSelect":"None",title:"".concat(i),visible:r.length>0}});s.setSizeLimit(1e6);return s},_showDynamicDialog:function t(n,r){var o=this;if(!this._oDynamicDialog){y.load({id:this.getView().getId(),name:"com.innova.sigc.view.searchHelp.DynamicSearchHelpDialog",controller:this}).then(function(t){o.getView().addDependent(t);t.addStyleClass(o.getOwnerComponent().getContentDensityClass());o._oDynamicTable=o.byId("dynamicSHTable");o._oDynamicTable.bindAggregation("columns",{path:"/catalog",sorter:{path:"COL_POS"},filter:[new p({path:"TECH",operator:"NE",value1:"X"}),new p({path:"NO_OUT",operator:"NE",value1:"X"})],factory:e.sHelpColumnFactory(r.getProperty("/properties/key"))});o._oDynamicTable.bindItems({path:"/data",factory:e.tableItemDynamicSH.call(o,"/catalog")});o._oRowsStepInput=o.byId("rows");o._oSprasComboBox=o.byId("spras");o.oSimpleFormSH=o.byId("SimpleFormSH");o.oSimpleFormSH.setVisible(true);t.setModel(r);o._oDynamicDialog=t;o._oDynamicDialog.open()})}else{this._oRowsStepInput.setValue(20);this._oSprasComboBox.setSelectedKey("S");this._oDynamicTable.destroyColumns();this._oDynamicTable.destroyItems();this._oDynamicDialog.setModel(r);this._oDynamicDialog.open()}},_getFilter:function e(t,n){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var o=[new p(t,"".concat(m.Contains.toString()),"".concat(n))];var a=Object.keys(r);if(a.length){o=a.filter(function(e){return r[e].TECH!=="X"}).map(function(e){return new p(r[e].FIELDNAME,"".concat(m.Contains.toString()),"".concat(n))})}return o},_getBindingItems:function e(t){return t.getMetadata().getName()==="sap.m.TableSelectDialog"?t.getBinding("items"):this.byId("dynamicSHTable").getBinding("items")},_setRequestData:function e(t,n){return Object.entries(n).forEach(function(e){var n=_slicedToArray(e,2),r=n[0],o=n[1];return o&&t["set".concat(r)](o)})},_getValue:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";return t!=="*"?t.replace(/\*/g,""):t},_comparerTokens:function e(t){return function(e){return t.filter(function(t){return e===t.getKey()}).length===0}},_setValueInputControl:function e(t,n,r){var o=_slicedToArray(t,1),a=o[0];this._oSearchHelpContext=a.getObject();var i=f._getValue(a.getProperty(r));var l=a.getProperty("FTEXT");n.setValue(i);n.setDescription(l);n.destroySuggestionItems().addSuggestionItem(new h({key:i,text:i}));n.setSelectedKey(i);n.fireChangeEvent(i)},_setValueMultiInputControl:function e(t,n,r){t.map(function(e){return f._getValue(e[r]||e.getBindingContext().getProperty("".concat(e.getBindingContext(),"/").concat(r)))}).filter(f._comparerTokens(n.getTokens())).forEach(function(e){return n.addToken(new sap.m.Token({key:e,text:e}))});n.fireTokenUpdate({type:"added"})},_validateValueInSearchHelp:function e(t){var a=t.name,i=t.value;var l=new r(a.toUpperCase());l.setFCODE1(i);return o.post(n.GET_SEARCH_HELP,l).then(function(e){var t=e.data;var n=u(t,"data",[]);var r=c(n,{FCODE1:i});return r})}};return f});