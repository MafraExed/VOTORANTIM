"use strict";function ownKeys(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,r)}return o}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(o),!0).forEach(function(t){_defineProperty(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function _defineProperty(e,t,o){if(t in e){Object.defineProperty(e,t,{value:o,enumerable:true,configurable:true,writable:true})}else{e[t]=o}return e}
/*!
 * SiTrack - Seguimiento de compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["../BaseController","sap/ui/model/BindingMode","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","com/innova/factory/purchaseTracking/approvals","com/innova/model/purchaseTracking/Approval","com/innova/model/purchaseTracking/ListApprovals","com/innova/model/constant","com/innova/service/petitions","sap/m/MessageBox","com/innova/util/isEmpty"],function(e,t,o,r,i,s,a,n,p,h,l){return e.extend("com.innova.sitrack.controller.approvals.ApprovalTable",{approvals:i,onInit:function e(){this._initialState();this._oPage=this.byId("page");this._oApprovalTable=this.byId("approvalTable");this.getRouter().getRoute("approvals").attachMatched(this._onRouteMatched,this)},_initialState:function e(){this._allData=false;this._aSelectedContext=[];this._iColumnHeight=100;this._isExcel=false;this._items=[];this._oReq={};this._scrollTable=false;this._sTargetReturn="";this._oFilteredPreviousColumn=null},_onRouteMatched:function e(){var r=this.getOwnerComponent().getModel("store");var i=r.getProperty("/req");var s=r.getProperty("/keys");if(!Object.keys(i).length||!Object.keys(s).length){this.getModel("appView").setProperty("/resetProcessForm",true);this.getRouter().navTo("purchaseTracking",{},true);return}this.getModel("appView").setProperty("/resetProcessForm",false);this._oReq=i;this._oModel=new o;this._oModel.setData(null);this._oModel.setDefaultBindingMode(t.TwoWay);this._oModel.setSizeLimit(1e6);this.setModel(this._oModel,"approvals");Promise.resolve(this._oPage.setBusy(true)).then(this._buildRequest.bind(this)).then(this._fetchData.bind(this)).then(this._handleResponse.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))},_buildRequest:function e(){var t=this.getModel("store");var o=t.getProperty("/processSelected");var r=t.getProperty("/approvalTarget");var i=[];o.forEach(function(e){var t={};if(r==="A"){t.BANFN=e.BANFN;t.BNFPO=e.BNFPO}if(r==="B"){t.EBELN=e.EBELN;t.EBELP=e.EBELP}i.push(t)});var a={};a.IT_DOCKEYS=i;this._oReq=new s(a)},_buildRequestListApprovers:function e(t,o){var r=this.getModel("store");var i=this.getModel("approvals");var s=r.getProperty("/approvalTarget");var n=i.getProperty(o);var p={};p.TIPO=s==="A"?1:2;p.DOC=n.DOCUMENTO;p.POS=n.BNFPO;p.COD_LIB=t.code;this._oReq=new a(p)},_handleResponse:function e(){var r={};if(l(this._oRes.items)){var i=this;h.error(this.getMessageTextPool("K344"),{actions:[h.Action.OK],onClose:function e(){i.onNavBack()}})}else{r.data=this._buildRows(this._oRes.items);r.catalog=JSON.parse(JSON.stringify(this._oRes.catalog));r.catalog=this._buildColumns(r.catalog,r.data);this._oModel=new o;this._oModel.setData(r);this._oModel.setDefaultBindingMode(t.TwoWay);this._oModel.setSizeLimit(1e6);this.setModel(this._oModel,"approvals")}},_handleResponseListApprovers:function e(){if(l(this._oRes.results)){throw new Error(this.getMessageTextPool("K060"))}var t=this._oRes.results;var o=this.getView();var r=o.getModel("approvals");r.setProperty("/listApprovers",t)},_buildColumns:function e(t,o){var r={FIELDNAME:"ApproverOne",REPTEXT:"{main>/textPool/K113}",SCRTEXT_L:"{main>/textPool/K113}",INTTYPE:"approver",TECH:this._checkVisibility(o,1),NO_OUT:"",COL_POS:30,MARK:"X",OUTPUTLEN:"220"};var i={FIELDNAME:"ApproverTwo",REPTEXT:"{main>/textPool/K114}",SCRTEXT_L:"{main>/textPool/K114}",INTTYPE:"approver",TECH:this._checkVisibility(o,1),NO_OUT:"",COL_POS:31,MARK:"X",OUTPUTLEN:"110"};var s={FIELDNAME:"ApproverThree",REPTEXT:"{main>/textPool/K115}",SCRTEXT_L:"{main>/textPool/K115}",INTTYPE:"approver",TECH:this._checkVisibility(o,3),NO_OUT:"",COL_POS:32,MARK:"X",OUTPUTLEN:"110"};var a={FIELDNAME:"ApproverFour",REPTEXT:"{main>/textPool/K116}",SCRTEXT_L:"{main>/textPool/K116}",INTTYPE:"approver",TECH:this._checkVisibility(o,4),NO_OUT:"",COL_POS:33,MARK:"X",OUTPUTLEN:"110"};var n={FIELDNAME:"ApproverFive",REPTEXT:"{main>/textPool/K117}",SCRTEXT_L:"{main>/textPool/K117}",INTTYPE:"approver",TECH:this._checkVisibility(o,5),NO_OUT:"",COL_POS:34,MARK:"X",OUTPUTLEN:"110"};var p={FIELDNAME:"ApproverSix",REPTEXT:"{main>/textPool/K118}",SCRTEXT_L:"{main>/textPool/K118}",INTTYPE:"approver",TECH:this._checkVisibility(o,6),NO_OUT:"",COL_POS:35,MARK:"X",OUTPUTLEN:"110"};var h={FIELDNAME:"ApproverSeven",REPTEXT:"{main>/textPool/K119}",SCRTEXT_L:"{main>/textPool/K119}",INTTYPE:"approver",TECH:this._checkVisibility(o,7),NO_OUT:"",COL_POS:36,MARK:"X",OUTPUTLEN:"110"};var l={FIELDNAME:"ApproverEight",REPTEXT:"{main>/textPool/K120}",SCRTEXT_L:"{main>/textPool/K120}",INTTYPE:"approver",TECH:this._checkVisibility(o,8),NO_OUT:"",COL_POS:37,MARK:"X",OUTPUTLEN:"110"};var c=[r,i,s,a,n,p,h,l];return t.filter(function(e){var t=e.TECH,o=e.NO_OUT;return t!=="X"&&o!=="X"}).sort(function(e,t){return e.COL_POS-t.COL_POS}).concat(c).map(function(e,t){return _objectSpread(_objectSpread({},e),{},{COL_POS:t+1})})},_checkVisibility:function e(t,o){var r="X";var i="APR".concat(o);t.forEach(function(e){if(e[i]!==""){r=""}});return r},_buildRows:function e(t){return t.map(function(e){return _objectSpread(_objectSpread({},e),{},{ApproverOne:{name:e.APR1,date:e.FEC_APR1,hour:e.HORA_APR1,days:e.DIAS_APR1,code:e.COD_LIB1},ApproverTwo:{name:e.APR2,date:e.FEC_APR2,hour:e.HORA_APR2,days:e.DIAS_APR2,code:e.COD_LIB2},ApproverThree:{name:e.APR3,date:e.FEC_APR3,hour:e.HORA_APR3,days:e.DIAS_APR3,code:e.COD_LIB3},ApproverFour:{name:e.APR4,date:e.FEC_APR4,hour:e.HORA_APR4,days:e.DIAS_APR4,code:e.COD_LIB4},ApproverFive:{name:e.APR5,date:e.FEC_APR5,hour:e.HORA_APR5,days:e.DIAS_APR5,code:e.COD_LIB5},ApproverSix:{name:e.APR6,date:e.FEC_APR6,hour:e.HORA_APR6,days:e.DIAS_APR6,code:e.COD_LIB6},ApproverSeven:{name:e.APR7,date:e.FEC_APR7,hour:e.HORA_APR7,days:e.DIAS_APR7,code:e.COD_LIB7},ApproverEight:{name:e.APR8,date:e.FEC_APR8,hour:e.HORA_APR8,days:e.DIAS_APR8,code:e.COD_LIB8}})})},_resetTableDefaults:function e(){var t=this;this._scrollTable=true;this._oApprovalTable.$().find(".sapUiTableVSb").scrollTop(0);setTimeout(function(){t._scrollTable=false},100)},_fetchData:function e(){var t=this;var o=JSON.parse(JSON.stringify(this._oReq));return this._fetchAPI(o).then(function(e){var o=e.data;t._oRes=o})},_fetchAPI:function e(t){return p.post("".concat(n.GET_APPROVALS_SELECTED),t)},_fetchDataListApprovers:function e(){var t=this;var o=JSON.parse(JSON.stringify(this._oReq));return this._fetchAPIListApprovers(o).then(function(e){var o=e.data;t._oRes=o})},_fetchAPIListApprovers:function e(t){return p.post("".concat(n.LIST_APPROVERS),t)},_openFindApprover:function e(){var t=this;if(!this._oListApprovers){var o=this.getView();r.load({id:o.getId(),name:"com.innova.sitrack.view.purchaseTracking.fragment.approvals.ListApprovals",controller:this}).then(function(e){var r=e;o.addDependent(r);r.getEndButton().attachPress(r.close.bind(r));t._oListApprovers=r;r.open()})}else{this._oListApprovers.open()}},_findApprover:function e(t){var o=t.getSource();var r=o.data().dataItem;var i=o.getParent().getParent();var s=i.getBindingContext("approvals"),a=s.sPath;this.getApprovers(r,a)},getApprovers:function e(t,o){Promise.resolve(this._oPage.setBusy(true)).then(this._buildRequestListApprovers.bind(this,t,o)).then(this._fetchDataListApprovers.bind(this)).then(this._handleResponseListApprovers.bind(this)).then(this._openFindApprover.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))}})});