"use strict";function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,i)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _arrayLikeToArray(e,t)}function _iterableToArray(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,i=new Array(t);r<t;r++){i[r]=e[r]}return i}
/*!
 * SiTrack - Seguimiento de compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["../BaseController","com/innova/formatter/hasSearchHelp","com/innova/formatter/maxLength","com/innova/lib/formUtils/formUtils","com/innova/lib/searchHelp/searchHelp","com/innova/lib/variant/variant","com/innova/model/constant","com/innova/model/purchaseTracking/Process","com/innova/service/petitions","com/innova/util/isEmpty","sap/ui/model/json/JSONModel"],function(e,t,r,i,a,o,s,n,l,c,d){return e.extend("com.innova.sitrack.controller.purchaseTracking.Form",{hasSearchHelp:t,maxLength:r,searchHelp:a,variant:o,onInit:function e(){this._oReq={};this._keys=[];this._oPage=this.byId("page");this._oSolPedList=this.byId("solPedList");this._oSolPedPanel=this.byId("solPedPanel");this._oPedList=this.byId("pedList");this._oSelectList=this.byId("selectList");this._oSolPaymentList=this.byId("solPaymentList");this._oPedElementPepForm=this.byId("FormElementPEP");this._oSolPedElementPepForm=this.byId("FormSolPedElementPEP");this._oRouter=this.getRouter();this._oRouter.getRoute("purchaseTracking").attachMatched(this._onRouteMatched,this);this._createDataModel()},onAfterRendering:function e(){this._bindView()},validateTipoImputacionPEP:function e(t){var r=this;var i=t.getParameters();var a=t.getSource().getId();if(i.type==="added"){var o=t.getSource().getTokens();o.forEach(function(e){if(e.getKey()==="P"){if(a==="container-sitrack---purchaseTrackingForm--multiInputKNTTP2"){r._oPedElementPepForm.setVisible(true)}else{r._oSolPedElementPepForm.setVisible(true)}}})}else{var s=i.removedTokens;if(s){if(s[0].getKey()==="P"){if(a==="container-sitrack---purchaseTrackingForm--multiInputKNTTP2"){this._oPedElementPepForm.setVisible(false)}else{this._oSolPedElementPepForm.setVisible(false)}}}}},_onRouteMatched:function e(){var t=this.getModel("main");this._showPayment=t.getProperty("/showPayment");if(this.getModel("appView").getProperty("/resetProcessForm")){this.onReset();o.onGetDefaultVariant.call(this)}},_bindView:function e(){try{i.addValidatorAllMultiInputs({fields:this.byId("container").getControlsByFieldGroupId("groupMultiInput")})}catch(e){this.errorHandler(e)}},_createDataModel:function e(){this._oDataModel=new d({TABNAME:{solPed:"EBAN",ped:"EKKO",pedPosition:"EKPO",solPedElementPep:"EBKN",pedElementPep:"EKKN"},DRS:{delimiter:"-",displayFormat:"dd/MM/yyyy",valueFormat:"yyyy-MM-dd"},IV_SOLP_STALIB:{child1:false,child2:false,child3:false},IV_SOLP_ESTP:{child1:false,child2:false,child3:false},IV_PED_LIV:{child1:false,child2:false,child3:false},IV_SOLP_CLOSED:{child1:false,child2:false},IV_PED_STALIB:{child1:false,child2:false,child3:false},SDP_PAYSTATUS:{child1:false,child2:false,child3:false,child4:false,child5:false,child6:false,child7:false,child8:false},IV_PED_EM:{child1:false,child2:false,child3:false},IV_PED_COMPL:{child1:false,child2:false},IR_PED_LIV:{child1:false,child2:false,child3:false}});this.setModel(this._oDataModel,"data")},_buildRequest:function e(t){var r=this;var a="";if(this.byId("reportSegmentButton").getSelectedKey()==="indicators"){a="X"}var o={IV_INDIC_STK:a};t.forEach(function(e){var t=e.data("to");var a=r.byId(t);if(a){var s=a.data("parent");var n=i.getDataFromFields({formElements:a.getFormElements()});if(s){var l,c,d,h;(d=(l=o)[c="".concat(s)])!==null&&d!==void 0?d:l[c]=[];o["".concat(s)]=(h=o["".concat(s)]).concat.apply(h,_toConsumableArray(Object.values(n)))}else{o=_objectSpread(_objectSpread({},o),n)}}});this._oReq=new n(o,this.byId("reportSegmentButton").getSelectedKey())},_fetchKeys:function e(){var t=JSON.parse(JSON.stringify(this._oReq));t.IV_ONLYKEYS="X";return l.post("".concat(s.GET_PROCESS_SELECTED),t)},_validateKeys:function e(t){var r=t.data;if(c(r.dockeys)){return Promise.reject(new Error(this.getMessageTextPool("K060")))}this._keys=r.dockeys;return Promise.resolve()},_handleResponse:function e(){var t=this.getModel("store");t.setProperty("/req",this._oReq);t.setProperty("/keys",this._keys);if(this._oReq.IV_INDIC_STK==="X"){this._oRouter.navTo("purchaseTrackingIndicators")}else{this._oRouter.navTo("purchaseTrackingProcess")}},_getFormDataForVariant:function e(){var t=this;var r=this._getSelectedItems();var a=[];r.forEach(function(e){var r=e.data("to");var o=t.byId(r);if(o){var s=i.getDataFromFields({formElements:o.getFormElements(),functionName:t._sVariantFunction,group:r,isVariant:true});if(!c(s)){a=a.concat(Object.values(s).reduce(function(e,t){return e.concat(t)},[]))}}});this._aVariantItems=a},_bindVariantData:function e(t){var r=this;var a=t.data;var o=a.variant;this.onReset();if(o){if(o.length){var s=[].concat(this._oSolPedList.getItems(),this._oPedList.getItems(),this._oSelectList.getItems(),this._oSolPaymentList.getItems());var n=s.reduce(function(e,t){return _objectSpread(_objectSpread({},e),{},_defineProperty({},"".concat(t.data("to")),t))},{});o.forEach(function(e){var t=e.GRUPO;var a=n["".concat(t)];if(a){a.getParent().fireSelectionChange({listItem:a,selected:true});a.setSelected(true)}var o=r.byId("".concat(t));if(o){i.setDataInFields({data:e,formElements:o.getFormElements()})}})}else if(!this._showPayment){this._oSolPedList.getItems()[4].setSelected(true);this.byId("solPed5").setVisible(true);var l=new Date;var c=new Date((new Date).setDate((new Date).getDate()-30));var d=this.byId("DRS_BADAT");d.setDateValue(c);d.setSecondDateValue(l)}}},_getSelectedItems:function e(){var t=this._oSolPedList.getSelectedItems();var r=this._oPedList.getSelectedItems();var i=this._oSelectList.getSelectedItems();var a=this._oSolPaymentList.getSelectedItems();return[].concat(t,r,i,a)},onSelectionChangeHandler:function e(t){var r=t.listItem,i=t.selected;var a=r.data("to");var o=this.byId("".concat(a));if(o){o.setVisible(i)}},onSelectAllCheckBoxHandler:function e(t,r){this._oDataModel.setProperty("/".concat(t),{child1:r,child2:r,child3:r,child4:r,child5:r,child6:r,child7:r,child8:r})},onSubmitHandler:function e(){try{Promise.resolve(this._oPage.setBusy(true)).then(this._buildRequest.bind(this,this._getSelectedItems())).then(this._fetchKeys.bind(this)).then(this._validateKeys.bind(this)).then(this._handleResponse.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))}catch(e){this.errorHandler(e);this._oPage.setBusy(false)}},onReset:function e(){var t=this;var r=this._getSelectedItems();r.forEach(function(e){var r=e.data("to");var a=t.byId(r);e.getParent().fireSelectionChange({listItem:e,selected:false});e.setSelected(false);if(a){i.cleanFields({formElements:a.getFormElements()})}})},onChangeSegmentReport:function e(t){this.onReset();var r=t.getSource().getSelectedKey();if(r==="indicators"){this._oSolPedList.setVisible(false);this._oSolPedPanel.setVisible(false)}else{this._oSolPedList.setVisible(true);this._oSolPedPanel.setVisible(true)}}})});