"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);if(o==="Object"&&e.constructor)o=e.constructor.name;if(o==="Map"||o==="Set")return Array.from(e);if(o==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o))return _arrayLikeToArray(e,t)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var o=0,a=new Array(t);o<t;o++){a[o]=e[o]}return a}function _iterableToArrayLimit(e,t){var o=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(o==null)return;var a=[];var n=true;var i=false;var r,s;try{for(o=o.call(e);!(n=(r=o.next()).done);n=true){a.push(r.value);if(t&&a.length===t)break}}catch(e){i=true;s=e}finally{try{if(!n&&o["return"]!=null)o["return"]()}finally{if(i)throw s}}return a}function _arrayWithHoles(e){if(Array.isArray(e))return e}function ownKeys(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,a)}return o}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(o),!0).forEach(function(t){_defineProperty(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function _defineProperty(e,t,o){if(t in e){Object.defineProperty(e,t,{value:o,enumerable:true,configurable:true,writable:true})}else{e[t]=o}return e}
/*!
 * SiTrack - Seguimiento de compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["./Base","com/innova/factory/purchaseTracking/process","com/innova/formatter/columnTitleProcess","com/innova/lib/formUtils/formUtils","com/innova/lib/layout/layout","com/innova/lib/searchHelp/searchHelp","com/innova/lib/excel","com/innova/model/constant","com/innova/model/layout/Action","com/innova/model/layout/Function","com/innova/model/layout/ItemLayout","com/innova/model/layout/Layout","com/innova/model/purchaseTracking/GetAttachment","com/innova/model/purchaseTracking/AssignUser","com/innova/model/purchaseTracking/EmailProv","com/innova/model/purchaseTracking/ItemAssignUser","com/innova/model/purchaseTracking/ItemEmailProv","com/innova/model/purchaseTracking/ItemPedModif","com/innova/model/purchaseTracking/ItemReminder","com/innova/model/purchaseTracking/ItemReturnSolPed","com/innova/model/purchaseTracking/ItemSolModif","com/innova/model/purchaseTracking/PedModif","com/innova/model/purchaseTracking/Reminder","com/innova/model/purchaseTracking/ReturnSolPed","com/innova/model/purchaseTracking/SolModif","com/innova/model/purchaseTracking/ItemEmailAddress","com/innova/model/purchaseTracking/UploadAttached","com/innova/service/petitions","com/innova/vendor/lodash.filter","com/innova/util/isEmpty","com/innova/util/keyBy","com/innova/util/showToast","com/innova/sitrack/model/formatter","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Token","sap/m/MessageBox","com/innova/sitrack/model/purchaseTracking/payment/DetailPayment","com/innova/sitrack/model/purchaseTracking/payment/DockKeyPayment","com/innova/model/searchHelp/SearchHelp"],function(e,t,o,a,n,i,r,s,l,c,h,d,u,g,_,f,m,v,P,p,y,b,T,E,D,S,A,O,I,C,M,N,R,w,B,L,U,H,F,x,k,V){return e.extend("com.innova.sitrack.controller.purchaseTracking.Process",{layout:n,process:t,searchHelp:i,formatter:{columnTitleProcess:o},formatterLib:R,onInit:function e(){this._initialState();this._oPage=this.byId("page");this._oProcessTable=this.byId("processTable");this._oRouter=this.getRouter();this._oRouter.getRoute("purchaseTrackingProcess").attachMatched(this._onRouteMatched,this)},_fetch:function e(){Promise.resolve(this._oPage.setBusy(true)).then(this._getInitialData.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))},_fetchNoLayout:function e(){var t=this;var o=this.getModel("store").getData(),a=o.keys,n=o.req;n.IT_DOCKEYS=a;Promise.resolve(this._oPage.setBusy(true)).then(O.post.bind(O,"".concat(s.GET_PROCESS_SELECTED),n)).then(function(e){var o=e.data;o=o===void 0?{}:o;var a=o.items,n=a===void 0?[]:a;var i=t._buildRows(n);t._oModel.setProperty("/data",[]);t._oModel.setProperty("/data",i)}).catch(this.errorHandler.bind(this)).finally(function(){t._scrollTable=false;t._oPage.setBusy(false)})},_getInitialData:function e(){return Promise.resolve(this._resetTableDefatuls()).then(this._fetchFirstPage.bind(this)).then(this._buildData.bind(this)).then(this._getDefaultLayout.bind(this))},_getDefaultLayout:function e(){return O.post("".concat(s.GET_LAYOUT),new d({function:c.PROCESS,action:l.DEFAULT,catalog:[]})).then(this._buildNewCatalog.bind(this)).then(n.onChangeStepInput.bind(this))},_buildNewCatalog:function e(t){var o=this;var a=t.data;var n=a.catalog;var i=M(JSON.parse(JSON.stringify(this._oRes.catalog)),"FIELDNAME");var r=n.map(function(e){var t=e.FIELDNAME;o._iColumnHeight=e.HREF_HNDL;if(e.HREF_HNDL===0){o._iColumnHeight=55}var a=i[t];a.HREF_HNDL=e.HREF_HNDL;a.OUTPUTLEN=e.OUTPUTLEN;a.COL_POS=e.ZORDER;a.TECH="";a.NO_OUT="";return a});this._oModel.setProperty("/catalog",this._buildColumns(r));this._oModel.setProperty("/allCatalog",i)},_buildColumns:function e(t){var o={FIELDNAME:"Status",REPTEXT:this.getMessageTextPool("K074"),SCRTEXT_L:this.getMessageTextPool("K074"),INTTYPE:"Status",TECH:"",NO_OUT:"",COL_POS:1,MARK:"X",OUTPUTLEN:"250",HREF_HNDL:this._iColumnHeight};var a={FIELDNAME:"SolPed",REPTEXT:this.getMessageTextPool("K075"),SCRTEXT_L:this.getMessageTextPool("K075"),INTTYPE:"SolPed",TECH:"",NO_OUT:"",COL_POS:2,MARK:"X",OUTPUTLEN:"110",HREF_HNDL:this._iColumnHeight};var n={FIELDNAME:"longTextComp",REPTEXT:this.getMessageTextPool("K216"),SCRTEXT_L:this.getMessageTextPool("K216"),INTTYPE:"longTextComp",TECH:"",NO_OUT:"",COL_POS:100,MARK:"X",OUTPUTLEN:"320",HREF_HNDL:this._iColumnHeight};var i={FIELDNAME:"longText",REPTEXT:this.getMessageTextPool("K366"),SCRTEXT_L:this.getMessageTextPool("K366"),INTTYPE:"longText",TECH:"",NO_OUT:"",COL_POS:100,MARK:"X",OUTPUTLEN:"320",HREF_HNDL:this._iColumnHeight};var r={FIELDNAME:"Attachments",REPTEXT:this.getMessageTextPool("K217"),SCRTEXT_L:this.getMessageTextPool("K217"),INTTYPE:"attachments",TECH:"",NO_OUT:"",COL_POS:100,MARK:"X",OUTPUTLEN:"80",HREF_HNDL:this._iColumnHeight};var s={FIELDNAME:"AttachmentsSolPed",REPTEXT:this.getMessageTextPool("K221"),SCRTEXT_L:this.getMessageTextPool("K221"),INTTYPE:"attachmentsSolPed",TECH:"",NO_OUT:"",COL_POS:100,MARK:"X",OUTPUTLEN:"130",HREF_HNDL:this._iColumnHeight};var l=[o,a];var c=l.length;var h=l.concat(t.filter(function(e){var t=e.TECH,o=e.NO_OUT;return t!=="X"&&o!=="X"}).sort(function(e,t){return e.COL_POS-t.COL_POS}).map(function(e,t){return _objectSpread(_objectSpread({},e),{},{COL_POS:t+c+1})}));h.push(n);h.push(i);h.push(r);h.push(s);return h},_getSelectedIndices:function e(t){var o=t.getSelectedIndices();if(C(o)){return Promise.reject(new Error(this.getMessageTextPool("K058")))}return Promise.resolve(o)},_getDocContextByIndices:function e(t,o,a){var n=a.map(function(e){return t.getContextByIndex(e)}).filter(function(e){return!C(e.getProperty(o))});this._aSelectedContext=n;this._aSelectedObjects=n.map(function(e){return e.getObject()});return C(n)?Promise.reject(new Error(this.getMessageTextPool("K131"))):Promise.resolve(n)},_openAssignUserDialog:function e(){var t=this;if(!this._oAssignUserDialog){var o=this.getView();w.load({id:o.getId(),name:"com.innova.sitrack.view.purchaseTracking.dialog.AssignUser",controller:this}).then(function(e){var a=e;o.addDependent(a);a.addStyleClass(t.getOwnerComponent().getContentDensityClass());a.getEndButton().attachPress(a.close.bind(a));t._oAssignUserDialog=a;a.open()})}else{this.getView().byId("buyerAU").setValue();this.getView().byId("reasonAU").setValue();this._oAssignUserDialog.open()}},_saveInfoContext:function e(t){var o=t.map(function(e){return e.getObject()});var a={aSelectedObjects:o};var n=new U(a);this.setModel(n,"oDataToSearchHelp")},_createRequestAssignUser:function e(){var t=this.byId("buyerAU").getValue();var o=this.byId("reasonAU").getValue();if(C(t)){throw new Error(this.getMessageTextPool("K069"))}return new g({IT_SOLP:this._aSelectedContext.map(function(e){return new f(_objectSpread(_objectSpread({},e.getObject()),{},{BUYER:t,ASSIG_REASON:o}))})})},_createUpdateAttachedRequest:function e(){var t=this._oUploadAttachedDialog.getModel("oUploadAttached").getData();var o=[];var a=t.positions;a.forEach(function(e){var a=new A(t,e.getObject());o.push(a)});return o},_openReturnSolPedDialog:function e(){var t=this;if(!this._oReturnSolPedDialog){var o=this.getView();w.load({id:o.getId(),name:"com.innova.sitrack.view.purchaseTracking.dialog.ReturnSolPed",controller:this}).then(function(e){var a=e;o.addDependent(a);a.addStyleClass(t.getOwnerComponent().getContentDensityClass());a.getEndButton().attachPress(a.close.bind(a));t._oReturnSolPedDialog=a;a.open()})}else{this._oReturnSolPedDialog.open();this.byId("reasonRSP").setValue();this.byId("multiMailAddress").setValue();this.byId("multiMailAddress").setTokens([])}},_createRequestReturnSolPed:function e(){var t=this;var o=this.byId("reasonRSP");var a=this.byId("multiMailAddress");var n=o.getValue();var i=o.getName();var r=a.getTokens();if(C(n)){throw new Error(this.getMessageTextPool("K069"))}return new E({IT_SOLP:this._aSelectedContext.map(function(e){return new p(_objectSpread(_objectSpread({},e.getObject()),{},_defineProperty({RETURNED:t._oModel.getProperty("/returnOption")},"".concat(i),n)))}),IT_EMAIL:r.map(function(e){return new S(e.getText())})})},_saveLayout:function e(t){var o=t.nameLayout,a=t.defaultLayout;try{if(C(o)){throw new Error(this.getMessageTextPool("K069"))}Promise.resolve(this._oSaveDialog.setBusy(true)).then(this._oSaveDialog.setBusy.bind(this._oSaveDialog,true)).then(this._createLayoutRequest.bind(this,{nameLayout:o,defaultLayout:a})).then(O.post.bind(O,s.GET_LAYOUT)).then(function(e){var t=e.data;return N(t.message)}).then(this._oSaveDialog.close.bind(this._oSaveDialog)).catch(this.errorHandler.bind(this)).finally(this._oSaveDialog.setBusy.bind(this._oSaveDialog,false))}catch(e){this.errorHandler(e);this._oSaveDialog.setBusy(false)}},_createLayoutRequest:function e(t){var o=this;var a=t.nameLayout,n=t.defaultLayout;return Promise.resolve(new d({function:c.PROCESS,action:l.POST,nameLayout:a,defaultLayout:n,catalog:this._oModel.getProperty("/catalog").filter(function(e){var t=e.MARK;return t!=="X"}).map(function(e){return new h(_objectSpread(_objectSpread({},e),{},{function:c.PROCESS,nameLayout:a,columnHeight:o._iColumnHeight}))})}))},_openEmailDialog:function e(t){var o=this;var n=t.data;if(!this._oEmailDialog){var i=this.getView();w.load({id:i.getId(),name:"com.innova.sitrack.view.purchaseTracking.dialog.Email",controller:this}).then(function(e){var t=e;i.addDependent(t);t.addStyleClass(o.getOwnerComponent().getContentDensityClass());t.getEndButton().attachPress(t.close.bind(t));t.setModel(new U(n));o._oEmailDialog=t;t.open();a.addValidatorEmailMultiInputs({fields:t.getControlsByFieldGroupId("email")})})}else{this._oEmailDialog.setModel(new U(n));this._oEmailDialog.open();a.addValidatorEmailMultiInputs({fields:this._oEmailDialog.getControlsByFieldGroupId("email")})}},_createReminberRequest:function e(){var t=this;var o=this._oEmailDialog.getModel().getData();var a=[];o.forEach(function(e){var o=t._aSelectedContext.filter(function(t){return Number.isNaN(Number(t.getProperty("POH_LIFNR")))||Number.isNaN(Number(e.LIFNR))?t.getProperty("POH_LIFNR")===e.LIFNR:Number(t.getProperty("POH_LIFNR"))===Number(e.LIFNR)});o.forEach(function(t){a.push(new P(_objectSpread(_objectSpread({},t.getObject()),e)))});return a});return new T({IT_PED:a})},_getAllData:function e(){var t=this;this._allData=true;return this._getNextPage().then(function(e){var o=e.data;o=o===void 0?{}:o;var a=o.items,n=a===void 0?[]:a;t._items=t._items.concat(n);return t._nextKeys.length>0?t._getAllData():Promise.resolve()})},_setFilterByColumn:function e(t){var o=t.column,a=t.filters,n=t.isEmptyValue,i=t.value;this._oProcessTable.getBinding("rows").filter(a);o.setFiltered(!n);o.setFilterValue(i);if(this._oFilteredPreviousColumn&&this._oFilteredPreviousColumn!==o){this._oFilteredPreviousColumn.setFilterValue("");this._oFilteredPreviousColumn.setFiltered(false)}this._oFilteredPreviousColumn=o;if(i===""){this._oFilteredPreviousColumn=null}},_openViewAttachment:function e(){var t=this;if(!this._oViewAttachment){var o=this.getView();w.load({id:o.getId(),name:"com.innova.sitrack.view.purchaseTracking.fragment.attachment.ViewAttachment",controller:this}).then(function(e){var a=e;o.addDependent(a);a.getEndButton().attachPress(a.close.bind(a));t._oViewAttachment=a;a.open()})}else{this._oViewAttachment.open()}},_openViewAttachmentDocument:function e(){var t=this;if(!this._oViewAttachmentDocument){var o=this.getView();w.load({id:o.getId(),name:"com.innova.sitrack.view.purchaseTracking.fragment.attachment.ViewAttachmentDocument",controller:this}).then(function(e){var a=e;o.addDependent(a);a.getEndButton().attachPress(a.close.bind(a));t._oViewAttachmentDocument=a;a.open()})}else{this._oViewAttachmentDocument.open()}},_responseAttachmentContent:function e(t){var o=t.data;var a=o.content;var n=this.getModel("base64");var i=n.getData();var r="data:".concat(i.extension,";base64,").concat(a);i.content=r;n.refresh();this._oPage.setBusy(false);if(i.extension){switch(i.extension.toUpperCase()){case"PNG":this._openViewAttachment();break;case"JPG":this._openViewAttachment();break;case"JPEG":this._openViewAttachment();break;case"PDF":this.onDownloadAttachment();break;default:this.onDownloadAttachment();break}}else if(o.url){if(o.url.search("\\\\")>-1||o.url.search("file:")>-1){this._onValidateFileExtension(o.url)}else{var s=document.createElement("a");s.href=o.url;s.target="_blank";document.body.appendChild(s);s.click()}}},_onValidateFileExtension:function e(t){var o=document.createElement("input");o.setAttribute("value",t);document.body.appendChild(o);o.select();document.execCommand("copy");document.body.removeChild(o);N(this.getMessageTextPool("K267"))},goto:function e(t,o){var a=document.createElement("script");a.onload=function(){document.location=t};a.onerror=function(){document.location=o};a.setAttribute("src",t);document.getElementsByTagName("head")[0].appendChild(a)},onDetailPayment:function e(){var t=this;var o=this.getModel("store").getData(),a=o.req;Promise.resolve(this._oPage.setBusy(true)).then(this._getSelectedIndices.bind(this,this._oProcessTable)).then(this._getDocContextByIndices.bind(this,this._oProcessTable,"EBELN")).then(function(e){var t=new x(a);t.IT_DOCKEYS=e.map(function(e){return new k(e.getObject())});return t}).then(O.post.bind(O,s.GET_PAYMENT_DETAIL)).then(function(e){var o=e.data;var a=o.catalog,n=o.items;if(C(n)){throw new Error("___No se encontraron datos")}t._oPaymentModel.setProperty("/catalog",a);t._oPaymentModel.setProperty("/items",n);t._oRouter.navTo("purchaseTrackingPaymentDetail")}).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))},onAssingHandler:function e(){try{this._oPage.setBusy(true);this._getSelectedIndices(this._oProcessTable).then(this._getDocContextByIndices.bind(this,this._oProcessTable,"BANFN")).then(this._openAssignUserDialog.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))}catch(e){this.errorHandler(e);this.getView().byId("buyerAU").setValue();this.getView().byId("reasonAU").setValue();this._oPage.setBusy(false)}},onAssingUserHandler:function e(){Promise.resolve(this._oAssignUserDialog.setBusy(true)).then(this._createRequestAssignUser.bind(this)).then(O.post.bind(O,s.GET_ASSIGN_USER)).then(this._updateTableProcess.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oAssignUserDialog.setBusy.bind(this._oAssignUserDialog,false))},onReturnHandler:function e(t){try{this._oModel.setProperty("/returnOption",t);this._oPage.setBusy(true);this._getSelectedIndices(this._oProcessTable).then(this._getDocContextByIndices.bind(this,this._oProcessTable,"BANFN")).then(this._openReturnSolPedDialog.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))}catch(e){this.errorHandler(e);this._oPage.setBusy(false)}},onReturnSolPedHandler:function e(){var t=this;Promise.resolve(this._oReturnSolPedDialog.setBusy(true)).then(this._createRequestReturnSolPed.bind(this)).then(O.post.bind(O,s.GET_RETURN_SOL_PED)).then(function(e){var o=e.data;t._aSolPedNotifications=o;t.onUpdateMonitor();t._oModel.updateBindings();t._oReturnSolPedDialog.close()}).catch(this.errorHandler.bind(this)).finally(this._oReturnSolPedDialog.setBusy.bind(this._oReturnSolPedDialog,false))},onEmailHandler:function e(){try{this._oPage.setBusy(true);this._getSelectedIndices(this._oProcessTable).then(this._getDocContextByIndices.bind(this,this._oProcessTable,"EBELN")).then(function(e){return O.post(s.GET_EMAIL_PROV,new _({IT_PROV:e.map(function(e){return new m(e.getObject())})}))}).then(this._openEmailDialog.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))}catch(e){this.errorHandler(e);this._oPage.setBusy(false)}},onReminberHandler:function e(){var t=this;Promise.resolve(this._oEmailDialog.setBusy(true)).then(this._createReminberRequest.bind(this)).then(O.post.bind(O,s.GET_REMINDER)).then(function(e){var o=e.data;t._setPedNotifications(o);t._oModel.updateBindings();t._oEmailDialog.close()}).catch(this.errorHandler.bind(this)).finally(this._oEmailDialog.setBusy.bind(this._oEmailDialog,false))},onRowSelectionChange:function e(t){var o=this;var a=t.getParameter("selectAll");if(a&&this._hasMorePages()){this._oPage.setBusy(true);this._getAllData().then(function(){o._setNewData(o._items);o._oProcessTable.selectAll()}).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))}},onFilterByColumn:function e(t){var o=this;t.preventDefault();var a=t.getParameter("column");var n=t.getParameter("value");var i=C(n);var r=i?[]:[new B(a.getName(),L.Contains,"".concat(n))];var s=Promise.resolve(this._oPage.setBusy(true));if(this._hasMorePages()){s=this._getAllData().then(function(){o._setNewData(o._items)})}s.then(this._setFilterByColumn.bind(this,{column:a,filters:r,isEmptyValue:i,value:n})).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))},onSendApprovers:function e(t){var o=t.getSource().data().target;var a=this.getModel("store");a.setProperty("/approvalTarget",o);this._oPage.setBusy(true);this._getSelectedIndices(this._oProcessTable).then(this.goToApprovals.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))},goToApprovals:function e(){var t=this.getModel("store");var o=[];var a=this.getModel("process").getData().data;var n=this._oProcessTable.getSelectedIndices();if(!this._oFilteredPreviousColumn){n.forEach(function(e){o.push(a[e])})}else{var i=this._oFilteredPreviousColumn.getName();var r=this._oFilteredPreviousColumn.getFilterValue();var s=a.filter(function(e){return e[i]===r});n.forEach(function(e){o.push(s[e])})}t.setProperty("/processSelected",o);this._oRouter.navTo("approvals")},onSaveDocuments:function e(){var t=this;this._oPage.setBusy(true);var o=this.getModel("store").getData(),a=o.keys,n=o.req;n.IT_DOCKEYS=a;this._getSelectedIndices(this._oProcessTable).then(this._getDocContextByIndices.bind(this,this._oProcessTable,"update")).then(this._buildPedSolped.bind(this)).then(this._fetchApiToUpdateDocument.bind(this)).then(O.post.bind(O,"".concat(s.GET_PROCESS_SELECTED),n)).then(function(e){var o=e.data;o=o===void 0?{}:o;var a=o.items,n=a===void 0?[]:a;var i=t._buildRows(n);t._oModel.setProperty("/data",[]);t._oModel.setProperty("/data",i)}).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))},_buildPedSolped:function e(t){var o=this._createPed(t);var a=this._createSolPed(t);if(C(o)&&C(a)){throw new Error(this.getMessageTextPool("K345"))}return{pedido:o,solPed:a}},_createPed:function e(t){return t.filter(function(e){return!C(e.getProperty("EBELN"))}).map(function(e){return new v(e.getObject())}).filter(function(e){return e.isUpdate()})},_createSolPed:function e(t){return t.filter(function(e){return!C(e.getProperty("BANFN"))||C(e.getProperty("EBELN"))}).map(function(e){return new y(e.getObject())}).filter(function(e){return e.isUpdate()})},onUpdateMonitor:function e(){var t=this;var o=this.getModel("store").getData(),a=o.keys,n=o.req;n.IT_DOCKEYS=a;Promise.resolve(this._oPage.setBusy(true)).then(O.post.bind(O,"".concat(s.GET_PROCESS_SELECTED),n)).then(function(e){var o=e.data;o=o===void 0?{}:o;var a=o.items,n=a===void 0?[]:a;var i=t._buildRows(n);t._oModel.setProperty("/data",[]);t._oModel.setProperty("/data",i)}).catch(this.errorHandler.bind(this)).finally(function(){t._scrollTable=false;t._oPage.setBusy(false)})},onCreateBid:function e(){try{this._oPage.setBusy(true);this._getSelectedIndices(this._oProcessTable).then(this._navToBiddingDetail.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))}catch(e){this.errorHandler(e);this._oPage.setBusy(false)}},errorHandlerSearch:function e(){F.success(N(this.getMessageTextPool("K266")))},onExportExcel:function e(){var t=this;var o=this.getModel("process");var a=o.getProperty("/data");var n=this;var i=this.getModel("store").getData(),l=i.keys,c=i.req;c.IT_DOCKEYS=l;if(a.length===l.length){r.exportDataInXlsx({catalog:Object.values(o.getProperty("/allCatalog")),data:o.getProperty("/data")});n._oProcessTable.setSelectedIndex(-1)}else{Promise.resolve(this._oPage.setBusy(true)).then(O.post.bind(O,"".concat(s.GET_PROCESS_SELECTED),c)).then(function(e){var a=e.data;a=a===void 0?{}:a;var i=a.items,s=i===void 0?[]:i;var l=t._buildRows(s);t._oModel.setProperty("/data",[]);t._oModel.setProperty("/data",l);r.exportDataInXlsx({catalog:Object.values(o.getProperty("/allCatalog")),data:o.getProperty("/data")});n._oProcessTable.setSelectedIndex(-1)}).catch(this.errorHandler.bind(this)).finally(function(){t._scrollTable=false;t._oPage.setBusy(false)})}},_updateTableProcess:function e(t){var o=this;var a=t.data;var n=this.getModel("store").getData(),i=n.keys,r=n.req;r.IT_DOCKEYS=i;Promise.resolve(this._oPage.setBusy(true)).then(O.post.bind(O,"".concat(s.GET_PROCESS_SELECTED),r)).then(function(e){var t=e.data;t=t===void 0?{}:t;var a=t.items,n=a===void 0?[]:a;var i=o._buildRows(n);o._oModel.setProperty("/data",[]);o._oModel.setProperty("/data",i)}).catch(this.errorHandler.bind(this)).finally(function(){o._aSelectedContext.forEach(function(e){var t=e.getObject();var o=I(a,{BANFN:e.getProperty("BANFN"),BNFPO:e.getProperty("BNFPO")});if(!C(o)){var n=_slicedToArray(o,1),i=n[0].TYPE;t.notification={data:o,type:i}}});o._oModel.updateBindings();o._oAssignUserDialog.close();o._scrollTable=false;o._oPage.setBusy(false)})},_fetchApiToUpdateDocument:function e(t){var o=t.pedido,a=t.solPed;var n=[this._getReqObjToUpdatePed.bind(this,o),this._getReqObjToUpdateSolPed.bind(this,a)];return n.reduce(function(e,t){return e.then(function(e){return t().then(function(t){return[].concat(_toConsumableArray(e),[t])})})},Promise.resolve([]))},_getReqObjToUpdatePed:function e(t){var o=this;return!C(t)?O.post(s.GET_UPDATE_PED,new b({IT_PEDMODIF:t})).then(function(e){var t=e.data;o._aPedNotifications=t}):Promise.resolve()},_getReqObjToUpdateSolPed:function e(t){var o=this;return!C(t)?O.post(s.GET_UPDATE_SOL_PED,new D({IT_SOLMODIF:t})).then(function(e){var t=e.data;o._aSolPedNotifications=t}):Promise.resolve()},_setPedNotifications:function e(t){this._aSelectedContext.forEach(function(e){var o=e.getObject();var a=I(t,{EBELN:e.getProperty("EBELN"),EBELP:e.getProperty("EBELP")});if(!C(a)){var n=_slicedToArray(a,1),i=n[0].TYPE;o.notification={data:a,type:i}}})},onUpdateDocuments:function e(){this._getSelectedIndices(this._oProcessTable).then(this._onOpenUpdateDocuments.bind(this)).catch(this.errorHandler.bind(this))},_onOpenUpdateDocuments:function e(){var t=this;if(!this._oModifyDocuments){var o=this.getView();w.load({id:o.getId(),name:"com.innova.sitrack.view.purchaseTracking.fragment.process.ModifyDocuments",controller:this}).then(function(e){var a=e;o.addDependent(a);a.getEndButton().attachPress(t.closeFormModifyDocuments.bind(t));t._oModifyDocuments=a;a.open()})}else{this._oModifyDocuments.open()}},handleModifyDocuments:function e(){var t=this._oProcessTable.getSelectedIndices();var o=this.getModel("process");var a=o.getData().data;var n=this.byId("rbModifyDocument");var i=n.getButtons();var r=this.getValuesFormModifyDocuments();t.forEach(function(e){var t=a[e];r.forEach(function(e){var o=e.fieldname;if(o.search("PR")>-1){if(i[0].getSelected()){t.update=true;t[o]=e.value;t["".concat(o,"_FLAG")]="X"}}else if(o.search("POI")>-1){if(i[1].getSelected()){t.update=true;if(o==="POI_LFDAT"){t.POI_EINDT=e.value;t.POI_EINDT_FLAG="X"}else if(o==="POI_EBAKZ"){t.POI_ELIKZ=e.value;t.POI_ELIKZ_FLAG="X"}else{t[o]=e.value;t["".concat(o,"_FLAG")]="X"}}}})});o.refresh();this._oModifyDocuments.close();this.onSaveDocuments()},getValuesFormModifyDocuments:function e(){var t=this;var o=[];this._oModifyDocuments.getControlsByFieldGroupId("formModifyDocuments").forEach(function(e){var a=e.getMetadata().getName();var n=a.split(".").reverse(),i=_slicedToArray(n,1),r=i[0];var s="getValue".concat(r);if(t[s]){var l=e.data();var c={};c.fieldname=l.fieldname;c.value=t[s](e);o.push(c);t["clean".concat(r)](e)}});return o},getValueDatePicker:function e(t){return t.getValue()},getValueSwitch:function e(t){return t.getState()?"X":null},closeFormModifyDocuments:function e(t){var o=this;this._oModifyDocuments.getControlsByFieldGroupId("formModifyDocuments").forEach(function(e){var t=e.getMetadata().getName();var a=t.split(".").reverse(),n=_slicedToArray(a,1),i=n[0];var r="clean".concat(i);if(o[r]){o[r](e)}});if(t){this._oModifyDocuments.close()}},cleanDatePicker:function e(t){t.setValue()},cleanSwitch:function e(t){t.setState(false)},onSelectOptionModifyDocument:function e(t){var o=t.getSource();var a=o.getButtons();var n=this.byId("fieldsContainerSolPed");var i=this.byId("fieldsContainerPed");if(a[0].getSelected()){n.setVisible(true);i.setVisible(false)}else{n.setVisible(false);i.setVisible(true)}this.closeFormModifyDocuments(false)},onResetFilters:function e(){try{this._oPage.setBusy(true);var t=this._oProcessTable.getColumns().length;var o=0;this._oFilteredPreviousColumn=null;for(o=0;o<t;o+=1){var a=this._oProcessTable.getColumns()[o];this._oProcessTable.getBinding("rows").filter([]);a.setFilterValue("");a.setFiltered(false)}}catch(e){this.errorHandler(e)}finally{this._oPage.setBusy(false)}},onConsultAttachment:function e(t,o){this._oPage.setBusy(true);try{var a=o.split("/")[2];var n=t.INF_ADJUNTOS[a];var i={id:n.ADJID,name:n.NOMBRE,extension:n.EXTENSION};var r=new U(i);this.setModel(r,"base64");var l=new u(i);O.post("".concat(s.GET_ATTACHMENT),l).then(this._responseAttachmentContent.bind(this))}catch(e){this.errorHandler(e);this._oPage.setBusy(false)}},onConsultAttachmentSolPed:function e(t,o){this._oPage.setBusy(true);try{var a=o.split("/")[2];var n=t.INF_ADJUNTO_SOLP[a];var i={id:n.ADJID,name:n.NOMBRE,extension:n.EXTENSION};var r=new U(i);this.setModel(r,"base64");var l=new u(i);O.post("".concat(s.GET_ATTACHMENT),l).then(this._responseAttachmentContent.bind(this))}catch(e){this.errorHandler(e);this._oPage.setBusy(false)}},onDownloadAttachment:function e(){var t=this.getModel("base64");var o=t.getData();var a=o.content;var n=document.createElement("a");n.href=a;n.download="".concat(o.name,".").concat(o.extension);n.click()},onChangeMailAddress:function e(t){var o=t.getSource();var a=t.getParameters().value;var n=/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/;var i=o.getTokens();if(a.match(n)){o.setValue();o.setTokens([]);var r=[];i.forEach(function(e){r.push(new H({text:e.getText(),key:e.getText()}))});r.push(new H({text:a,key:a}));o.setTokens(r)}else{N(this.getMessageTextPool("K230"))}},onChangeEmails:function e(t){var o=t.getSource();var a=t.getParameters().value;var n=t.getSource().getBindingContext(),i=n.sPath;var r=o.getModel();var s=r.getProperty(i),l=s.E_MAILS;var c={};c.EMAIL=a;c.RECIPNAME="";c.REGID=0;c.UNAME="";if(!l){l=[];l.push(c);o.setValue();r.setProperty("".concat(i,"/E_MAILS"),l);r.refresh()}else{l.push(c);o.setValue();r.refresh()}},onOpenUploadAttached:function e(t){var o=t.getSource();var a=o.data(),n=a.target;var i={target:n,desc:"",url:"",positions:[]};var r=new U(i);this.setModel(r,"oUploadAttached");this._getSelectedIndices(this._oProcessTable).then(this._getDocContextByIndices.bind(this,this._oProcessTable,"BANFN")).then(this._openUploadAttached.bind(this)).catch(this.errorHandler.bind(this)).then(this._oPage.setBusy.bind(this._oPage,false))},_openUploadAttached:function e(){var t=this;var o=this.getModel("oUploadAttached");var n=o.getData();n.positions=this._aSelectedContext;if(!this._oUploadAttachedDialog){var i=this.getView();w.load({id:i.getId(),name:"com.innova.sitrack.view.purchaseTracking.dialog.UploadAttached",controller:this}).then(function(e){var o=e;i.addDependent(o);o.addStyleClass(t.getOwnerComponent().getContentDensityClass());o.getEndButton().attachPress(o.close.bind(o));o.setModel(new U(n));t._oUploadAttachedDialog=o;o.open();a.addValidatorEmailMultiInputs({fields:o.getControlsByFieldGroupId("email")})})}else{this._oUploadAttachedDialog.setModel(new U(n));this._oUploadAttachedDialog.open();a.addValidatorEmailMultiInputs({fields:this._oUploadAttachedDialog.getControlsByFieldGroupId("email")})}},onUploadAttached:function e(){var t=this._oUploadAttachedDialog.getModel("oUploadAttached").getData();if(t.desc||t.url){this._oUploadAttachedDialog.setBusy(true);this._createUpdateAttachedRequest().map(function(e){return O.post.bind(O,"".concat(s.POST_UPLOAD_ATTACHED),e)}).reduce(function(e,t){return e.then(function(e){return t().then(function(t){return[].concat(_toConsumableArray(e),[t])})})},Promise.resolve([])).then(this._processResponseAttached.bind(this)).catch(this.errorHandler.bind(this)).finally(this._oUploadAttachedDialog.setBusy.bind(this._oUploadAttachedDialog,false))}else{N(this.getMessageTextPool("K069"))}},_processResponseAttached:function e(){F.success("Adjunto creado satisfactoriamente");this.onUpdateMonitor();this._oUploadAttachedDialog.close()},_navToBiddingDetail:function e(){var t=this;var o=this.getModel("store");var a=this._oProcessTable.getSelectedIndices();var n=this.getModel("process").getData().data;var i=[];a.forEach(function(e){i.push(n[e])});Promise.resolve(this._oPage.setBusy(true)).then(O.post.bind(O,s.GET_SEARCH_HELP,new V("WERKS"))).then(function(e){var a=e.data;var n=a.data;i.forEach(function(e){if(e.LICITA!==""||e.PR_LOEKZ!==""||e.PR_BLCKD!==""||e.PR_EBAKZ!==""){throw new Error("".concat(t.getMessageTextPool("K342")," ").concat(e.BANFN," / ").concat(e.BNFPO))}if(e.EBELN!==""&&e.PR_MENGE<=e.POI_MENGE){throw new Error("".concat(t.getMessageTextPool("K342")," ").concat(e.BANFN," / ").concat(e.BNFPO))}var o=n.find(function(t){return t.FCODE1===e.PR_WERKS});e.adStreet=o.FCODE2});o.setProperty("/processSelected",i);o.setProperty("/processData",i[0]);t._oRouter.navTo("purchaseTrackingManage")}).catch(this.errorHandler.bind(this)).finally(this._oPage.setBusy.bind(this._oPage,false))}})});