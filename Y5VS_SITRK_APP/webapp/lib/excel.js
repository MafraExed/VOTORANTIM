"use strict";function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,o)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}
/*!
 * SiTrack - Seguimiento de compras
 * (c) Copyright 2022 Innova Internacional S.A.S.
 */sap.ui.define(["com/innova/model/formatter","com/innova/util/index","com/innova/vendor/moment","com/innova/vendor/xlsx","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/core/util/Export","sap/ui/core/util/ExportColumn","sap/ui/core/util/ExportTypeCSV","sap/ui/model/Filter","sap/ui/model/json/JSONModel","sap/ui/model/Sorter","sap/ui/core/format/DateFormat"],function(e,t,r,o,n,a,i,s,c,l,u,d,f){var p={exportDataInXlsx:function e(t){var n=this;var a=t.catalog,i=t.data;return new Promise(function(e){var t=JSON.parse(JSON.stringify(a));var s=JSON.parse(JSON.stringify(i));n.formatRowsDates(s);var c=t.reduce(p.reduceCatalog,{oRowHeader:{},aColInfo:[],header:[],oRowData:{},oDataType:{}});for(var l=0;l<16;l++){var u={hidden:true,width:0,wpx:0,wch:0};c.aColInfo.push(u)}var d=n.getDataFormats(s);d.unshift(c.oRowHeader);var f=o.utils.json_to_sheet(d,{header:c.header,skipHeader:false});f["!cols"]=c.aColInfo;f["!rows"]=[{hidden:true,width:0,wpx:0,wch:0}];var h=o.utils.book_new();o.utils.book_append_sheet(h,f,"Sheet1");o.writeFile(h,"export_".concat(r().format(r.HTML5_FMT.DATETIME_LOCAL).toString(),".xlsx"),{Props:{Author:"Innova - SIPRE"}});e()})},formatRowsDates:function e(t){var r=f.getDateInstance({source:{pattern:"timestamp"},pattern:"dd/MM/yyyy"});t.forEach(function(e){var t=Object.keys(e);t.forEach(function(t){if(t.indexOf("PR_BADAT")>-1||t.indexOf("PR_LFDAT")>-1||t.indexOf("POI_EINDT")>-1){e[t]=e[t]?r.format(new Date(e[t].slice(0,19))):e[t]}})});return t},getDataFormats:function e(t){t.forEach(function(e){var t=Object.keys(e);t.forEach(function(t){if(t.indexOf("FIX_VAL")>-1||t.indexOf("TOTAL")>-1){if(t.indexOf("COLOR")===-1){e[t]=parseFloat(e[t])}}})});return t},floatNumberFormatExcel:function t(r){return!r||r.length===0?r:e.getNumberFormat().format(r)},exportDataInCsv:function t(r){var o=r.catalog,a=r.data,f=r.text;var p=new i({exportType:new s({separatorChar:";",charset:"utf-8"}),models:new u({catalog:o,node:a})});p.bindRows({path:"/node"});p.bindColumns({path:"/catalog",sorter:new d("ColPos"),filters:[new l({path:"TECH",operator:"NE",value1:"X"}),new l({path:"NO_OUT",operator:"NE",value1:"X"})],factory:function t(r,o){var n=o.getObject();var a=n.__period,i=n.Fieldname;if(!a){return new c({name:n.Reptext,template:{content:{parts:[i],formatter:function e(t){return t}}}})}return new c({name:n.Reptext,template:{content:{parts:["".concat(i,"Cober"),"".concat(i,"Sinstk"),"".concat(i,"Stksob"),"".concat(i,"Iconname"),"".concat(i,"Cobres")],formatter:function t(r,o,n,a,i){if(o==="X"){return f.sK013}if(n==="X"){return f.sK014}switch(a){case"ICON_SUP_PUNTO_PED":return f.sK062;case"ICON_INF_PUNTO_PED":return f.sK063;case"ICON_CERO_STK_DISP":return f.sK064;case"ICON_DISP_SUP_SMAX":return f.sK065;default:if(r){return e.floatNumberFormat(r)}if(i==="X"){return"*"}return""}}}}})}});return p.saveFile().catch(function(e){return n.error("Error when downloading data. Browser might not be supported!\n\n".concat(e))}).then(function(){return p.destroy()})},showImportDialog:function e(){var t=this;var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"com.innova.sipre.view.shared.dialog.FileUploaderDialog";if(!this._oFileUploaderDialog){a.load({id:this.getView().getId(),name:r,controller:this}).then(function(e){t.getView().addDependent(e);var r=t.byId("fileUploader");r.attachTypeMissmatch(p._typeMissmatch);e.addStyleClass(t.getOwnerComponent().getContentDensityClass());e.getBeginButton().attachPress(p.handleUploadFile.bind(t,r));e.getEndButton().attachPress(e.close.bind(e));t._oFileUploaderDialog=e;e.open()}).catch(this.errorHandler.bind(this))}else{this.byId("fileUploader").setValue();this._oFileUploaderDialog.open()}}};Object.defineProperty(p,"_typeMissmatch",{value:function e(r){var o=r.getSource().getFileType().map(function(e){return"*.".concat(e)}).join(", ");t.showMessageToast("The file type *.".concat(r.getParameter("fileType")," is not supported. Choose one of the following types: ").concat(o))}});Object.defineProperty(p,"handleUploadFile",{value:function e(t){var r=this;var o=t.getFocusDomRef();var n=o.files[0];if(!t.getValue()){throw new Error(this.getMessageTextPool("058"))}var a=new FileReader;a.onload=function(e){return Promise.resolve(r._oFileUploaderDialog.setBusy.bind(r._oFileUploaderDialog,true)).then(p.readFileXLSX.bind(p,e.target.result)).then(r._processExcelData.bind(r)).catch(r.errorHandler.bind(r)).then(t.clear.bind(t)).then(t.setValue.bind(t)).then(r._oFileUploaderDialog.setBusy.bind(r._oFileUploaderDialog,false)).then(r._oFileUploaderDialog.close.bind(r._oFileUploaderDialog))};a.readAsArrayBuffer(n)}});Object.defineProperty(p,"readFileXLSX",{value:function e(t){return new Promise(function(e){var r=o.read(t,{type:"buffer",cellDates:true,cellNF:false,cellText:true});var n=o.utils.sheet_to_json(r.Sheets[r.SheetNames[0]],{raw:true,dateNF:"YYYY-MM-DD"});n.shift();n=n.map(function(e){return _objectSpread(_objectSpread({},e),{},{modify:"X "})});e(n)})}});var h=function e(t){var r=t.NO_OUT,o=t.TECH;return r!=="X"&&o!=="X"};Object.defineProperty(p,"reduceCatalog",{value:function e(t,r){var o=r.FIELDNAME;var n=r.REPTEXT||r.SCRTEXT_L||"";Object.assign(t.oRowHeader,_defineProperty({},o,"".concat(n," (").concat(o,")")));Object.assign(t.oRowData,_defineProperty({},o,""));t.header.push(o);var a={hidden:true,width:0,wpx:0,wch:0};if(h(r)){a={wch:(n.length||20)+1}}t.aColInfo.push(a);Object.assign(t.oDataType,_defineProperty({},o,r.INTTYPE));return t}});Object.defineProperty(p,"sortCatalog",{value:function e(t){return t.sort(function(e,t){if((e.TECH!=="X"||e.NO_OUT!=="X")&&(t.TECH==="X"||t.NO_OUT==="X")){return-1}if((e.TECH==="X"||e.NO_OUT==="X")&&(t.TECH!=="X"||t.NO_OUT!=="X")){return 1}return 0})}});return p});