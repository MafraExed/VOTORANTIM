sap.ui.define(["sap/ui/core/mvc/Controller"], function(Controller) {
	"use strict";

	var dialog = new sap.m.BusyDialog({
		text: 'Processando'
	});

	return Controller.extend("com.sap.votorantim.grupoZHCM_FERIAS_VT.controller.View1", {
		/**
		 *@memberOf com.sap.votorantim.grupoZHCM_FERIAS_VT.controller.View1
		 */

		onInit: function() {

			dialog.open();
			var oView = this.getView();
			var that = this;
			this.get_periodo_ess(this);

		},

		get_periodo_ess: function(evt) {

			var that = this;
			var oModel = this.getOwnerComponent().getModel("ferias_ess");
			var oModeli = new sap.ui.model.json.JSONModel();
			var sFilter = "";

			var sPath = "/PERIODOS";
			oModel.read(sPath, {
				success: function(oData, oResponse) {

					oModeli.setData(oData);
					sap.ui.getCore().setModel(oModeli, "periodo");
					that.getView().setModel(oModeli, "periodo");

					var nome = oData.results[0].Nome;
					var lista = evt.getView().byId("list");
					lista.setHeaderText(nome);

					dialog.close();
				},
				error: function() {
					sap.m.MessageToast.show("Férias não encontradas!");
				}

			});

		},

		get_periodos_ess: function(evt, valor) {
		
			var that = this;
			var oModel	= this.getOwnerComponent().getModel("ferias_ess");
			var oModeli = new sap.ui.model.json.JSONModel();
			var sFilter = "Index eq " + valor;
			var sPath = "/PROGRAMAR";

			oModel.read(sPath, {
				urlParameters: {
					"$filter": sFilter
				},
				async: false,
				success: function(oData, oResponse) {

					oModeli.setData(oData);
					sap.ui.getCore().setModel(oModeli, "periodos_todos");
					
					that.go_detalhe();

				},
				error: function() {
					sap.m.MessageToast.show("Férias não encontradas");
				}

			});

		},

		get_periodo_ess_detalhe: function(evt, valor) {
			var that = this;
			var oModel = this.getOwnerComponent().getModel("ferias_ess");
			var oModeli = new sap.ui.model.json.JSONModel();
			var sFilter = "Index eq " + valor;

			var sPath = "/GET_DETALHE_PER";

			oModel.read(sPath, {
				urlParameters: {
					"$filter": sFilter
				},
				async: false,
				success: function(oData, oResponse) {

					oModeli.setData(oData);
					sap.ui.getCore().setModel(oModeli, "periodo_det");

					that.get_periodos_ess(that, valor);
					

				},
				error: function() {
					sap.m.MessageToast.show("Férias não encontradas");
				}

			});

		},

		go_detalhe: function(evt) {
			var oRouter = sap.ui.core.UIComponent.getRouterFor(this);
			oRouter.initialize();
			oRouter.navTo("View2");
		},
		go: function(evt) {

			var that = this;
			dialog.open();

			var sModelPath = evt.getSource().getBindingContext("periodo").getPath();
			var index = sModelPath.replace('/results/', '');

			that.get_periodo_ess_detalhe(that, index);

			dialog.close();
		},
		/**
		 *@memberOf com.sap.votorantim.grupoZHCM_FERIAS_VT.controller.View1
		 */
		back: function() {

			var oRouter = sap.ui.core.UIComponent.getRouterFor(this);
			oRouter.navTo("View1");
			this.getView().invalidate();

			//This code was generated by the layout editor.
		}
	});
});