sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Button","sap/m/Text","sap/m/MessageBox","sap/m/Dialog","../model/formatter"],function(e,t,r,n,a,s,o,i,g){"use strict";var l;var u;var d;var c;var m;return e.extend("Y5VC_PAINEL_NE2.Y5VC_PAINEL_NE2.controller.Promessas",{formatter:g,onInit:function(){var e,r=new t({busy:true,delay:0});this.getRouter().getRoute("Promessas").attachPatternMatched(this._onObjectMatched,this);e=this.getView().getBusyIndicatorDelay();this.setModel(r,"PromessasView");this.getOwnerComponent().getModel().metadataLoaded().then(function(){r.setProperty("/delay",e)})},_onObjectMatched:function(e){l=e.getParameter("arguments").Fikrs;u=e.getParameter("arguments").Kunnr;d=e.getParameter("arguments").Knkli;c=e.getParameter("arguments").NivelDet;var t=this.getView().byId("IdProm");t.rebindTable("e")},getText:function(e){m=e.getText()},Cancelamento:function(e){var t=this.getView().byId("table2").getSelectedIndices();var r=this.getView().byId("table2");var n=this;var s=this.getView().getModel();s.setUseBatch(true);var g={};var l;var u=this.getView().byId("IdProm");if(t.length<1){sap.m.MessageBox.error("Nenhum item selecionado");return}if(t.length>1){sap.m.MessageBox.error("Selecionar apenas um item");return}var d=r.getContextByIndex([t[0]]).getObject().StProm;if(d!=="01"){sap.m.MessageBox.error("É possível cancelar apenas items com status '01'");return}var c="Motivo do Cancelamento (50 caracteres)";var x=new i({title:c,type:"Message",content:[new sap.m.Label({text:"",labelFor:"submitDialogTextarea"}),new sap.m.TextArea("submitDialogTextarea",{id:"IdTextArea",editable:true,growing:true,rows:1,cols:100,liveChange:function(e){m=e.getParameter("value")}})],beginButton:new a({text:"Ok",press:function(e){if(!m){sap.m.MessageBox.error("É necessário informar o motivo do cancelamento");return}g={};g.Fikrs=r.getContextByIndex([t[0]]).getObject().Fikrs;g.Belnr=r.getContextByIndex([t[0]]).getObject().Belnr;g.Bukrs=r.getContextByIndex([t[0]]).getObject().Bukrs;g.Gjahr=r.getContextByIndex([t[0]]).getObject().Gjahr;g.Buzei=r.getContextByIndex([t[0]]).getObject().Buzei;g.Kunnr=r.getContextByIndex([t[0]]).getObject().Kunnr;g.Comentario=m;m="";g.Knkli=r.getContextByIndex([t[0]]).getObject().Knkli;g.DtProm=r.getContextByIndex([t[0]]).getObject().DtProm;g.DtCriReg=r.getContextByIndex([t[0]]).getObject().DtCriReg;g.HrCriReg=r.getContextByIndex([t[0]]).getObject().HrCriReg;g.Acao="C";s.update("/ZET_VCFI_PROMESSASet(Fikrs='"+g.Fikrs+"',Belnr='"+g.Belnr+"',Bukrs='"+g.Bukrs+"',Gjahr='"+g.Gjahr+"',Buzei='"+g.Buzei+"',DtCriReg='"+"1"+"',HrCriReg='"+"1"+"')",g,{success:function(e,t){if(!l){l="Cancelamento efetuado";o.show(l);u.rebindTable("e")}},error:function(e){if(!l){for(var t=0;t<JSON.parse(e.responseText).error.innererror.errordetails.length;t++){var r="- "+JSON.parse(e.responseText).error.innererror.errordetails[t].message+"\n";l=l+r}sap.m.MessageBox.error(l)}}});x.close()}}),endButton:new a({text:"Cancelar",press:function(){x.close()}}),afterClose:function(){x.destroy()}});x.open()},formatStateEStatus:function(e){if(e==="01"){return"Information"}else if(e==="02"){return"Error"}else if(e==="03"){return"Success"}else if(e==="04"){return"Warning"}return"None"},Edicao:function(e){var t=this.getView().byId("table2").getSelectedIndices();var r=this.getView().byId("table2");var n=this;var g=this.getView().getModel();g.setUseBatch(true);var l={};var u;var d=this.getView().byId("IdProm");if(t.length<1){sap.m.MessageBox.error("Nenhum item selecionado");return}if(t.length>1){sap.m.MessageBox.error("Selecionar apenas um item");return}var c=r.getContextByIndex([t[0]]).getObject().StProm;if(c!=="01"){sap.m.MessageBox.error("É possível editar apenas items com status '01'");return}var m="Confirma a alteração do item selecionado?";var x=new i({title:"Confirmação",type:"Message",content:new s({text:m}),beginButton:new a({text:"Sim",press:function(){l={};l.Fikrs=r.getContextByIndex([t[0]]).getObject().Fikrs;l.Belnr=r.getContextByIndex([t[0]]).getObject().Belnr;l.Bukrs=r.getContextByIndex([t[0]]).getObject().Bukrs;l.Gjahr=r.getContextByIndex([t[0]]).getObject().Gjahr;l.Buzei=r.getContextByIndex([t[0]]).getObject().Buzei;l.Kunnr=r.getContextByIndex([t[0]]).getObject().Kunnr;l.Knkli=r.getContextByIndex([t[0]]).getObject().Knkli;l.Comentario=r.getContextByIndex([t[0]]).getObject().Comentario;l.DtProm=r.getContextByIndex([t[0]]).getObject().DtProm;l.DtCriReg=r.getContextByIndex([t[0]]).getObject().DtCriReg;l.HrCriReg=r.getContextByIndex([t[0]]).getObject().HrCriReg;l.Acao="E";g.update("/"+"ZET_VCFI_PROMESSASet(Fikrs='"+l.Fikrs+"',Belnr='"+l.Belnr+"',Bukrs='"+l.Bukrs+"',Gjahr='"+l.Gjahr+"',Buzei='"+l.Buzei+"',DtCriReg='"+"1"+"',HrCriReg='"+"1"+"')",l,{success:function(e,t){if(!u){u="Alteração efetuada";o.show(u);d.rebindTable("e")}},error:function(e){if(!u){for(var t=0;t<JSON.parse(e.responseText).error.innererror.errordetails.length;t++){var r=JSON.parse(e.responseText).error.innererror.errordetails[t].message;u=r}sap.m.MessageBox.error(u)}}});x.close()}}),endButton:new a({text:"Cancelar",press:function(){x.close()}}),afterClose:function(){x.destroy()}});x.open()},BeforeTable:function(e){e.getParameter("bindingParams").filters.push(new sap.ui.model.Filter({path:"Fikrs",operator:"EQ",value1:l}));e.getParameter("bindingParams").filters.push(new sap.ui.model.Filter({path:"Kunnr",operator:"EQ",value1:u}));e.getParameter("bindingParams").filters.push(new sap.ui.model.Filter({path:"Knkli",operator:"EQ",value1:d}));e.getParameter("bindingParams").filters.push(new sap.ui.model.Filter({path:"NivelDet",operator:"EQ",value1:c}))},_bindView:function(e){var t=this.getModel("PromessasView"),r=this.getModel();this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){r.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("PromessasView"),r=e.getElementBinding();if(!r.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}var n=this.getResourceBundle(),a=e.getBindingContext().getObject(),s=a.Belnr,o=a.Cliente;t.setProperty("/busy",false);this.addHistoryEntry({title:this.getResourceBundle().getText("objectTitle")+" - "+o,icon:"sap-icon://enter-more",intent:"#Y5VC_PAINEL_NE2-display&/ZET_VCFI_HIST_NEGSet/"+s});t.setProperty("/saveAsTileTitle",n.getText("saveAsTileTitle",[o]));t.setProperty("/shareOnJamTitle",o);t.setProperty("/shareSendEmailSubject",n.getText("shareSendEmailObjectSubject",[s]));t.setProperty("/shareSendEmailMessage",n.getText("shareSendEmailObjectMessage",[o,s,location.href]))}})});