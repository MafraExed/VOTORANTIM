sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","../lib/imageMapster","sap/ui/core/Fragment"],function(t,e,i,a,r){"use strict";return t.extend("cba.hr.sdvCalibracaoSF.controller.CalibrationRoom",{onInit:function(){var t=this;this.setLandingModel();this.setParticipantsContainer();this.getOwnerComponent().getService("ShellUIService").then(function(e){e.setBackNavigation(function(){t.backHome()})});var e=this.getOwnerComponent().getRouter();e.getRoute("TargetCalibrationRoom").attachMatched(this.onRouteMatched,this)},getI18nText:function(t){return this.getOwnerComponent().getModel("i18n").getResourceBundle().getText(t)},setParticipantsContainer:function(){this._calibrationRoomParticipants=this.getView().byId("calibrationRoomParticipants");this._calibrationRoomParticipantsPending=this.getView().byId("calibrationRoomParticipantsPending");this._calibrationRoomParticipantsPendingBox=this.getView().byId("calibrationRoomParticipantsPendingBox")},setPendingVisibility:function(){var t=this._calibrationRoomParticipantsPending.getItems();if(!t.length){var e=new sap.m.Text;e.setText(this.getI18nText("NoParticipants"));this._calibrationRoomParticipantsPending.addItem(e)}},onRouteMatched:function(t){var e=t.getParameter("arguments");var i=e.calibrationSessionId;var a=e.calibrationOwnerId;var r=this.getOwnerComponent().getModel("SFactors");this.setPageTitle(r,i);this._sessionId=i;this.setUniqueId();this.getCalibrationSessionParticipants(r,i,a)},setPageTitle:function(t,e){var i=this.getView().byId("calibrationRoomPage");var a=[];i.setTitle("");i._headerTitle.removeStyleClass("pageTitle");a.push(new sap.ui.model.Filter("sessionId","EQ",e));t.read("/CalibrationSession",{urlParameters:{$select:"sessionName"},filters:a,success:function(t){var e=t.results[0].sessionName;if(e){i.setTitle(e.toUpperCase());i._headerTitle.addStyleClass("pageTitle")}}})},setUniqueId:function(){this._uniqueId=Math.floor(+new Date/1e3)},getCalibrationSessionParticipants:function(t,e,i){var a=this;this._calibrationRoomParticipants.removeAllItems();this._calibrationRoomParticipantsPending.removeAllItems();sap.ui.core.BusyIndicator.show(0);var r=[];r.push(new sap.ui.model.Filter("sessionId","EQ",e));r.push(new sap.ui.model.Filter("ownerId","EQ",i));t.read("/CalibrationSession",{urlParameters:{$select:"userId,firstName,lastName,defaultFullName,jobCode,jobYears,age"},filters:r,success:function(t){var e=t.results;var i=[];var r=[];a.setVelocimetroMap();for(var o=0;o<e.length;o++){var n=e[o];var s=n.userId;var c=new sap.ui.core.HTML({id:a.createUniqueId(s),content:'<div id="'+a.createUniqueId(s)+'" class="w3-tag" >'+n.firstName+" "+n.lastName.trim().split(" ").slice(-1)+"</di>"});a._calibrationRoomParticipants.addItem(c);i.push(new sap.ui.model.Filter("userId","EQ",s));r.push(s)}a.getBackgroundCalibration(r,i,e)},error:function(t){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error(JSON.parse(t.responseText).error.message.value,{onClose:function(){a.backHome()}})}})},getBackgroundCalibration:function(t,e,i){var a=this;var r=this.getOwnerComponent().getModel("SFactors");var o=this.getAvaliablePosition();var n=function(){for(var e=0;e<t.length;e++){a.addParticipant(t[e],o.NOCALIB,i)}a.setPendingVisibility();sap.ui.core.BusyIndicator.hide()};if(e.length){r.read("/BackgroundCalibration",{urlParameters:{$select:"userId,resultado_pre_cultura,resultado_pre_desempenho,ano_pre,pos"},filters:e,success:function(e){for(var r=0;r<e.results.length;r++){var s=e.results[r];var c=a.getMapArea(s.resultado_pre_cultura,s.resultado_pre_desempenho);for(var u=0;u<t.length;u++){if(t[u]===s.userId){var l=a.isPos(s.pos);a.addParticipant(t.splice(u,1)[0],o[c],i,l);break}}}n()},error:function(t){sap.m.MessageToast.show(JSON.parse(t.responseText).error.message.value);n()}})}},getMapArea:function(t,e){var i=this.getLandingModel().getData().eixoCultura;var a=this.getLandingModel().getData().eixoDesempenho;var r=i[t];if(r){r=r+a[e]}if(!r){r="NOCALIB"}return r},setVelocimetroMap:function(){var t=this;var e=this.createId("imgVelocimetro");var i=$("#"+e);$("body").droppable({drop:function(e,a){var r=i.mapster("highlight");if(!r){t.returnToPosition(a)}t._originalPosition=undefined}});i.mapster({mapKey:"alt",fillOpacity:.2,fillColor:"ff0000",isSelectable:false,onConfigured:function(){i.siblings().css("z-index",0);i.css("z-index",10)}});i.droppable({drop:function(e,a){var r=i.mapster("highlight");$(a.draggable).css("z-index",20);if(r){var o=t.getUniqueId(a.draggable.context.id);t.gravaCalibracao(o,r,$(a.draggable))}}})},gravaCalibracao:function(t,e,i){var a=this.getLandingValues(e);var r=this.getOwnerComponent().getModel("SFactors",{refreshAfterChange:false});var o={success:"#4CC417",error:"#F75D59",warning:"#FFDB58"};i.css("color",o.warning);r.create("/BackgroundCalibration",{userId:t,resultado_pre_desempenho:a.desempenho,resultado_pre_cultura:a.cultura,ano_pre:this.thisYear()},{success:function(){i.css("color",o.success)},error:function(t){i.css("color",o.error);sap.m.MessageBox.error(JSON.parse(t.responseText).error.message.value)}})},thisYear:function(){return(new Date).getFullYear().toString()},isPos:function(t){return t==="X"},onSalvarComentarioPress:function(){var t=this;var e=sap.ui.getCore().byId("participantInfoTextComment");var i=this.getOwnerComponent().getModel("SFactors",{refreshAfterChange:false});this.dialogBusyStart(1);i.create("/BackgroundComments",{userId:this._participantId,results_relevants:e.getValue(),calibrationCommentsYear:this.convertCommentYear((new Date).getFullYear()).toString()},{success:function(){t.dialogBusyEnd(false);sap.m.MessageBox.success(t.getI18nText("Success"));t.onCloseParticipantInfo()},error:function(e){t.dialogBusyEnd(false);sap.m.MessageBox.error(JSON.parse(e.responseText).error.message.value)}})},convertCommentYear:function(t){return t-1579},getLandingValues:function(t){var e=this.getLandingModel();return e.getData().landingValues[t]},setLandingModel:function(){var t=this.getSystemId();var e=$.sap.getModulePath("cba.hr.sdvCalibracaoSF","/model/eixoCalibracao/"+t+".json");this._landingModel=new sap.ui.model.json.JSONModel;this._landingModel.loadData(e,false)},getLandingModel:function(){return this._landingModel},getSystemId:function(){var t=new sap.ui.model.json.JSONModel;t.loadData("/sap/bc/ui2/start_up?","",false);return t.getData().system},returnToPosition:function(t){var e=t.draggable[0];e.animate({left:this._originalPosition.left+"px",top:this._originalPosition.top+"px"},100);e.style.left=this._originalPosition.left+"px";e.style.top=this._originalPosition.top+"px"},showParticipantInfo:function(t,e){sap.ui.core.BusyIndicator.show(0);var i=this.getOwnerComponent().getModel("SFactors");if(!this._participantInfoView){this._participantInfoView=sap.ui.xmlfragment("cba.hr.sdvCalibracaoSF.view.fragment.ParticipantInfo",this);this._participantInfoView.setModel(i);this.getView().addDependent(this._participantInfoView)}if(this._participantInfoView){this.dialogBusyStart(4);this.setParticipantInfoHeader(e,i);this.setParticipantInfoExpectativa(t,i);this.setParticipantInfoComentario(t,i);this.setParticipantInfoMetas(t,i);this._participantId=t}},dialogBusyStart:function(t){this._participantInfoView.setBusy(true);this._dialogBusyCounter=t},dialogBusyEnd:function(t){this._dialogBusyCounter--;if(!this._dialogBusyCounter){this._participantInfoView.setBusy(false);sap.ui.core.BusyIndicator.hide();if(t){this._participantInfoView.open()}}},setParticipantInfoHeader:function(t,e){var i=sap.ui.getCore().byId("participantInfoHeaderImage");var a=sap.ui.getCore().byId("participantInfoHeaderNome");var r=sap.ui.getCore().byId("participantInfoHeaderCargo");var o=sap.ui.getCore().byId("participantInfoHeaderIdade");var n=sap.ui.getCore().byId("participantInfoHeaderTempoServico");a.setText(t.defaultFullName);r.setText(t.jobCode);t.age=t.age+" "+this.getI18nText("ParticipantInfoYears");o.setText(t.age);if(t.jobYears>1){t.jobYears=t.jobYears+" "+this.getI18nText("ParticipantInfoYears")}else{t.jobYears=t.jobYears+" "+this.getI18nText("ParticipantInfoYear")}n.setText(t.jobYears);this.setParticipantPicture(t.userId,i,e)},setParticipantPicture:function(t,e,i){var a=this;i.read("/Photo(photoType=1,userId='"+t+"')",{success:function(t){var i="data:"+t.mimeType+";base64,"+t.photo;e.setSrc(i);e.setWidth("100px");a.dialogBusyEnd(true)},error:function(){a.dialogBusyEnd(true)}})},setParticipantInfoExpectativa:function(t,e){var i=this;var a=sap.ui.getCore().byId("participantInfoExpectativa");e.read("/BackgroundFutureAspirations('"+t+"')",{success:function(t){try{var e=t.description}catch(t){e=i.getI18nText("ParticipantInfoTextNotFound")}a.setText(e);i.dialogBusyEnd(true)},error:function(){a.setText(i.getI18nText("ParticipantInfoTextNotFound"));i.dialogBusyEnd(true)}})},setParticipantInfoComentario:function(t,e){var i=this;var a=sap.ui.getCore().byId("participantInfoComentario");e.read("/BackgroundComments('"+t+"')",{success:function(t){try{var e=t.results_relevants}catch(t){e=i.getI18nText("ParticipantInfoTextNotFound")}e=e?e:i.getI18nText("ParticipantInfoTextNotFound");a.setText(e);i.dialogBusyEnd(true)},error:function(){a.setText(i.getI18nText("ParticipantInfoTextNotFound"));i.dialogBusyEnd(true)}})},setParticipantInfoMetas:function(t,e){var i=this;var a=sap.ui.getCore().byId("participantInfoMetas");var r=[];r.push(new sap.ui.model.Filter("userId","EQ",t));e.read("/BackgroundGoalsHistory",{filters:r,success:function(t){var e="";try{var r=t.results;for(var o=0;o<r.length;o++){if(o>0){e+="\n\n"}e+=r[o].ano;e+=" - "+r[o].meta+"\n";e+="Atingimento (pontuação): "+r[o].achievement;e+="\nMeta individual: "+r[o].goal}}catch(t){e=i.getI18nText("ParticipantInfoTextNotFound")}e=e?e:i.getI18nText("ParticipantInfoTextNotFound");a.setText(e);i.dialogBusyEnd(true)},error:function(){a.setText(i.getI18nText("ParticipantInfoTextNotFound"));i.dialogBusyEnd(true)}})},addParticipant:function(t,e,i,a){var r=this;var o=$("#"+this.createUniqueId(t));var n;var s;try{s=e.shift();this.setParticipantPosition(o,s)}catch(e){var c=this._calibrationRoomParticipants.getItems();for(l=0;l<c.length;l++){var u=c[l];if(u.getId()===this.createUniqueId(t)){this._calibrationRoomParticipants.removeItem(l);this._calibrationRoomParticipantsPending.addItem(u);o=$("#"+this.createUniqueId(t));o.css("position","relative");o.css("color","#000")}}}finally{o.css("visibility","visible");if(a){o.css("color","#4CC417")}o.draggable({drag:function(t,e){$(this).css("z-index",5);if(!r._originalPosition){r._originalPosition=e.position}}})}for(var l=0;l<i.length;l++){n=i[l];if(n.userId===t){o.on("click",function(){r.showParticipantInfo(t,n)});break}}},setParticipantPosition:function(t,e){t.css("left",e.left);t.css("top",e.top)},getAvaliablePosition:function(){var t={EMBAB:this.getEmbAbPositions(525,150),EMBDE:this.getEmbDePositions(220,400),EMBAC:this.getEmbAcPositions(525,930),TEMAB:this.getTemAbPositions(525,265),TEMDE:this.getTemDePositions(320,470),TEMAC:this.getTemAcPositions(525,810),SEMAB:this.getSemAlPositions(525,410),SEMDE:this.getSemAlPositions(495,540),SEMAC:this.getSemAlPositions(525,660)};return t},getEmbAbPositions:function(t,e){var i=[];for(var a=1;a<=6;a++){i.push({top:t-=12,left:e+=1})}for(var a=7;a<=20;a++){i.push({top:t-=12,left:e+=5})}for(a=21;a<=27;a++){i.push({top:t-=12,left:e+=9})}for(var a=28;a<=30;a++){i.push({top:t=12,left:e})}return i},getTemAbPositions:function(t,e){var i=[];for(var a=1;a<=8;a++){i.push({top:t-=12,left:e+=1})}for(var a=9;a<=22;a++){i.push({top:t-=12,left:e+=6})}return i},getEmbDePositions:function(t,e){var i=[];var a=t;for(var r=1;r<=8;r++){i.push({top:t-=12,left:e-=5})}e+=170;t=a-30;for(r=9;r<=17;r++){i.push({top:t-=12,left:e})}e+=150;t=a;for(var r=18;r<=25;r++){i.push({top:t-=12,left:e+=5})}return i},getTemDePositions:function(t,e){var i=[];var a=t;var r=e;for(var o=1;o<=8;o++){i.push({top:t-=12,left:e-=5})}t=a;e=r+150;for(var o=9;o<=16;o++){i.push({top:t-=12,left:e+=5})}t=a-70;e=r+75;for(var o=17;o<=21;o++){i.push({top:t-=12,left:e})}return i},getEmbAcPositions:function(t,e){var i=[];for(var a=1;a<=6;a++){i.push({top:t-=12,left:e-=1})}for(var a=7;a<=20;a++){i.push({top:t-=12,left:e-=5})}for(a=21;a<=27;a++){i.push({top:t-=12,left:e-=9})}for(var a=28;a<=30;a++){i.push({top:t-=12,left:e})}return i},getTemAcPositions:function(t,e){var i=[];for(var a=1;a<=8;a++){i.push({top:t-=12,left:e-=1})}for(var a=9;a<=22;a++){i.push({top:t-=12,left:e-=6})}return i},getSemAlPositions:function(t,e){var i=[];for(var a=1;a<=13;a++){i.push({top:t-=12,left:e})}return i},createUniqueId:function(t){return"SAP"+this._uniqueId+t},getUniqueId:function(t){return t.replace("SAP"+this._uniqueId,"").trim()},backHome:function(){var t=sap.ui.core.UIComponent.getRouterFor(this);t.navTo("TargetCalibrationSessions")},onCloseParticipantInfo:function(){if(this._participantInfoView){this._participantInfoView.close();this._participantInfoView.destroy();this._participantInfoView=undefined;this._participantId=undefined}}})});